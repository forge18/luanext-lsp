<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","forge18","Repos","typedlua-lsp","src","analysis","mod.rs"],"content":"//! Analysis and type-checking related functionality\n\npub mod symbol_index;\n\npub use symbol_index::{ExportInfo, ImportInfo, SymbolIndex, WorkspaceSymbolInfo};\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","analysis","symbol_index.rs"],"content":"use lsp_types::{SymbolInformation, SymbolKind, Uri};\nuse std::collections::{HashMap, HashSet};\nuse typedlua_parser::ast::statement::{ExportKind, ImportClause, OperatorKind, Statement};\nuse typedlua_parser::ast::Program;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::Span;\n\n/// Information about an exported symbol\n#[derive(Debug, Clone)]\n#[allow(dead_code)] // Public API - fields may be used by external consumers\npub struct ExportInfo {\n    /// The exported name (what other modules see)\n    pub exported_name: String,\n    /// The local name in the exporting module (may differ from exported_name)\n    pub local_name: String,\n    /// URI of the module that exports this symbol\n    pub uri: Uri,\n    /// Whether this is a default export\n    pub is_default: bool,\n}\n\n/// Information about an imported symbol\n#[derive(Debug, Clone)]\n#[allow(dead_code)] // Public API - fields may be used by external consumers\npub struct ImportInfo {\n    /// The local name in the importing module\n    pub local_name: String,\n    /// The imported name from the source module\n    pub imported_name: String,\n    /// URI of the source module\n    pub source_uri: Uri,\n    /// URI of the module that imports this symbol\n    pub importing_uri: Uri,\n}\n\n/// Information about a workspace symbol (for workspace-wide search)\n#[derive(Debug, Clone)]\npub struct WorkspaceSymbolInfo {\n    /// The symbol name\n    pub name: String,\n    /// The symbol kind (class, function, interface, etc.)\n    pub kind: SymbolKind,\n    /// URI of the file containing this symbol\n    pub uri: Uri,\n    /// Location of the symbol in the file\n    pub span: Span,\n    /// Container name (e.g., class name for a method)\n    pub container_name: Option\u003cString\u003e,\n}\n\n/// Reverse index for fast cross-file symbol lookups\n///\n/// This index maintains bidirectional mappings between:\n/// - Symbols and the modules that export them\n/// - Symbols and the modules that import them\n/// - All workspace symbols for global search\n///\n/// This enables fast queries like:\n/// - \"Which files import symbol X from module Y?\"\n/// - \"What symbols does module Z export?\"\n/// - \"Where is symbol W imported from?\"\n/// - \"Find all symbols matching query Q in the workspace\"\n#[derive(Debug, Default)]\npub struct SymbolIndex {\n    /// Map from (module_id, exported_symbol_name) -\u003e ExportInfo\n    exports: HashMap\u003c(String, String), ExportInfo\u003e,\n\n    /// Map from (module_id, local_symbol_name) -\u003e Vec\u003cImportInfo\u003e\n    /// Multiple imports because a symbol might be imported from different modules with different names\n    imports: HashMap\u003c(String, String), Vec\u003cImportInfo\u003e\u003e,\n\n    /// Reverse index: Map from exported (source_module_id, exported_name) -\u003e Set of importing URIs\n    /// This answers: \"Which files import this symbol?\"\n    importers: HashMap\u003c(String, String), HashSet\u003cUri\u003e\u003e,\n\n    /// Map from URI to module_id (String) for quick lookups\n    uri_to_module: HashMap\u003cUri, String\u003e,\n\n    /// Workspace-wide symbol index: Map from lowercase symbol name -\u003e Vec\u003cWorkspaceSymbolInfo\u003e\n    /// Lowercase keys enable case-insensitive fuzzy matching\n    workspace_symbols: HashMap\u003cString, Vec\u003cWorkspaceSymbolInfo\u003e\u003e,\n}\n\nimpl SymbolIndex {\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Update the index for a specific document\n    ///\n    /// This should be called whenever a document is opened, changed, or saved.\n    pub fn update_document(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        ast: \u0026Program,\n        interner: \u0026StringInterner,\n        resolve_import: impl Fn(\u0026str, \u0026str) -\u003e Option\u003c(String, Uri)\u003e,\n    ) {\n        // Clear old entries for this document\n        self.clear_document(uri, module_id);\n\n        // Register URI -\u003e module_id mapping\n        self.uri_to_module\n            .insert(uri.clone(), module_id.to_string());\n\n        // Index exports\n        self.index_exports(uri, module_id, \u0026ast.statements, interner);\n\n        // Index imports\n        self.index_imports(uri, module_id, \u0026ast.statements, interner, resolve_import);\n\n        // Index workspace symbols\n        self.index_workspace_symbols(uri, \u0026ast.statements, interner);\n    }\n\n    /// Clear index entries for a document\n    pub fn clear_document(\u0026mut self, uri: \u0026Uri, module_id: \u0026str) {\n        // Remove exports\n        self.exports.retain(|(mid, _), _| mid != module_id);\n\n        // Remove imports\n        self.imports.retain(|(mid, _), _| mid != module_id);\n\n        // Remove from importers\n        for importing_set in self.importers.values_mut() {\n            importing_set.remove(uri);\n        }\n\n        // Remove workspace symbols from this URI\n        for symbol_list in self.workspace_symbols.values_mut() {\n            symbol_list.retain(|sym| \u0026sym.uri != uri);\n        }\n        // Clean up empty entries\n        self.workspace_symbols.retain(|_, list| !list.is_empty());\n\n        // Remove URI mapping\n        self.uri_to_module.remove(uri);\n    }\n\n    /// Index all exports in a module\n    fn index_exports(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            if let Statement::Export(export_decl) = stmt {\n                match \u0026export_decl.kind {\n                    ExportKind::Declaration(decl) =\u003e {\n                        if let Some((local_name, exported_name)) =\n                            Self::get_declaration_export_name(decl, interner)\n                        {\n                            let export_info = ExportInfo {\n                                exported_name: exported_name.clone(),\n                                local_name,\n                                uri: uri.clone(),\n                                is_default: false,\n                            };\n                            self.exports\n                                .insert((module_id.to_string(), exported_name), export_info);\n                        }\n                    }\n                    ExportKind::Named {\n                        specifiers,\n                        source: _,\n                    } =\u003e {\n                        for spec in specifiers {\n                            let local_name = interner.resolve(spec.local.node);\n                            let exported_name = spec\n                                .exported\n                                .as_ref()\n                                .map(|e| interner.resolve(e.node))\n                                .unwrap_or_else(|| local_name.clone());\n\n                            let export_info = ExportInfo {\n                                exported_name: exported_name.clone(),\n                                local_name,\n                                uri: uri.clone(),\n                                is_default: false,\n                            };\n                            self.exports\n                                .insert((module_id.to_string(), exported_name), export_info);\n                        }\n                    }\n                    ExportKind::Default(_) =\u003e {\n                        let export_info = ExportInfo {\n                            exported_name: \"default\".to_string(),\n                            local_name: \"default\".to_string(),\n                            uri: uri.clone(),\n                            is_default: true,\n                        };\n                        self.exports\n                            .insert((module_id.to_string(), \"default\".to_string()), export_info);\n                    }\n                }\n            }\n        }\n    }\n\n    /// Index all imports in a module\n    fn index_imports(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n        resolve_import: impl Fn(\u0026str, \u0026str) -\u003e Option\u003c(String, Uri)\u003e,\n    ) {\n        for stmt in statements {\n            if let Statement::Import(import_decl) = stmt {\n                let import_source = \u0026import_decl.source;\n\n                // Resolve the import path to get source module ID and URI\n                if let Some((source_module_id, source_uri)) =\n                    resolve_import(import_source, module_id)\n                {\n                    match \u0026import_decl.clause {\n                        ImportClause::Named(specs) =\u003e {\n                            for spec in specs {\n                                let imported_name = interner.resolve(spec.imported.node);\n                                let local_name = spec\n                                    .local\n                                    .as_ref()\n                                    .map(|l| interner.resolve(l.node))\n                                    .unwrap_or_else(|| imported_name.clone());\n\n                                let import_info = ImportInfo {\n                                    local_name: local_name.clone(),\n                                    imported_name: imported_name.clone(),\n                                    source_uri: source_uri.clone(),\n                                    importing_uri: uri.clone(),\n                                };\n\n                                // Add to imports index\n                                self.imports\n                                    .entry((module_id.to_string(), local_name))\n                                    .or_insert_with(Vec::new)\n                                    .push(import_info);\n\n                                // Add to importers reverse index\n                                self.importers\n                                    .entry((source_module_id.clone(), imported_name))\n                                    .or_insert_with(HashSet::new)\n                                    .insert(uri.clone());\n                            }\n                        }\n                        ImportClause::Default(ident) =\u003e {\n                            let local_name = interner.resolve(ident.node);\n                            let import_info = ImportInfo {\n                                local_name: local_name.clone(),\n                                imported_name: \"default\".to_string(),\n                                source_uri: source_uri.clone(),\n                                importing_uri: uri.clone(),\n                            };\n\n                            self.imports\n                                .entry((module_id.to_string(), local_name))\n                                .or_insert_with(Vec::new)\n                                .push(import_info);\n\n                            self.importers\n                                .entry((source_module_id.clone(), \"default\".to_string()))\n                                .or_insert_with(HashSet::new)\n                                .insert(uri.clone());\n                        }\n                        ImportClause::Namespace(_ident) =\u003e {\n                            // Namespace imports are complex, skip for now\n                        }\n                        ImportClause::TypeOnly(_) =\u003e {\n                            // Type-only imports could be handled similarly to Named\n                        }\n                        ImportClause::Mixed { default, named } =\u003e {\n                            // Handle default import\n                            let local_name = interner.resolve(default.node);\n                            let import_info = ImportInfo {\n                                local_name: local_name.clone(),\n                                imported_name: \"default\".to_string(),\n                                source_uri: source_uri.clone(),\n                                importing_uri: uri.clone(),\n                            };\n\n                            self.imports\n                                .entry((module_id.to_string(), local_name))\n                                .or_insert_with(Vec::new)\n                                .push(import_info);\n\n                            self.importers\n                                .entry((source_module_id.clone(), \"default\".to_string()))\n                                .or_insert_with(HashSet::new)\n                                .insert(uri.clone());\n\n                            // Handle named imports\n                            for spec in named {\n                                let imported_name = interner.resolve(spec.imported.node);\n                                let local_name = spec\n                                    .local\n                                    .as_ref()\n                                    .map(|l| interner.resolve(l.node))\n                                    .unwrap_or_else(|| imported_name.clone());\n\n                                let import_info = ImportInfo {\n                                    local_name: local_name.clone(),\n                                    imported_name: imported_name.clone(),\n                                    source_uri: source_uri.clone(),\n                                    importing_uri: uri.clone(),\n                                };\n\n                                self.imports\n                                    .entry((module_id.to_string(), local_name))\n                                    .or_insert_with(Vec::new)\n                                    .push(import_info);\n\n                                self.importers\n                                    .entry((source_module_id.clone(), imported_name))\n                                    .or_insert_with(HashSet::new)\n                                    .insert(uri.clone());\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /// Index all workspace symbols in a module\n    fn index_workspace_symbols(\n        \u0026mut self,\n        uri: \u0026Uri,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            self.index_statement_symbols(uri, stmt, None, interner);\n        }\n    }\n\n    /// Recursively index symbols from a statement\n    fn index_statement_symbols(\n        \u0026mut self,\n        uri: \u0026Uri,\n        stmt: \u0026Statement,\n        container_name: Option\u003cString\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        use typedlua_parser::ast::pattern::Pattern;\n        use typedlua_parser::ast::statement::ClassMember;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let name = interner.resolve(ident.node);\n                    let symbol = WorkspaceSymbolInfo {\n                        name: name.clone(),\n                        kind: SymbolKind::VARIABLE,\n                        uri: uri.clone(),\n                        span: ident.span.clone(),\n                        container_name: container_name.clone(),\n                    };\n                    self.workspace_symbols\n                        .entry(name.to_lowercase())\n                        .or_insert_with(Vec::new)\n                        .push(symbol);\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                let name = interner.resolve(func_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::FUNCTION,\n                    uri: uri.clone(),\n                    span: func_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::Class(class_decl) =\u003e {\n                let class_name = interner.resolve(class_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: class_name.clone(),\n                    kind: SymbolKind::CLASS,\n                    uri: uri.clone(),\n                    span: class_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(class_name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n\n                // Index class members\n                for member in \u0026class_decl.members {\n                    match member {\n                        ClassMember::Property(prop) =\u003e {\n                            let name = interner.resolve(prop.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: prop.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Method(method) =\u003e {\n                            let name = interner.resolve(method.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::METHOD,\n                                uri: uri.clone(),\n                                span: method.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Constructor(ctor) =\u003e {\n                            let symbol = WorkspaceSymbolInfo {\n                                name: \"constructor\".to_string(),\n                                kind: SymbolKind::CONSTRUCTOR,\n                                uri: uri.clone(),\n                                span: ctor.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(\"constructor\".to_string())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Getter(getter) =\u003e {\n                            let name = interner.resolve(getter.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: getter.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Setter(setter) =\u003e {\n                            let name = interner.resolve(setter.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: setter.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Operator(op) =\u003e {\n                            let op_symbol = match op.operator {\n                                OperatorKind::Add =\u003e \"+\",\n                                OperatorKind::Subtract =\u003e \"-\",\n                                OperatorKind::Multiply =\u003e \"*\",\n                                OperatorKind::Divide =\u003e \"/\",\n                                OperatorKind::Modulo =\u003e \"%\",\n                                OperatorKind::Power =\u003e \"^\",\n                                OperatorKind::Equal =\u003e \"==\",\n                                OperatorKind::NotEqual =\u003e \"~=\",\n                                OperatorKind::LessThan =\u003e \"\u003c\",\n                                OperatorKind::LessThanOrEqual =\u003e \"\u003c=\",\n                                OperatorKind::GreaterThan =\u003e \"\u003e\",\n                                OperatorKind::GreaterThanOrEqual =\u003e \"\u003e=\",\n                                OperatorKind::Concatenate =\u003e \"..\",\n                                OperatorKind::Length =\u003e \"#\",\n                                OperatorKind::Index =\u003e \"[]\",\n                                OperatorKind::NewIndex =\u003e \"[]=\",\n                                OperatorKind::Call =\u003e \"()\",\n                                OperatorKind::UnaryMinus =\u003e \"unm\",\n                                OperatorKind::FloorDivide =\u003e \"//\",\n                                OperatorKind::BitwiseAnd =\u003e \"\u0026\",\n                                OperatorKind::BitwiseOr =\u003e \"|\",\n                                OperatorKind::BitwiseXor =\u003e \"~\",\n                                OperatorKind::ShiftLeft =\u003e \"\u003c\u003c\",\n                                OperatorKind::ShiftRight =\u003e \"\u003e\u003e\",\n                            };\n                            let name = format!(\"operator {}\", op_symbol);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::OPERATOR,\n                                uri: uri.clone(),\n                                span: op.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                    }\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                let name = interner.resolve(interface_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::INTERFACE,\n                    uri: uri.clone(),\n                    span: interface_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                let name = interner.resolve(type_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::TYPE_PARAMETER,\n                    uri: uri.clone(),\n                    span: type_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                let name = interner.resolve(enum_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::ENUM,\n                    uri: uri.clone(),\n                    span: enum_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Get export information for a symbol\n    #[allow(dead_code)] // Used in tests for symbol index validation\n    pub fn get_export(\u0026self, module_id: \u0026str, symbol_name: \u0026str) -\u003e Option\u003c\u0026ExportInfo\u003e {\n        self.exports\n            .get(\u0026(module_id.to_string(), symbol_name.to_string()))\n    }\n\n    /// Get all files that import a specific symbol from a module\n    pub fn get_importers(\u0026self, module_id: \u0026str, symbol_name: \u0026str) -\u003e Vec\u003cUri\u003e {\n        self.importers\n            .get(\u0026(module_id.to_string(), symbol_name.to_string()))\n            .map(|set| set.iter().cloned().collect())\n            .unwrap_or_default()\n    }\n\n    /// Get import information for a local symbol in a module\n    pub fn get_imports(\u0026self, module_id: \u0026str, local_name: \u0026str) -\u003e Option\u003c\u0026Vec\u003cImportInfo\u003e\u003e {\n        self.imports\n            .get(\u0026(module_id.to_string(), local_name.to_string()))\n    }\n\n    /// Search workspace symbols by query string\n    ///\n    /// Performs case-insensitive fuzzy matching on symbol names.\n    /// Returns symbols sorted by relevance (exact matches first, then prefix matches, then contains).\n    pub fn search_workspace_symbols(\u0026self, query: \u0026str) -\u003e Vec\u003cSymbolInformation\u003e {\n        if query.is_empty() {\n            // Return all symbols (limited to avoid overwhelming the client)\n            return self\n                .workspace_symbols\n                .values()\n                .flat_map(|symbols| symbols.iter())\n                .take(100)\n                .map(|symbol_info| self.workspace_symbol_to_lsp(symbol_info))\n                .collect();\n        }\n\n        let query_lower = query.to_lowercase();\n        let mut results = Vec::new();\n\n        // Collect matching symbols with scoring\n        for (name_lower, symbols) in \u0026self.workspace_symbols {\n            let score = if name_lower == \u0026query_lower {\n                3 // Exact match\n            } else if name_lower.starts_with(\u0026query_lower) {\n                2 // Prefix match\n            } else if name_lower.contains(\u0026query_lower) {\n                1 // Contains match\n            } else {\n                0 // No match\n            };\n\n            if score \u003e 0 {\n                for symbol_info in symbols {\n                    results.push((score, symbol_info));\n                }\n            }\n        }\n\n        // Sort by score (descending) and convert to SymbolInformation\n        results.sort_by(|(score_a, sym_a), (score_b, sym_b)| {\n            score_b\n                .cmp(score_a)\n                .then_with(|| sym_a.name.cmp(\u0026sym_b.name))\n        });\n\n        results\n            .into_iter()\n            .take(100) // Limit results\n            .map(|(_, symbol_info)| self.workspace_symbol_to_lsp(symbol_info))\n            .collect()\n    }\n\n    /// Convert WorkspaceSymbolInfo to LSP SymbolInformation\n    fn workspace_symbol_to_lsp(\u0026self, symbol: \u0026WorkspaceSymbolInfo) -\u003e SymbolInformation {\n        use lsp_types::{Location, Position, Range};\n\n        #[allow(deprecated)] // SymbolInformation uses deprecated fields\n        SymbolInformation {\n            name: symbol.name.clone(),\n            kind: symbol.kind,\n            tags: None,\n            deprecated: None,\n            location: Location {\n                uri: symbol.uri.clone(),\n                range: Range {\n                    start: Position {\n                        line: (symbol.span.line.saturating_sub(1)) as u32,\n                        character: (symbol.span.column.saturating_sub(1)) as u32,\n                    },\n                    end: Position {\n                        line: (symbol.span.line.saturating_sub(1)) as u32,\n                        character: ((symbol.span.column + symbol.span.len()).saturating_sub(1))\n                            as u32,\n                    },\n                },\n            },\n            container_name: symbol.container_name.clone(),\n        }\n    }\n\n    /// Helper to extract export name from a declaration\n    fn get_declaration_export_name(\n        stmt: \u0026Statement,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003c(String, String)\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let name = interner.resolve(ident.node);\n                    Some((name.clone(), name))\n                } else {\n                    None\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                let name = interner.resolve(func_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Class(class_decl) =\u003e {\n                let name = interner.resolve(class_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                let name = interner.resolve(interface_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                let name = interner.resolve(type_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                let name = interner.resolve(enum_decl.name.node);\n                Some((name.clone(), name))\n            }\n            _ =\u003e None,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::str::FromStr;\n\n    fn make_uri(path: \u0026str) -\u003e Uri {\n        Uri::from_str(\u0026format!(\"file://{}\", path)).unwrap()\n    }\n\n    #[test]\n    fn test_symbol_index_basic() {\n        let index = SymbolIndex::new();\n\n        let _uri = make_uri(\"/test/module.tl\");\n        let module_id = \"/test/module.tl\";\n\n        // Test that index starts empty\n        assert!(index.get_export(module_id, \"foo\").is_none());\n        assert!(index.get_importers(module_id, \"foo\").is_empty());\n    }\n\n    #[test]\n    fn test_export_indexing() {\n        // This would require parsing actual TypedLua code\n        // Skipping for now as it requires full parser setup\n    }\n\n    #[test]\n    fn test_import_indexing() {\n        // This would require parsing actual TypedLua code\n        // Skipping for now as it requires full parser setup\n    }\n}\n","traces":[{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":1}},{"line":560,"address":[],"length":0,"stats":{"Line":1}},{"line":561,"address":[],"length":0,"stats":{"Line":4}},{"line":565,"address":[],"length":0,"stats":{"Line":1}},{"line":566,"address":[],"length":0,"stats":{"Line":1}},{"line":567,"address":[],"length":0,"stats":{"Line":4}},{"line":568,"address":[],"length":0,"stats":{"Line":1}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}}],"covered":9,"coverable":339},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","core","analysis","mod.rs"],"content":"//! Analysis and type-checking related functionality\n\npub mod symbol_index;\n\npub use symbol_index::SymbolIndex;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","core","analysis","symbol_index.rs"],"content":"use lsp_types::{SymbolInformation, SymbolKind, Uri};\nuse std::collections::{HashMap, HashSet};\nuse typedlua_parser::ast::statement::{ExportKind, ImportClause, OperatorKind, Statement};\nuse typedlua_parser::ast::Program;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::Span;\n\n/// Information about an exported symbol\n#[derive(Debug, Clone)]\n#[allow(dead_code)] // Public API - fields may be used by external consumers\npub struct ExportInfo {\n    /// The exported name (what other modules see)\n    pub exported_name: String,\n    /// The local name in the exporting module (may differ from exported_name)\n    pub local_name: String,\n    /// URI of the module that exports this symbol\n    pub uri: Uri,\n    /// Whether this is a default export\n    pub is_default: bool,\n}\n\n/// Information about an imported symbol\n#[derive(Debug, Clone)]\n#[allow(dead_code)] // Public API - fields may be used by external consumers\npub struct ImportInfo {\n    /// The local name in the importing module\n    pub local_name: String,\n    /// The imported name from the source module\n    pub imported_name: String,\n    /// URI of the source module\n    pub source_uri: Uri,\n    /// URI of the module that imports this symbol\n    pub importing_uri: Uri,\n}\n\n/// Information about a workspace symbol (for workspace-wide search)\n#[derive(Debug, Clone)]\npub struct WorkspaceSymbolInfo {\n    /// The symbol name\n    pub name: String,\n    /// The symbol kind (class, function, interface, etc.)\n    pub kind: SymbolKind,\n    /// URI of the file containing this symbol\n    pub uri: Uri,\n    /// Location of the symbol in the file\n    pub span: Span,\n    /// Container name (e.g., class name for a method)\n    pub container_name: Option\u003cString\u003e,\n}\n\n/// Reverse index for fast cross-file symbol lookups\n///\n/// This index maintains bidirectional mappings between:\n/// - Symbols and the modules that export them\n/// - Symbols and the modules that import them\n/// - All workspace symbols for global search\n///\n/// This enables fast queries like:\n/// - \"Which files import symbol X from module Y?\"\n/// - \"What symbols does module Z export?\"\n/// - \"Where is symbol W imported from?\"\n/// - \"Find all symbols matching query Q in the workspace\"\n#[derive(Debug, Default)]\npub struct SymbolIndex {\n    /// Map from (module_id, exported_symbol_name) -\u003e ExportInfo\n    exports: HashMap\u003c(String, String), ExportInfo\u003e,\n\n    /// Map from (module_id, local_symbol_name) -\u003e Vec\u003cImportInfo\u003e\n    /// Multiple imports because a symbol might be imported from different modules with different names\n    imports: HashMap\u003c(String, String), Vec\u003cImportInfo\u003e\u003e,\n\n    /// Reverse index: Map from exported (source_module_id, exported_name) -\u003e Set of importing URIs\n    /// This answers: \"Which files import this symbol?\"\n    importers: HashMap\u003c(String, String), HashSet\u003cUri\u003e\u003e,\n\n    /// Map from URI to module_id (String) for quick lookups\n    uri_to_module: HashMap\u003cUri, String\u003e,\n\n    /// Workspace-wide symbol index: Map from lowercase symbol name -\u003e Vec\u003cWorkspaceSymbolInfo\u003e\n    /// Lowercase keys enable case-insensitive fuzzy matching\n    workspace_symbols: HashMap\u003cString, Vec\u003cWorkspaceSymbolInfo\u003e\u003e,\n}\n\nimpl SymbolIndex {\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Update the index for a specific document\n    ///\n    /// This should be called whenever a document is opened, changed, or saved.\n    pub fn update_document(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        ast: \u0026Program,\n        interner: \u0026StringInterner,\n        resolve_import: impl Fn(\u0026str, \u0026str) -\u003e Option\u003c(String, Uri)\u003e,\n    ) {\n        // Clear old entries for this document\n        self.clear_document(uri, module_id);\n\n        // Register URI -\u003e module_id mapping\n        self.uri_to_module\n            .insert(uri.clone(), module_id.to_string());\n\n        // Index exports\n        self.index_exports(uri, module_id, \u0026ast.statements, interner);\n\n        // Index imports\n        self.index_imports(uri, module_id, \u0026ast.statements, interner, resolve_import);\n\n        // Index workspace symbols\n        self.index_workspace_symbols(uri, \u0026ast.statements, interner);\n    }\n\n    /// Clear index entries for a document\n    pub fn clear_document(\u0026mut self, uri: \u0026Uri, module_id: \u0026str) {\n        // Remove exports\n        self.exports.retain(|(mid, _), _| mid != module_id);\n\n        // Remove imports\n        self.imports.retain(|(mid, _), _| mid != module_id);\n\n        // Remove from importers\n        for importing_set in self.importers.values_mut() {\n            importing_set.remove(uri);\n        }\n\n        // Remove workspace symbols from this URI\n        for symbol_list in self.workspace_symbols.values_mut() {\n            symbol_list.retain(|sym| \u0026sym.uri != uri);\n        }\n        // Clean up empty entries\n        self.workspace_symbols.retain(|_, list| !list.is_empty());\n\n        // Remove URI mapping\n        self.uri_to_module.remove(uri);\n    }\n\n    /// Index all exports in a module\n    fn index_exports(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            if let Statement::Export(export_decl) = stmt {\n                match \u0026export_decl.kind {\n                    ExportKind::Declaration(decl) =\u003e {\n                        if let Some((local_name, exported_name)) =\n                            Self::get_declaration_export_name(decl, interner)\n                        {\n                            let export_info = ExportInfo {\n                                exported_name: exported_name.clone(),\n                                local_name,\n                                uri: uri.clone(),\n                                is_default: false,\n                            };\n                            self.exports\n                                .insert((module_id.to_string(), exported_name), export_info);\n                        }\n                    }\n                    ExportKind::Named {\n                        specifiers,\n                        source: _,\n                    } =\u003e {\n                        for spec in specifiers {\n                            let local_name = interner.resolve(spec.local.node);\n                            let exported_name = spec\n                                .exported\n                                .as_ref()\n                                .map(|e| interner.resolve(e.node))\n                                .unwrap_or_else(|| local_name.clone());\n\n                            let export_info = ExportInfo {\n                                exported_name: exported_name.clone(),\n                                local_name,\n                                uri: uri.clone(),\n                                is_default: false,\n                            };\n                            self.exports\n                                .insert((module_id.to_string(), exported_name), export_info);\n                        }\n                    }\n                    ExportKind::Default(_) =\u003e {\n                        let export_info = ExportInfo {\n                            exported_name: \"default\".to_string(),\n                            local_name: \"default\".to_string(),\n                            uri: uri.clone(),\n                            is_default: true,\n                        };\n                        self.exports\n                            .insert((module_id.to_string(), \"default\".to_string()), export_info);\n                    }\n                }\n            }\n        }\n    }\n\n    /// Index all imports in a module\n    fn index_imports(\n        \u0026mut self,\n        uri: \u0026Uri,\n        module_id: \u0026str,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n        resolve_import: impl Fn(\u0026str, \u0026str) -\u003e Option\u003c(String, Uri)\u003e,\n    ) {\n        for stmt in statements {\n            if let Statement::Import(import_decl) = stmt {\n                let import_source = \u0026import_decl.source;\n\n                // Resolve the import path to get source module ID and URI\n                if let Some((source_module_id, source_uri)) =\n                    resolve_import(import_source, module_id)\n                {\n                    match \u0026import_decl.clause {\n                        ImportClause::Named(specs) =\u003e {\n                            for spec in specs {\n                                let imported_name = interner.resolve(spec.imported.node);\n                                let local_name = spec\n                                    .local\n                                    .as_ref()\n                                    .map(|l| interner.resolve(l.node))\n                                    .unwrap_or_else(|| imported_name.clone());\n\n                                let import_info = ImportInfo {\n                                    local_name: local_name.clone(),\n                                    imported_name: imported_name.clone(),\n                                    source_uri: source_uri.clone(),\n                                    importing_uri: uri.clone(),\n                                };\n\n                                // Add to imports index\n                                self.imports\n                                    .entry((module_id.to_string(), local_name))\n                                    .or_insert_with(Vec::new)\n                                    .push(import_info);\n\n                                // Add to importers reverse index\n                                self.importers\n                                    .entry((source_module_id.clone(), imported_name))\n                                    .or_insert_with(HashSet::new)\n                                    .insert(uri.clone());\n                            }\n                        }\n                        ImportClause::Default(ident) =\u003e {\n                            let local_name = interner.resolve(ident.node);\n                            let import_info = ImportInfo {\n                                local_name: local_name.clone(),\n                                imported_name: \"default\".to_string(),\n                                source_uri: source_uri.clone(),\n                                importing_uri: uri.clone(),\n                            };\n\n                            self.imports\n                                .entry((module_id.to_string(), local_name))\n                                .or_insert_with(Vec::new)\n                                .push(import_info);\n\n                            self.importers\n                                .entry((source_module_id.clone(), \"default\".to_string()))\n                                .or_insert_with(HashSet::new)\n                                .insert(uri.clone());\n                        }\n                        ImportClause::Namespace(_ident) =\u003e {\n                            // Namespace imports are complex, skip for now\n                        }\n                        ImportClause::TypeOnly(_) =\u003e {\n                            // Type-only imports could be handled similarly to Named\n                        }\n                        ImportClause::Mixed { default, named } =\u003e {\n                            // Handle default import\n                            let local_name = interner.resolve(default.node);\n                            let import_info = ImportInfo {\n                                local_name: local_name.clone(),\n                                imported_name: \"default\".to_string(),\n                                source_uri: source_uri.clone(),\n                                importing_uri: uri.clone(),\n                            };\n\n                            self.imports\n                                .entry((module_id.to_string(), local_name))\n                                .or_insert_with(Vec::new)\n                                .push(import_info);\n\n                            self.importers\n                                .entry((source_module_id.clone(), \"default\".to_string()))\n                                .or_insert_with(HashSet::new)\n                                .insert(uri.clone());\n\n                            // Handle named imports\n                            for spec in named {\n                                let imported_name = interner.resolve(spec.imported.node);\n                                let local_name = spec\n                                    .local\n                                    .as_ref()\n                                    .map(|l| interner.resolve(l.node))\n                                    .unwrap_or_else(|| imported_name.clone());\n\n                                let import_info = ImportInfo {\n                                    local_name: local_name.clone(),\n                                    imported_name: imported_name.clone(),\n                                    source_uri: source_uri.clone(),\n                                    importing_uri: uri.clone(),\n                                };\n\n                                self.imports\n                                    .entry((module_id.to_string(), local_name))\n                                    .or_insert_with(Vec::new)\n                                    .push(import_info);\n\n                                self.importers\n                                    .entry((source_module_id.clone(), imported_name))\n                                    .or_insert_with(HashSet::new)\n                                    .insert(uri.clone());\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /// Index all workspace symbols in a module\n    fn index_workspace_symbols(\n        \u0026mut self,\n        uri: \u0026Uri,\n        statements: \u0026[Statement],\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            self.index_statement_symbols(uri, stmt, None, interner);\n        }\n    }\n\n    /// Recursively index symbols from a statement\n    fn index_statement_symbols(\n        \u0026mut self,\n        uri: \u0026Uri,\n        stmt: \u0026Statement,\n        container_name: Option\u003cString\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        use typedlua_parser::ast::pattern::Pattern;\n        use typedlua_parser::ast::statement::ClassMember;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let name = interner.resolve(ident.node);\n                    let symbol = WorkspaceSymbolInfo {\n                        name: name.clone(),\n                        kind: SymbolKind::VARIABLE,\n                        uri: uri.clone(),\n                        span: ident.span.clone(),\n                        container_name: container_name.clone(),\n                    };\n                    self.workspace_symbols\n                        .entry(name.to_lowercase())\n                        .or_insert_with(Vec::new)\n                        .push(symbol);\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                let name = interner.resolve(func_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::FUNCTION,\n                    uri: uri.clone(),\n                    span: func_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::Class(class_decl) =\u003e {\n                let class_name = interner.resolve(class_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: class_name.clone(),\n                    kind: SymbolKind::CLASS,\n                    uri: uri.clone(),\n                    span: class_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(class_name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n\n                // Index class members\n                for member in \u0026class_decl.members {\n                    match member {\n                        ClassMember::Property(prop) =\u003e {\n                            let name = interner.resolve(prop.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: prop.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Method(method) =\u003e {\n                            let name = interner.resolve(method.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::METHOD,\n                                uri: uri.clone(),\n                                span: method.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Constructor(ctor) =\u003e {\n                            let symbol = WorkspaceSymbolInfo {\n                                name: \"constructor\".to_string(),\n                                kind: SymbolKind::CONSTRUCTOR,\n                                uri: uri.clone(),\n                                span: ctor.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(\"constructor\".to_string())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Getter(getter) =\u003e {\n                            let name = interner.resolve(getter.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: getter.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Setter(setter) =\u003e {\n                            let name = interner.resolve(setter.name.node);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::PROPERTY,\n                                uri: uri.clone(),\n                                span: setter.name.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                        ClassMember::Operator(op) =\u003e {\n                            let op_symbol = match op.operator {\n                                OperatorKind::Add =\u003e \"+\",\n                                OperatorKind::Subtract =\u003e \"-\",\n                                OperatorKind::Multiply =\u003e \"*\",\n                                OperatorKind::Divide =\u003e \"/\",\n                                OperatorKind::Modulo =\u003e \"%\",\n                                OperatorKind::Power =\u003e \"^\",\n                                OperatorKind::Equal =\u003e \"==\",\n                                OperatorKind::NotEqual =\u003e \"~=\",\n                                OperatorKind::LessThan =\u003e \"\u003c\",\n                                OperatorKind::LessThanOrEqual =\u003e \"\u003c=\",\n                                OperatorKind::GreaterThan =\u003e \"\u003e\",\n                                OperatorKind::GreaterThanOrEqual =\u003e \"\u003e=\",\n                                OperatorKind::Concatenate =\u003e \"..\",\n                                OperatorKind::Length =\u003e \"#\",\n                                OperatorKind::Index =\u003e \"[]\",\n                                OperatorKind::NewIndex =\u003e \"[]=\",\n                                OperatorKind::Call =\u003e \"()\",\n                                OperatorKind::UnaryMinus =\u003e \"unm\",\n                                OperatorKind::FloorDivide =\u003e \"//\",\n                                OperatorKind::BitwiseAnd =\u003e \"\u0026\",\n                                OperatorKind::BitwiseOr =\u003e \"|\",\n                                OperatorKind::BitwiseXor =\u003e \"~\",\n                                OperatorKind::ShiftLeft =\u003e \"\u003c\u003c\",\n                                OperatorKind::ShiftRight =\u003e \"\u003e\u003e\",\n                            };\n                            let name = format!(\"operator {}\", op_symbol);\n                            let symbol = WorkspaceSymbolInfo {\n                                name: name.clone(),\n                                kind: SymbolKind::OPERATOR,\n                                uri: uri.clone(),\n                                span: op.span.clone(),\n                                container_name: Some(class_name.clone()),\n                            };\n                            self.workspace_symbols\n                                .entry(name.to_lowercase())\n                                .or_insert_with(Vec::new)\n                                .push(symbol);\n                        }\n                    }\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                let name = interner.resolve(interface_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::INTERFACE,\n                    uri: uri.clone(),\n                    span: interface_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                let name = interner.resolve(type_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::TYPE_PARAMETER,\n                    uri: uri.clone(),\n                    span: type_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                let name = interner.resolve(enum_decl.name.node);\n                let symbol = WorkspaceSymbolInfo {\n                    name: name.clone(),\n                    kind: SymbolKind::ENUM,\n                    uri: uri.clone(),\n                    span: enum_decl.name.span.clone(),\n                    container_name: container_name.clone(),\n                };\n                self.workspace_symbols\n                    .entry(name.to_lowercase())\n                    .or_insert_with(Vec::new)\n                    .push(symbol);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Get export information for a symbol\n    #[allow(dead_code)] // Used in tests for symbol index validation\n    pub fn get_export(\u0026self, module_id: \u0026str, symbol_name: \u0026str) -\u003e Option\u003c\u0026ExportInfo\u003e {\n        self.exports\n            .get(\u0026(module_id.to_string(), symbol_name.to_string()))\n    }\n\n    /// Get all files that import a specific symbol from a module\n    pub fn get_importers(\u0026self, module_id: \u0026str, symbol_name: \u0026str) -\u003e Vec\u003cUri\u003e {\n        self.importers\n            .get(\u0026(module_id.to_string(), symbol_name.to_string()))\n            .map(|set| set.iter().cloned().collect())\n            .unwrap_or_default()\n    }\n\n    /// Get import information for a local symbol in a module\n    pub fn get_imports(\u0026self, module_id: \u0026str, local_name: \u0026str) -\u003e Option\u003c\u0026Vec\u003cImportInfo\u003e\u003e {\n        self.imports\n            .get(\u0026(module_id.to_string(), local_name.to_string()))\n    }\n\n    /// Search workspace symbols by query string\n    ///\n    /// Performs case-insensitive fuzzy matching on symbol names.\n    /// Returns symbols sorted by relevance (exact matches first, then prefix matches, then contains).\n    pub fn search_workspace_symbols(\u0026self, query: \u0026str) -\u003e Vec\u003cSymbolInformation\u003e {\n        if query.is_empty() {\n            // Return all symbols (limited to avoid overwhelming the client)\n            return self\n                .workspace_symbols\n                .values()\n                .flat_map(|symbols| symbols.iter())\n                .take(100)\n                .map(|symbol_info| self.workspace_symbol_to_lsp(symbol_info))\n                .collect();\n        }\n\n        let query_lower = query.to_lowercase();\n        let mut results = Vec::new();\n\n        // Collect matching symbols with scoring\n        for (name_lower, symbols) in \u0026self.workspace_symbols {\n            let score = if name_lower == \u0026query_lower {\n                3 // Exact match\n            } else if name_lower.starts_with(\u0026query_lower) {\n                2 // Prefix match\n            } else if name_lower.contains(\u0026query_lower) {\n                1 // Contains match\n            } else {\n                0 // No match\n            };\n\n            if score \u003e 0 {\n                for symbol_info in symbols {\n                    results.push((score, symbol_info));\n                }\n            }\n        }\n\n        // Sort by score (descending) and convert to SymbolInformation\n        results.sort_by(|(score_a, sym_a), (score_b, sym_b)| {\n            score_b\n                .cmp(score_a)\n                .then_with(|| sym_a.name.cmp(\u0026sym_b.name))\n        });\n\n        results\n            .into_iter()\n            .take(100) // Limit results\n            .map(|(_, symbol_info)| self.workspace_symbol_to_lsp(symbol_info))\n            .collect()\n    }\n\n    /// Convert WorkspaceSymbolInfo to LSP SymbolInformation\n    fn workspace_symbol_to_lsp(\u0026self, symbol: \u0026WorkspaceSymbolInfo) -\u003e SymbolInformation {\n        use lsp_types::{Location, Position, Range};\n\n        #[allow(deprecated)] // SymbolInformation uses deprecated fields\n        SymbolInformation {\n            name: symbol.name.clone(),\n            kind: symbol.kind,\n            tags: None,\n            deprecated: None,\n            location: Location {\n                uri: symbol.uri.clone(),\n                range: Range {\n                    start: Position {\n                        line: (symbol.span.line.saturating_sub(1)) as u32,\n                        character: (symbol.span.column.saturating_sub(1)) as u32,\n                    },\n                    end: Position {\n                        line: (symbol.span.line.saturating_sub(1)) as u32,\n                        character: ((symbol.span.column + symbol.span.len()).saturating_sub(1))\n                            as u32,\n                    },\n                },\n            },\n            container_name: symbol.container_name.clone(),\n        }\n    }\n\n    /// Helper to extract export name from a declaration\n    fn get_declaration_export_name(\n        stmt: \u0026Statement,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003c(String, String)\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let name = interner.resolve(ident.node);\n                    Some((name.clone(), name))\n                } else {\n                    None\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                let name = interner.resolve(func_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Class(class_decl) =\u003e {\n                let name = interner.resolve(class_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                let name = interner.resolve(interface_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                let name = interner.resolve(type_decl.name.node);\n                Some((name.clone(), name))\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                let name = interner.resolve(enum_decl.name.node);\n                Some((name.clone(), name))\n            }\n            _ =\u003e None,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::str::FromStr;\n\n    fn make_uri(path: \u0026str) -\u003e Uri {\n        Uri::from_str(\u0026format!(\"file://{}\", path)).unwrap()\n    }\n\n    #[test]\n    fn test_symbol_index_basic() {\n        let index = SymbolIndex::new();\n\n        let _uri = make_uri(\"/test/module.tl\");\n        let module_id = \"/test/module.tl\";\n\n        // Test that index starts empty\n        assert!(index.get_export(module_id, \"foo\").is_none());\n        assert!(index.get_importers(module_id, \"foo\").is_empty());\n    }\n\n    #[test]\n    fn test_export_indexing() {\n        // This would require parsing actual TypedLua code\n        // Skipping for now as it requires full parser setup\n    }\n\n    #[test]\n    fn test_import_indexing() {\n        // This would require parsing actual TypedLua code\n        // Skipping for now as it requires full parser setup\n    }\n}\n","traces":[{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":2}},{"line":560,"address":[],"length":0,"stats":{"Line":2}},{"line":561,"address":[],"length":0,"stats":{"Line":8}},{"line":565,"address":[],"length":0,"stats":{"Line":2}},{"line":566,"address":[],"length":0,"stats":{"Line":2}},{"line":567,"address":[],"length":0,"stats":{"Line":8}},{"line":568,"address":[],"length":0,"stats":{"Line":2}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}}],"covered":9,"coverable":339},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","core","diagnostics.rs"],"content":"use crate::core::document::Document;\nuse crate::traits::DiagnosticsProviderTrait;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::{\n    CollectingDiagnosticHandler, DiagnosticHandler, DiagnosticLevel,\n};\nuse typedlua_typechecker::TypeChecker;\n\n/// Provides diagnostics (errors and warnings) for documents\n#[derive(Clone)]\npub struct DiagnosticsProvider;\n\nimpl DiagnosticsProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Analyze a document and return diagnostics (internal method)\n    pub fn provide_impl(\u0026self, document: \u0026Document) -\u003e Vec\u003cDiagnostic\u003e {\n        let mut diagnostics = Vec::new();\n\n        // Create a diagnostic handler to collect errors\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n\n        // Create interner\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n\n        // Lex the document\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e {\n                // Collect lexer diagnostics\n                return Self::convert_diagnostics(handler);\n            }\n        };\n\n        // Parse the document\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let mut ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e {\n                // Collect parser diagnostics\n                return Self::convert_diagnostics(handler);\n            }\n        };\n\n        // Type check the document\n        let mut type_checker = TypeChecker::new(handler.clone(), \u0026interner, \u0026common_ids);\n        if let Err(_) = type_checker.check_program(\u0026mut ast) {\n            return Self::convert_diagnostics(handler);\n        }\n\n        // If we get here and there are still diagnostics (warnings), include them\n        diagnostics.extend(Self::convert_diagnostics(handler));\n        diagnostics\n    }\n\n    /// Convert core diagnostics to LSP diagnostics\n    fn convert_diagnostics(handler: Arc\u003cCollectingDiagnosticHandler\u003e) -\u003e Vec\u003cDiagnostic\u003e {\n        handler\n            .get_diagnostics()\n            .into_iter()\n            .map(|d| Diagnostic {\n                range: span_to_range(\u0026d.span),\n                severity: Some(match d.level {\n                    DiagnosticLevel::Error =\u003e DiagnosticSeverity::ERROR,\n                    DiagnosticLevel::Warning =\u003e DiagnosticSeverity::WARNING,\n                    DiagnosticLevel::Info =\u003e DiagnosticSeverity::INFORMATION,\n                }),\n                code: None, // Core diagnostics don't have error codes yet\n                source: Some(\"typedlua\".to_string()),\n                message: d.message,\n                related_information: None,\n                tags: None,\n                code_description: None,\n                data: None,\n            })\n            .collect()\n    }\n}\n\n/// Convert a Span to an LSP Range\nfn span_to_range(span: \u0026Span) -\u003e Range {\n    Range {\n        start: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: (span.column.saturating_sub(1)) as u32,\n        },\n        end: Position {\n            // Span only has start position, so end is start + length\n            line: (span.line.saturating_sub(1)) as u32,\n            character: ((span.column + span.len()).saturating_sub(1)) as u32,\n        },\n    }\n}\n\nimpl DiagnosticsProviderTrait for DiagnosticsProvider {\n    fn provide(\u0026self, document: \u0026Document) -\u003e Vec\u003cDiagnostic\u003e {\n        self.provide_impl(document)\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":39},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","core","document.rs"],"content":"use super::analysis::SymbolIndex;\nuse lsp_types::{\n    DidChangeTextDocumentParams, DidCloseTextDocumentParams, DidOpenTextDocumentParams,\n    DidSaveTextDocumentParams, Position, Uri,\n};\nuse std::cell::RefCell;\nuse std::collections::HashMap;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse typedlua_parser::ast::Program;\nuse typedlua_parser::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::module_resolver::{ModuleId, ModuleRegistry, ModuleResolver};\nuse typedlua_typechecker::SymbolTable;\n\n/// Abstraction for document management operations.\n///\n/// This trait allows for injecting mock document managers in tests\n/// and potential future substitution of different document storage backends.\n/// Currently implemented by [`DocumentManager`] but used directly\n/// rather than via trait objects.\n#[allow(dead_code)]\npub trait DocumentManagerTrait {\n    fn get(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026Document\u003e;\n    fn symbol_index(\u0026self) -\u003e \u0026SymbolIndex;\n    fn module_id_to_uri(\u0026self, module_id: \u0026ModuleId) -\u003e Option\u003c\u0026Uri\u003e;\n    fn uri_to_module_id(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026ModuleId\u003e;\n}\n\nimpl DocumentManagerTrait for DocumentManager {\n    fn get(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026Document\u003e {\n        self.documents.get(uri)\n    }\n\n    fn symbol_index(\u0026self) -\u003e \u0026SymbolIndex {\n        \u0026self.symbol_index\n    }\n\n    fn module_id_to_uri(\u0026self, module_id: \u0026ModuleId) -\u003e Option\u003c\u0026Uri\u003e {\n        self.module_id_to_uri.get(module_id)\n    }\n\n    fn uri_to_module_id(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026ModuleId\u003e {\n        self.uri_to_module_id.get(uri)\n    }\n}\n\n/// Parsed AST along with its string interner for resolving StringId values\npub type ParsedAst = (\n    Arc\u003cProgram\u003e,\n    Arc\u003cStringInterner\u003e,\n    Arc\u003ctypedlua_parser::string_interner::CommonIdentifiers\u003e,\n);\n\n/// Manages open documents and their cached analysis results\n#[derive(Debug)]\npub struct DocumentManager {\n    documents: HashMap\u003cUri, Document\u003e,\n    /// Module registry for cross-file symbol tracking\n    #[allow(dead_code)]\n    module_registry: Arc\u003cModuleRegistry\u003e,\n    /// Module resolver for import path resolution\n    module_resolver: Arc\u003cModuleResolver\u003e,\n    /// Bidirectional mapping between URIs and ModuleIds\n    uri_to_module_id: HashMap\u003cUri, ModuleId\u003e,\n    module_id_to_uri: HashMap\u003cModuleId, Uri\u003e,\n    /// Workspace root path\n    #[allow(dead_code)]\n    workspace_root: PathBuf,\n    /// Reverse index for fast cross-file symbol lookups\n    symbol_index: SymbolIndex,\n}\n\n/// Represents a single document with cached analysis\npub struct Document {\n    pub text: String,\n    pub version: i32,\n    /// Cached parsed AST with its interner (invalidated on change)\n    ast: RefCell\u003cOption\u003cParsedAst\u003e\u003e,\n    /// Cached symbol table (invalidated on change)\n    pub symbol_table: Option\u003cArc\u003cSymbolTable\u003e\u003e,\n    /// Module ID for this document (used for cross-file symbol resolution)\n    pub module_id: Option\u003cModuleId\u003e,\n}\n\nimpl std::fmt::Debug for Document {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"Document\")\n            .field(\n                \"text\",\n                \u0026format!(\"{}...\", \u0026self.text.chars().take(50).collect::\u003cString\u003e()),\n            )\n            .field(\"version\", \u0026self.version)\n            .field(\"ast\", \u0026\"\u003ccached\u003e\")\n            .field(\n                \"symbol_table\",\n                \u0026self.symbol_table.as_ref().map(|_| \"\u003ccached\u003e\"),\n            )\n            .field(\"module_id\", \u0026self.module_id)\n            .finish()\n    }\n}\n\nimpl Document {\n    #[cfg(test)]\n    pub fn new_test(text: String, version: i32) -\u003e Self {\n        Self {\n            text,\n            version,\n            ast: RefCell::new(None),\n            symbol_table: None,\n            module_id: None,\n        }\n    }\n\n    pub fn get_or_parse_ast(\u0026self) -\u003e Option\u003cParsedAst\u003e {\n        if let Some(cached) = self.ast.borrow().as_ref() {\n            return Some((\n                Arc::clone(\u0026cached.0),\n                Arc::clone(\u0026cached.1),\n                Arc::clone(\u0026cached.2),\n            ));\n        }\n\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (mut interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026self.text, handler.clone(), \u0026mut interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler, \u0026mut interner, \u0026common_ids);\n        let program = parser.parse().ok()?;\n\n        let ast_arc = Arc::new(program);\n        let interner_arc = Arc::new(interner);\n        let common_ids_arc = Arc::new(common_ids);\n        *self.ast.borrow_mut() = Some((\n            Arc::clone(\u0026ast_arc),\n            Arc::clone(\u0026interner_arc),\n            Arc::clone(\u0026common_ids_arc),\n        ));\n\n        Some((ast_arc, interner_arc, common_ids_arc))\n    }\n\n    pub(crate) fn clear_cache(\u0026self) {\n        *self.ast.borrow_mut() = None;\n    }\n}\n\nimpl DocumentManager {\n    pub fn new(\n        workspace_root: PathBuf,\n        module_registry: Arc\u003cModuleRegistry\u003e,\n        module_resolver: Arc\u003cModuleResolver\u003e,\n    ) -\u003e Self {\n        Self {\n            documents: HashMap::new(),\n            module_registry,\n            module_resolver,\n            uri_to_module_id: HashMap::new(),\n            module_id_to_uri: HashMap::new(),\n            workspace_root,\n            symbol_index: SymbolIndex::new(),\n        }\n    }\n\n    /// Create a test document manager with mock module system\n    #[cfg(test)]\n    pub fn new_test() -\u003e Self {\n        use typedlua_typechecker::cli::config::CompilerOptions;\n        use typedlua_typechecker::cli::fs::MockFileSystem;\n\n        let workspace_root = PathBuf::from(\"/test\");\n        let fs = Arc::new(MockFileSystem::new());\n        let compiler_options = CompilerOptions::default();\n        let module_config =\n            typedlua_typechecker::module_resolver::ModuleConfig::from_compiler_options(\n                \u0026compiler_options,\n                \u0026workspace_root,\n            );\n        let module_registry = Arc::new(ModuleRegistry::new());\n        let module_resolver = Arc::new(ModuleResolver::new(\n            fs,\n            module_config,\n            workspace_root.clone(),\n        ));\n\n        Self::new(workspace_root, module_registry, module_resolver)\n    }\n\n    pub fn open(\u0026mut self, params: DidOpenTextDocumentParams) {\n        let uri = params.text_document.uri.clone();\n\n        let module_id = uri\n            .as_str()\n            .strip_prefix(\"file://\")\n            .map(PathBuf::from)\n            .and_then(|path| path.canonicalize().ok())\n            .map(ModuleId::from);\n\n        let document = Document {\n            text: params.text_document.text,\n            version: params.text_document.version,\n            ast: RefCell::new(None),\n            symbol_table: None,\n            module_id: module_id.clone(),\n        };\n\n        if let Some(ref mid) = module_id {\n            self.uri_to_module_id\n                .insert(uri.clone(), mid.clone() as ModuleId);\n            self.module_id_to_uri\n                .insert(mid.clone() as ModuleId, uri.clone());\n        }\n\n        self.documents.insert(uri, document);\n    }\n\n    pub fn change(\u0026mut self, params: DidChangeTextDocumentParams) {\n        let uri = params.text_document.uri.clone();\n\n        if let Some(doc) = self.documents.get_mut(\u0026uri) {\n            doc.version = params.text_document.version;\n\n            for change in params.content_changes {\n                if let Some(range) = change.range {\n                    let start_offset = Self::position_to_offset(\u0026doc.text, range.start);\n                    let end_offset = Self::position_to_offset(\u0026doc.text, range.end);\n                    let mut new_text = String::new();\n                    new_text.push_str(\u0026doc.text[..start_offset]);\n                    new_text.push_str(\u0026change.text);\n                    new_text.push_str(\u0026doc.text[end_offset..]);\n                    doc.text = new_text;\n                } else {\n                    doc.text = change.text;\n                }\n            }\n\n            doc.clear_cache();\n\n            if let Some(module_id) = \u0026doc.module_id {\n                if let Some((ast, interner, _common_ids)) = doc.get_or_parse_ast() {\n                    self.symbol_index.update_document(\n                        \u0026uri,\n                        module_id.as_str(),\n                        \u0026ast,\n                        \u0026interner,\n                        |import_path, from_module_id: \u0026str| {\n                            self.module_resolver\n                                .resolve(import_path, std::path::Path::new(from_module_id))\n                                .ok()\n                                .and_then(|resolved_module_id| {\n                                    self.module_id_to_uri.get(\u0026resolved_module_id).map(|uri| {\n                                        (resolved_module_id.as_str().to_string(), uri.clone())\n                                    })\n                                })\n                        },\n                    );\n                }\n            }\n        }\n    }\n\n    pub fn save(\u0026mut self, _params: DidSaveTextDocumentParams) {}\n\n    pub fn close(\u0026mut self, params: DidCloseTextDocumentParams) {\n        let uri = \u0026params.text_document.uri;\n\n        if let Some(module_id) = self.uri_to_module_id.get(uri) {\n            self.symbol_index.clear_document(uri, module_id.as_str());\n        }\n\n        if let Some(module_id) = self.uri_to_module_id.remove(uri) {\n            self.module_id_to_uri.remove(\u0026module_id);\n        }\n        self.documents.remove(uri);\n    }\n\n    pub fn get(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026Document\u003e {\n        self.documents.get(uri)\n    }\n\n    pub fn module_id_to_uri(\u0026self, module_id: \u0026ModuleId) -\u003e Option\u003c\u0026Uri\u003e {\n        self.module_id_to_uri.get(module_id)\n    }\n\n    pub fn module_resolver(\u0026self) -\u003e \u0026Arc\u003cModuleResolver\u003e {\n        \u0026self.module_resolver\n    }\n\n    pub fn symbol_index(\u0026self) -\u003e \u0026SymbolIndex {\n        \u0026self.symbol_index\n    }\n\n    pub fn uri_to_module_id(\u0026self, uri: \u0026Uri) -\u003e Option\u003c\u0026ModuleId\u003e {\n        self.uri_to_module_id.get(uri)\n    }\n\n    fn position_to_offset(text: \u0026str, position: Position) -\u003e usize {\n        let mut offset = 0;\n        let mut current_line = 0;\n\n        for (idx, ch) in text.char_indices() {\n            if current_line == position.line {\n                if offset == position.character as usize {\n                    return idx;\n                }\n                if ch != '\\n' \u0026\u0026 ch != '\\r' {\n                    offset += 1;\n                }\n            }\n\n            if ch == '\\n' {\n                current_line += 1;\n                offset = 0;\n            }\n        }\n\n        text.len()\n    }\n}\n","traces":[{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":78}},{"line":111,"address":[],"length":0,"stats":{"Line":234}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}}],"covered":2,"coverable":133},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","core","mod.rs"],"content":"#![allow(unused_imports)]\n//! Core document management for the LSP server\n\npub mod analysis;\npub mod diagnostics;\npub mod document;\n\npub use diagnostics::DiagnosticsProvider;\npub use document::{Document, DocumentManager, DocumentManagerTrait};\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","di","container.rs"],"content":"use std::any::{Any, TypeId};\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\n#[derive(Clone, Copy)]\n#[allow(dead_code)]\npub enum ServiceLifetime {\n    Transient,\n    Singleton,\n}\n\npub struct DiContainer {\n    factories: HashMap\u003cTypeId, FactoryFn\u003e,\n    lifetimes: HashMap\u003cTypeId, ServiceLifetime\u003e,\n    singletons: HashMap\u003cTypeId, Arc\u003cdyn Any + Send + Sync\u003e\u003e,\n}\n\ntype FactoryFn = Arc\u003cdyn Fn(\u0026mut DiContainer) -\u003e Arc\u003cdyn Any + Send + Sync\u003e + Send + Sync\u003e;\n\nimpl DiContainer {\n    pub fn new() -\u003e Self {\n        Self {\n            factories: HashMap::new(),\n            lifetimes: HashMap::new(),\n            singletons: HashMap::new(),\n        }\n    }\n\n    pub fn register\u003cT\u003e(\n        \u0026mut self,\n        factory: impl Fn(\u0026mut DiContainer) -\u003e T + 'static + Send + Sync,\n        lifetime: ServiceLifetime,\n    ) where\n        T: Clone + Send + Sync + 'static,\n    {\n        let type_id = TypeId::of::\u003cT\u003e();\n        let factory_fn: FactoryFn = Arc::new(move |_container| {\n            let value = factory(_container);\n            let arc: Arc\u003cdyn Any + Send + Sync\u003e = Arc::new(value);\n            arc\n        });\n        self.factories.insert(type_id, factory_fn);\n        self.lifetimes.insert(type_id, lifetime);\n    }\n\n    #[allow(dead_code)]\n    pub fn register_with_factory\u003cT\u003e(\n        \u0026mut self,\n        factory: impl Fn(\u0026mut DiContainer) -\u003e T + 'static + Send + Sync,\n        lifetime: ServiceLifetime,\n    ) where\n        T: Clone + Send + Sync + 'static,\n    {\n        self.register(factory, lifetime);\n    }\n\n    pub fn resolve\u003cT\u003e(\u0026mut self) -\u003e Option\u003cT\u003e\n    where\n        T: Clone + Send + Sync + 'static,\n    {\n        let type_id = TypeId::of::\u003cT\u003e();\n\n        let lifetime = self.lifetimes.get(\u0026type_id).copied();\n\n        match lifetime {\n            Some(ServiceLifetime::Singleton) =\u003e {\n                if let Some(singleton) = self.singletons.get(\u0026type_id).cloned() {\n                    return singleton.downcast::\u003cT\u003e().ok().map(|arc| (*arc).clone());\n                }\n\n                let factory = self.factories.get(\u0026type_id).cloned();\n                if let Some(factory) = factory {\n                    let result = (factory)(self);\n                    let clone = result.clone();\n                    self.singletons.insert(type_id, result);\n                    return clone.downcast::\u003cT\u003e().ok().map(|arc| (*arc).clone());\n                }\n            }\n            Some(ServiceLifetime::Transient) | None =\u003e {\n                let factory = self.factories.get(\u0026type_id).cloned();\n                if let Some(factory) = factory {\n                    let result = (factory)(self);\n                    return result.downcast::\u003cT\u003e().ok().map(|arc| (*arc).clone());\n                }\n            }\n        }\n\n        None\n    }\n\n    #[allow(dead_code)]\n    pub fn is_registered\u003cT\u003e(\u0026self) -\u003e bool\n    where\n        T: 'static,\n    {\n        self.factories.contains_key(\u0026TypeId::of::\u003cT\u003e())\n    }\n\n    #[allow(dead_code)]\n    pub fn service_count(\u0026self) -\u003e usize {\n        self.factories.len()\n    }\n\n    #[allow(dead_code)]\n    pub fn singleton_count(\u0026self) -\u003e usize {\n        self.singletons.len()\n    }\n\n    #[allow(dead_code)]\n    pub fn clear(\u0026mut self) {\n        self.factories.clear();\n        self.lifetimes.clear();\n        self.singletons.clear();\n    }\n}\n\nimpl Default for DiContainer {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::atomic::{AtomicUsize, Ordering};\n\n    trait TestTrait: Send + Sync {\n        fn get_value(\u0026self) -\u003e i32;\n    }\n\n    #[derive(Clone)]\n    struct TestService {\n        value: i32,\n    }\n\n    impl TestTrait for TestService {\n        fn get_value(\u0026self) -\u003e i32 {\n            self.value\n        }\n    }\n\n    #[test]\n    fn test_transient_service() {\n        let mut container = DiContainer::new();\n        let counter = AtomicUsize::new(0);\n        container.register(\n            move |_| {\n                let val = counter.fetch_add(1, Ordering::SeqCst) + 1;\n                TestService { value: val as i32 }\n            },\n            ServiceLifetime::Transient,\n        );\n\n        let service1 = container.resolve::\u003cTestService\u003e();\n        let service2 = container.resolve::\u003cTestService\u003e();\n\n        assert!(service1.is_some());\n        assert!(service2.is_some());\n        assert_ne!(service1.unwrap().value, service2.unwrap().value);\n    }\n\n    #[test]\n    fn test_singleton_service() {\n        let mut container = DiContainer::new();\n        container.register(|_| TestService { value: 42 }, ServiceLifetime::Singleton);\n\n        let service1 = container.resolve::\u003cTestService\u003e();\n        let service2 = container.resolve::\u003cTestService\u003e();\n\n        assert!(service1.is_some());\n        assert!(service2.is_some());\n        assert_eq!(service1.unwrap().value, service2.unwrap().value);\n    }\n\n    #[test]\n    fn test_arc_singleton() {\n        let mut container = DiContainer::new();\n        container.register(\n            |_| Arc::new(TestService { value: 99 }) as Arc\u003cdyn TestTrait\u003e,\n            ServiceLifetime::Singleton,\n        );\n\n        let service1 = container.resolve::\u003cArc\u003cdyn TestTrait\u003e\u003e();\n        let service2 = container.resolve::\u003cArc\u003cdyn TestTrait\u003e\u003e();\n\n        assert!(service1.is_some());\n        assert!(service2.is_some());\n        assert_eq!(service1.unwrap().get_value(), service2.unwrap().get_value());\n    }\n\n    #[test]\n    fn test_dependent_services() {\n        struct DepService {\n            value: i32,\n        }\n\n        impl DepService {\n            fn new() -\u003e Self {\n                Self { value: 10 }\n            }\n        }\n\n        struct MainService {\n            dep: Arc\u003cDepService\u003e,\n        }\n\n        impl MainService {\n            fn new(dep: Arc\u003cDepService\u003e) -\u003e Self {\n                Self { dep }\n            }\n        }\n\n        impl TestTrait for MainService {\n            fn get_value(\u0026self) -\u003e i32 {\n                self.dep.value + 5\n            }\n        }\n\n        let mut container = DiContainer::new();\n        container.register(|_| Arc::new(DepService::new()), ServiceLifetime::Singleton);\n        container.register(\n            |container| {\n                let dep = container.resolve::\u003cArc\u003cDepService\u003e\u003e().unwrap();\n                Arc::new(MainService::new(dep)) as Arc\u003cdyn TestTrait\u003e\n            },\n            ServiceLifetime::Singleton,\n        );\n\n        let service = container.resolve::\u003cArc\u003cdyn TestTrait\u003e\u003e();\n        assert_eq!(service.unwrap().get_value(), 15);\n    }\n\n    #[test]\n    fn test_is_registered() {\n        let mut container = DiContainer::new();\n        assert!(!container.is_registered::\u003cTestService\u003e());\n\n        container.register(|_| TestService { value: 1 }, ServiceLifetime::Transient);\n        assert!(container.is_registered::\u003cTestService\u003e());\n    }\n\n    #[test]\n    fn test_service_count() {\n        let mut container = DiContainer::new();\n        assert_eq!(container.service_count(), 0);\n\n        container.register(|_| TestService { value: 1 }, ServiceLifetime::Transient);\n        assert_eq!(container.service_count(), 1);\n\n        #[derive(Clone)]\n        struct OtherService {\n            value: i32,\n        }\n\n        container.register(|_| OtherService { value: 2 }, ServiceLifetime::Singleton);\n        assert_eq!(container.service_count(), 2);\n    }\n\n    #[test]\n    fn test_singleton_count() {\n        let mut container = DiContainer::new();\n        assert_eq!(container.singleton_count(), 0);\n\n        container.register(|_| TestService { value: 1 }, ServiceLifetime::Transient);\n        let _ = container.resolve::\u003cTestService\u003e();\n        assert_eq!(container.singleton_count(), 0);\n\n        container.register(|_| TestService { value: 2 }, ServiceLifetime::Singleton);\n        let _ = container.resolve::\u003cTestService\u003e();\n        assert_eq!(container.singleton_count(), 1);\n    }\n\n    #[test]\n    fn test_nonexistent_service() {\n        let mut container = DiContainer::new();\n        let service = container.resolve::\u003cTestService\u003e();\n        assert!(service.is_none());\n    }\n\n    #[test]\n    fn test_clear_container() {\n        let mut container = DiContainer::new();\n        container.register(|_| TestService { value: 1 }, ServiceLifetime::Transient);\n\n        #[derive(Clone)]\n        struct OtherService {\n            value: i32,\n        }\n\n        container.register(|_| OtherService { value: 2 }, ServiceLifetime::Singleton);\n\n        assert!(container.is_registered::\u003cTestService\u003e());\n        assert_eq!(container.service_count(), 2);\n\n        container.clear();\n\n        assert!(!container.is_registered::\u003cTestService\u003e());\n        assert_eq!(container.service_count(), 0);\n        assert_eq!(container.singleton_count(), 0);\n    }\n\n    #[test]\n    fn test_default_container() {\n        let container = DiContainer::default();\n        assert_eq!(container.service_count(), 0);\n        assert_eq!(container.singleton_count(), 0);\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":33}},{"line":23,"address":[],"length":0,"stats":{"Line":66}},{"line":24,"address":[],"length":0,"stats":{"Line":33}},{"line":25,"address":[],"length":0,"stats":{"Line":33}},{"line":29,"address":[],"length":0,"stats":{"Line":40}},{"line":36,"address":[],"length":0,"stats":{"Line":80}},{"line":37,"address":[],"length":0,"stats":{"Line":158}},{"line":38,"address":[],"length":0,"stats":{"Line":76}},{"line":39,"address":[],"length":0,"stats":{"Line":114}},{"line":40,"address":[],"length":0,"stats":{"Line":38}},{"line":42,"address":[],"length":0,"stats":{"Line":160}},{"line":43,"address":[],"length":0,"stats":{"Line":160}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":57}},{"line":61,"address":[],"length":0,"stats":{"Line":114}},{"line":63,"address":[],"length":0,"stats":{"Line":285}},{"line":65,"address":[],"length":0,"stats":{"Line":54}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":115}},{"line":68,"address":[],"length":0,"stats":{"Line":96}},{"line":71,"address":[],"length":0,"stats":{"Line":85}},{"line":72,"address":[],"length":0,"stats":{"Line":34}},{"line":73,"address":[],"length":0,"stats":{"Line":34}},{"line":74,"address":[],"length":0,"stats":{"Line":51}},{"line":75,"address":[],"length":0,"stats":{"Line":68}},{"line":76,"address":[],"length":0,"stats":{"Line":102}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":120}},{"line":81,"address":[],"length":0,"stats":{"Line":45}},{"line":82,"address":[],"length":0,"stats":{"Line":42}},{"line":83,"address":[],"length":0,"stats":{"Line":126}},{"line":88,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":12}},{"line":96,"address":[],"length":0,"stats":{"Line":36}},{"line":100,"address":[],"length":0,"stats":{"Line":18}},{"line":101,"address":[],"length":0,"stats":{"Line":36}},{"line":105,"address":[],"length":0,"stats":{"Line":15}},{"line":106,"address":[],"length":0,"stats":{"Line":30}},{"line":110,"address":[],"length":0,"stats":{"Line":3}},{"line":111,"address":[],"length":0,"stats":{"Line":6}},{"line":112,"address":[],"length":0,"stats":{"Line":6}},{"line":113,"address":[],"length":0,"stats":{"Line":6}},{"line":118,"address":[],"length":0,"stats":{"Line":3}},{"line":119,"address":[],"length":0,"stats":{"Line":3}}],"covered":41,"coverable":45},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","di","mod.rs"],"content":"pub use container::{DiContainer, ServiceLifetime};\n\nmod container;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","edit","code_actions.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse typedlua_parser::ast::pattern::Pattern;\nuse typedlua_parser::ast::statement::Statement;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides code actions (quick fixes, refactorings, source actions)\n#[derive(Clone)]\npub struct CodeActionsProvider;\n\nimpl CodeActionsProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide code actions for a given range in the document\n    pub fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        range: Range,\n        context: CodeActionContext,\n    ) -\u003e Vec\u003cCodeActionOrCommand\u003e {\n        let mut actions = Vec::new();\n\n        // Parse the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return actions,\n        };\n\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return actions,\n        };\n\n        // Get diagnostics from context\n        for diagnostic in \u0026context.diagnostics {\n            // Quick fix: Add type annotation for variables without types\n            if diagnostic.message.contains(\"type annotation\") {\n                if let Some(action) = self.quick_fix_add_type_annotation(uri, diagnostic) {\n                    actions.push(CodeActionOrCommand::CodeAction(action));\n                }\n            }\n\n            // Quick fix: Remove unused variable\n            if diagnostic.message.contains(\"unused\") {\n                if let Some(action) = self.quick_fix_unused_variable(uri, diagnostic) {\n                    actions.push(CodeActionOrCommand::CodeAction(action));\n                }\n            }\n        }\n\n        // Refactoring: Extract variable (if there's a selection)\n        if range.start != range.end {\n            if let Some(action) = self.refactor_extract_variable(uri, document, range, \u0026ast) {\n                actions.push(CodeActionOrCommand::CodeAction(action));\n            }\n        }\n\n        // Source action: Add missing type annotations\n        if let Some(action) = self.source_action_add_type_annotations(uri, \u0026ast) {\n            actions.push(CodeActionOrCommand::CodeAction(action));\n        }\n\n        actions\n    }\n\n    /// Resolve additional details for a code action\n    pub fn resolve(\u0026self, action: CodeAction) -\u003e CodeAction {\n        // For now, return the action as-is\n        // In the future, we could lazy-load expensive edits here\n        action\n    }\n\n    // Quick fix implementations\n\n    /// Generate a quick fix to add type annotation\n    fn quick_fix_add_type_annotation(\n        \u0026self,\n        uri: \u0026Uri,\n        diagnostic: \u0026Diagnostic,\n    ) -\u003e Option\u003cCodeAction\u003e {\n        // For now, return a simple code action that inserts \": unknown\"\n        // In the future, we could infer the actual type from the type checker\n        let insert_pos = diagnostic.range.end;\n\n        let mut changes = HashMap::new();\n        changes.insert(\n            uri.clone(),\n            vec![TextEdit {\n                range: Range {\n                    start: insert_pos,\n                    end: insert_pos,\n                },\n                new_text: \": unknown\".to_string(),\n            }],\n        );\n\n        Some(CodeAction {\n            title: \"Add type annotation\".to_string(),\n            kind: Some(CodeActionKind::QUICKFIX),\n            diagnostics: Some(vec![diagnostic.clone()]),\n            edit: Some(WorkspaceEdit {\n                changes: Some(changes),\n                document_changes: None,\n                change_annotations: None,\n            }),\n            command: None,\n            is_preferred: Some(true),\n            disabled: None,\n            data: None,\n        })\n    }\n\n    /// Generate a quick fix for unused variable\n    fn quick_fix_unused_variable(\u0026self, uri: \u0026Uri, diagnostic: \u0026Diagnostic) -\u003e Option\u003cCodeAction\u003e {\n        // Prefix the variable name with underscore\n        let mut changes = HashMap::new();\n        changes.insert(\n            uri.clone(),\n            vec![TextEdit {\n                range: Range {\n                    start: diagnostic.range.start,\n                    end: diagnostic.range.start,\n                },\n                new_text: \"_\".to_string(),\n            }],\n        );\n\n        Some(CodeAction {\n            title: \"Prefix with underscore\".to_string(),\n            kind: Some(CodeActionKind::QUICKFIX),\n            diagnostics: Some(vec![diagnostic.clone()]),\n            edit: Some(WorkspaceEdit {\n                changes: Some(changes),\n                document_changes: None,\n                change_annotations: None,\n            }),\n            command: None,\n            is_preferred: Some(false),\n            disabled: None,\n            data: None,\n        })\n    }\n\n    // Refactoring implementations\n\n    /// Generate a refactoring to extract a variable\n    fn refactor_extract_variable(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        range: Range,\n        _ast: \u0026typedlua_parser::ast::Program,\n    ) -\u003e Option\u003cCodeAction\u003e {\n        // Get the selected text\n        let selected_text = self.get_text_in_range(document, range)?;\n\n        // Check if the selection is a valid expression\n        if selected_text.trim().is_empty() {\n            return None;\n        }\n\n        // Generate the variable name\n        let var_name = \"extracted\";\n\n        // Create the extraction edits\n        let mut changes = HashMap::new();\n\n        // Insert variable declaration before the statement\n        let insert_line = range.start.line;\n        let indent = self.get_line_indent(document, insert_line);\n\n        let edits = vec![\n            // Insert the variable declaration\n            TextEdit {\n                range: Range {\n                    start: Position {\n                        line: insert_line,\n                        character: 0,\n                    },\n                    end: Position {\n                        line: insert_line,\n                        character: 0,\n                    },\n                },\n                new_text: format!(\n                    \"{}local {}: unknown = {}\\n\",\n                    indent,\n                    var_name,\n                    selected_text.trim()\n                ),\n            },\n            // Replace the selection with the variable name\n            TextEdit {\n                range,\n                new_text: var_name.to_string(),\n            },\n        ];\n\n        changes.insert(uri.clone(), edits);\n\n        Some(CodeAction {\n            title: \"Extract to variable\".to_string(),\n            kind: Some(CodeActionKind::REFACTOR_EXTRACT),\n            diagnostics: None,\n            edit: Some(WorkspaceEdit {\n                changes: Some(changes),\n                document_changes: None,\n                change_annotations: None,\n            }),\n            command: None,\n            is_preferred: Some(false),\n            disabled: None,\n            data: None,\n        })\n    }\n\n    // Source action implementations\n\n    /// Generate a source action to add missing type annotations\n    fn source_action_add_type_annotations(\n        \u0026self,\n        uri: \u0026Uri,\n        ast: \u0026typedlua_parser::ast::Program,\n    ) -\u003e Option\u003cCodeAction\u003e {\n        let mut edits = Vec::new();\n\n        // Find all variables without type annotations\n        for stmt in \u0026ast.statements {\n            self.collect_missing_type_annotations(stmt, \u0026mut edits);\n        }\n\n        if edits.is_empty() {\n            return None;\n        }\n\n        let mut changes = HashMap::new();\n        changes.insert(uri.clone(), edits);\n\n        Some(CodeAction {\n            title: \"Add type annotations to all variables\".to_string(),\n            kind: Some(CodeActionKind::SOURCE),\n            diagnostics: None,\n            edit: Some(WorkspaceEdit {\n                changes: Some(changes),\n                document_changes: None,\n                change_annotations: None,\n            }),\n            command: None,\n            is_preferred: Some(false),\n            disabled: None,\n            data: None,\n        })\n    }\n\n    // Helper methods\n\n    /// Get text within a range\n    fn get_text_in_range(\u0026self, document: \u0026Document, range: Range) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n\n        if range.start.line == range.end.line {\n            // Single line selection\n            let line_idx = range.start.line as usize;\n            if line_idx \u003e= lines.len() {\n                return None;\n            }\n\n            let line = lines[line_idx];\n            let start = range.start.character as usize;\n            let end = range.end.character as usize;\n\n            if start \u003e= line.len() || end \u003e line.len() {\n                return None;\n            }\n\n            Some(line[start..end].to_string())\n        } else {\n            // Multi-line selection\n            let mut result = String::new();\n\n            for line_idx in range.start.line..=range.end.line {\n                let line_idx = line_idx as usize;\n                if line_idx \u003e= lines.len() {\n                    break;\n                }\n\n                let line = lines[line_idx];\n\n                if line_idx == range.start.line as usize {\n                    let start = range.start.character as usize;\n                    if start \u003c line.len() {\n                        result.push_str(\u0026line[start..]);\n                    }\n                } else if line_idx == range.end.line as usize {\n                    let end = range.end.character as usize;\n                    if end \u003c= line.len() {\n                        result.push_str(\u0026line[..end]);\n                    }\n                } else {\n                    result.push_str(line);\n                }\n\n                if line_idx \u003c range.end.line as usize {\n                    result.push('\\n');\n                }\n            }\n\n            Some(result)\n        }\n    }\n\n    /// Get indentation of a line\n    fn get_line_indent(\u0026self, document: \u0026Document, line: u32) -\u003e String {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        let line_idx = line as usize;\n\n        if line_idx \u003e= lines.len() {\n            return String::new();\n        }\n\n        let line = lines[line_idx];\n        line.chars().take_while(|c| c.is_whitespace()).collect()\n    }\n\n    /// Find statement containing a range\n    /// Collect missing type annotations from statements\n    fn collect_missing_type_annotations(\u0026self, stmt: \u0026Statement, edits: \u0026mut Vec\u003cTextEdit\u003e) {\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if var_decl.type_annotation.is_none() {\n                    if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                        // Add type annotation after the identifier\n                        let position = Position {\n                            line: (ident.span.line.saturating_sub(1)) as u32,\n                            character: ((ident.span.column + ident.span.len()).saturating_sub(1))\n                                as u32,\n                        };\n\n                        edits.push(TextEdit {\n                            range: Range {\n                                start: position,\n                                end: position,\n                            },\n                            new_text: \": unknown\".to_string(),\n                        });\n                    }\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                // Recursively check function body\n                for body_stmt in \u0026func_decl.body.statements {\n                    self.collect_missing_type_annotations(body_stmt, edits);\n                }\n            }\n            Statement::If(if_stmt) =\u003e {\n                for then_stmt in \u0026if_stmt.then_block.statements {\n                    self.collect_missing_type_annotations(then_stmt, edits);\n                }\n                for else_if in \u0026if_stmt.else_ifs {\n                    for stmt in \u0026else_if.block.statements {\n                        self.collect_missing_type_annotations(stmt, edits);\n                    }\n                }\n                if let Some(else_block) = \u0026if_stmt.else_block {\n                    for stmt in \u0026else_block.statements {\n                        self.collect_missing_type_annotations(stmt, edits);\n                    }\n                }\n            }\n            Statement::While(while_stmt) =\u003e {\n                for body_stmt in \u0026while_stmt.body.statements {\n                    self.collect_missing_type_annotations(body_stmt, edits);\n                }\n            }\n            Statement::Block(block) =\u003e {\n                for body_stmt in \u0026block.statements {\n                    self.collect_missing_type_annotations(body_stmt, edits);\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_code_action_kinds() {\n        let provider = CodeActionsProvider::new();\n\n        // Test that we can create different kinds of code actions\n        let doc = Document::new_test(\"local x = 10\".to_string(), 1);\n\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 0,\n                character: 12,\n            },\n        };\n\n        let context = CodeActionContext {\n            diagnostics: vec![],\n            only: None,\n            trigger_kind: None,\n        };\n\n        let uri = \"file:///test.lua\".parse::\u003cUri\u003e().unwrap();\n        let _actions = provider.provide(\u0026uri, \u0026doc, range, context);\n\n        // Should provide at least source actions\n    }\n\n    #[test]\n    fn test_quick_fix_scenarios() {\n        let provider = CodeActionsProvider::new();\n\n        let doc = Document::new_test(\"local unused_var = 10\".to_string(), 1);\n\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 6,\n            },\n            end: Position {\n                line: 0,\n                character: 16,\n            },\n        };\n\n        // Create a diagnostic for unused variable\n        let diagnostic = Diagnostic {\n            range,\n            severity: Some(DiagnosticSeverity::WARNING),\n            code: None,\n            code_description: None,\n            source: Some(\"typedlua\".to_string()),\n            message: \"unused variable\".to_string(),\n            related_information: None,\n            tags: None,\n            data: None,\n        };\n\n        let context = CodeActionContext {\n            diagnostics: vec![diagnostic],\n            only: None,\n            trigger_kind: None,\n        };\n\n        let uri = \"file:///test.lua\".parse::\u003cUri\u003e().unwrap();\n        let actions = provider.provide(\u0026uri, \u0026doc, range, context);\n\n        // Should provide quick fix for unused variable\n        assert!(actions.len() \u003e 0);\n\n        // Verify at least one action is a quick fix\n        let has_quickfix = actions.iter().any(|action| {\n            if let CodeActionOrCommand::CodeAction(a) = action {\n                a.kind == Some(CodeActionKind::QUICKFIX)\n            } else {\n                false\n            }\n        });\n        assert!(has_quickfix);\n    }\n\n    #[test]\n    fn test_refactoring_scenarios() {\n        let provider = CodeActionsProvider::new();\n\n        let doc = Document::new_test(\"local x = 10 + 20\".to_string(), 1);\n\n        // Select the expression \"10 + 20\"\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 10,\n            },\n            end: Position {\n                line: 0,\n                character: 17,\n            },\n        };\n\n        let context = CodeActionContext {\n            diagnostics: vec![],\n            only: None,\n            trigger_kind: None,\n        };\n\n        let uri = \"file:///test.lua\".parse::\u003cUri\u003e().unwrap();\n        let actions = provider.provide(\u0026uri, \u0026doc, range, context);\n\n        // Should provide extract variable refactoring\n        let has_extract = actions.iter().any(|action| {\n            if let CodeActionOrCommand::CodeAction(a) = action {\n                a.kind == Some(CodeActionKind::REFACTOR_EXTRACT)\n            } else {\n                false\n            }\n        });\n        assert!(has_extract);\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":6}},{"line":18,"address":[],"length":0,"stats":{"Line":6}},{"line":22,"address":[],"length":0,"stats":{"Line":6}},{"line":29,"address":[],"length":0,"stats":{"Line":12}},{"line":32,"address":[],"length":0,"stats":{"Line":18}},{"line":33,"address":[],"length":0,"stats":{"Line":18}},{"line":34,"address":[],"length":0,"stats":{"Line":30}},{"line":35,"address":[],"length":0,"stats":{"Line":12}},{"line":36,"address":[],"length":0,"stats":{"Line":12}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":36}},{"line":41,"address":[],"length":0,"stats":{"Line":12}},{"line":42,"address":[],"length":0,"stats":{"Line":12}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":10}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":57,"address":[],"length":0,"stats":{"Line":10}},{"line":58,"address":[],"length":0,"stats":{"Line":4}},{"line":64,"address":[],"length":0,"stats":{"Line":6}},{"line":65,"address":[],"length":0,"stats":{"Line":42}},{"line":66,"address":[],"length":0,"stats":{"Line":12}},{"line":71,"address":[],"length":0,"stats":{"Line":30}},{"line":72,"address":[],"length":0,"stats":{"Line":12}},{"line":75,"address":[],"length":0,"stats":{"Line":6}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":4}},{"line":129,"address":[],"length":0,"stats":{"Line":4}},{"line":130,"address":[],"length":0,"stats":{"Line":4}},{"line":131,"address":[],"length":0,"stats":{"Line":4}},{"line":132,"address":[],"length":0,"stats":{"Line":4}},{"line":133,"address":[],"length":0,"stats":{"Line":4}},{"line":134,"address":[],"length":0,"stats":{"Line":4}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":140,"address":[],"length":0,"stats":{"Line":2}},{"line":141,"address":[],"length":0,"stats":{"Line":6}},{"line":142,"address":[],"length":0,"stats":{"Line":4}},{"line":143,"address":[],"length":0,"stats":{"Line":6}},{"line":144,"address":[],"length":0,"stats":{"Line":4}},{"line":145,"address":[],"length":0,"stats":{"Line":6}},{"line":146,"address":[],"length":0,"stats":{"Line":4}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":4}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":151,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":6}},{"line":167,"address":[],"length":0,"stats":{"Line":30}},{"line":170,"address":[],"length":0,"stats":{"Line":12}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":12}},{"line":178,"address":[],"length":0,"stats":{"Line":12}},{"line":181,"address":[],"length":0,"stats":{"Line":12}},{"line":182,"address":[],"length":0,"stats":{"Line":30}},{"line":184,"address":[],"length":0,"stats":{"Line":12}},{"line":186,"address":[],"length":0,"stats":{"Line":6}},{"line":187,"address":[],"length":0,"stats":{"Line":12}},{"line":188,"address":[],"length":0,"stats":{"Line":12}},{"line":189,"address":[],"length":0,"stats":{"Line":12}},{"line":190,"address":[],"length":0,"stats":{"Line":12}},{"line":192,"address":[],"length":0,"stats":{"Line":12}},{"line":193,"address":[],"length":0,"stats":{"Line":12}},{"line":194,"address":[],"length":0,"stats":{"Line":12}},{"line":197,"address":[],"length":0,"stats":{"Line":12}},{"line":198,"address":[],"length":0,"stats":{"Line":12}},{"line":199,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":6}},{"line":201,"address":[],"length":0,"stats":{"Line":6}},{"line":205,"address":[],"length":0,"stats":{"Line":6}},{"line":206,"address":[],"length":0,"stats":{"Line":12}},{"line":207,"address":[],"length":0,"stats":{"Line":6}},{"line":211,"address":[],"length":0,"stats":{"Line":30}},{"line":213,"address":[],"length":0,"stats":{"Line":6}},{"line":214,"address":[],"length":0,"stats":{"Line":18}},{"line":215,"address":[],"length":0,"stats":{"Line":12}},{"line":216,"address":[],"length":0,"stats":{"Line":12}},{"line":217,"address":[],"length":0,"stats":{"Line":12}},{"line":218,"address":[],"length":0,"stats":{"Line":18}},{"line":219,"address":[],"length":0,"stats":{"Line":12}},{"line":220,"address":[],"length":0,"stats":{"Line":12}},{"line":222,"address":[],"length":0,"stats":{"Line":12}},{"line":223,"address":[],"length":0,"stats":{"Line":12}},{"line":224,"address":[],"length":0,"stats":{"Line":6}},{"line":225,"address":[],"length":0,"stats":{"Line":6}},{"line":232,"address":[],"length":0,"stats":{"Line":6}},{"line":237,"address":[],"length":0,"stats":{"Line":12}},{"line":240,"address":[],"length":0,"stats":{"Line":24}},{"line":241,"address":[],"length":0,"stats":{"Line":18}},{"line":244,"address":[],"length":0,"stats":{"Line":12}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":12}},{"line":249,"address":[],"length":0,"stats":{"Line":30}},{"line":251,"address":[],"length":0,"stats":{"Line":6}},{"line":252,"address":[],"length":0,"stats":{"Line":18}},{"line":253,"address":[],"length":0,"stats":{"Line":12}},{"line":254,"address":[],"length":0,"stats":{"Line":12}},{"line":255,"address":[],"length":0,"stats":{"Line":12}},{"line":256,"address":[],"length":0,"stats":{"Line":18}},{"line":257,"address":[],"length":0,"stats":{"Line":12}},{"line":258,"address":[],"length":0,"stats":{"Line":12}},{"line":260,"address":[],"length":0,"stats":{"Line":12}},{"line":261,"address":[],"length":0,"stats":{"Line":12}},{"line":262,"address":[],"length":0,"stats":{"Line":6}},{"line":263,"address":[],"length":0,"stats":{"Line":6}},{"line":270,"address":[],"length":0,"stats":{"Line":6}},{"line":271,"address":[],"length":0,"stats":{"Line":24}},{"line":273,"address":[],"length":0,"stats":{"Line":6}},{"line":275,"address":[],"length":0,"stats":{"Line":12}},{"line":276,"address":[],"length":0,"stats":{"Line":12}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":12}},{"line":281,"address":[],"length":0,"stats":{"Line":12}},{"line":282,"address":[],"length":0,"stats":{"Line":12}},{"line":284,"address":[],"length":0,"stats":{"Line":24}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":12}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":6}},{"line":326,"address":[],"length":0,"stats":{"Line":24}},{"line":327,"address":[],"length":0,"stats":{"Line":12}},{"line":329,"address":[],"length":0,"stats":{"Line":12}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":12}},{"line":334,"address":[],"length":0,"stats":{"Line":36}},{"line":339,"address":[],"length":0,"stats":{"Line":6}},{"line":340,"address":[],"length":0,"stats":{"Line":6}},{"line":341,"address":[],"length":0,"stats":{"Line":6}},{"line":342,"address":[],"length":0,"stats":{"Line":12}},{"line":343,"address":[],"length":0,"stats":{"Line":18}},{"line":346,"address":[],"length":0,"stats":{"Line":24}},{"line":347,"address":[],"length":0,"stats":{"Line":18}},{"line":351,"address":[],"length":0,"stats":{"Line":18}},{"line":352,"address":[],"length":0,"stats":{"Line":12}},{"line":353,"address":[],"length":0,"stats":{"Line":12}},{"line":354,"address":[],"length":0,"stats":{"Line":12}},{"line":356,"address":[],"length":0,"stats":{"Line":6}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}}],"covered":128,"coverable":198},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","edit","completion.rs"],"content":"use crate::core::document::Document;\nuse crate::traits::CompletionProviderTrait;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_typechecker::{Symbol, SymbolKind, TypeChecker};\n\n/// Provides code completion (IntelliSense)\n#[derive(Clone)]\npub struct CompletionProvider;\n\nimpl CompletionProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide completion items at a given position\n    pub fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Vec\u003cCompletionItem\u003e {\n        let mut items = Vec::new();\n\n        // Determine completion context from the text before the cursor\n        let context = self.get_completion_context(document, position);\n\n        match context {\n            CompletionContext::MemberAccess =\u003e {\n\n                // Would need type information from type checker\n            }\n            CompletionContext::MethodCall =\u003e {\n\n                // Would need type information from type checker\n            }\n            CompletionContext::TypeAnnotation =\u003e {\n                items.extend(self.complete_types());\n            }\n            CompletionContext::Decorator =\u003e {\n                items.extend(self.complete_decorators());\n            }\n            CompletionContext::Import =\u003e {\n\n                // Would need file system access\n            }\n            CompletionContext::Statement =\u003e {\n                // Complete keywords and identifiers\n                items.extend(self.complete_keywords());\n                // Complete symbols from type checker\n                items.extend(self.complete_symbols(document));\n            }\n        }\n\n        items\n    }\n\n    /// Determine what kind of completion is needed based on context\n    fn get_completion_context(\u0026self, document: \u0026Document, position: Position) -\u003e CompletionContext {\n        // Get the line up to the cursor position\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return CompletionContext::Statement;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return CompletionContext::Statement;\n        }\n\n        let before_cursor = \u0026line[..char_pos];\n\n        // Check for member access (.)\n        if before_cursor.ends_with('.') {\n            return CompletionContext::MemberAccess;\n        }\n\n        // Check for method call (:)\n        if before_cursor.ends_with(':') {\n            return CompletionContext::MethodCall;\n        }\n\n        // Check for decorator (@)\n        if before_cursor.trim_start().starts_with('@') {\n            return CompletionContext::Decorator;\n        }\n\n        // Check for type annotation context (after :)\n        if let Some(colon_pos) = before_cursor.rfind(':') {\n            let after_colon = \u0026before_cursor[colon_pos + 1..].trim_start();\n            // If we're right after a colon or typing a type, we're in type context\n            if after_colon.is_empty()\n                || after_colon.chars().all(|c| c.is_alphanumeric() || c == '_')\n            {\n                return CompletionContext::TypeAnnotation;\n            }\n        }\n\n        // Check for import context\n        if before_cursor.contains(\"import\") || before_cursor.contains(\"from\") {\n            return CompletionContext::Import;\n        }\n\n        CompletionContext::Statement\n    }\n\n    /// Complete TypedLua keywords\n    fn complete_keywords(\u0026self) -\u003e Vec\u003cCompletionItem\u003e {\n        let keywords = vec![\n            (\"const\", \"Constant declaration\", CompletionItemKind::KEYWORD),\n            (\n                \"local\",\n                \"Local variable declaration\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\n                \"function\",\n                \"Function declaration\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\"if\", \"If statement\", CompletionItemKind::KEYWORD),\n            (\"then\", \"Then clause\", CompletionItemKind::KEYWORD),\n            (\"else\", \"Else clause\", CompletionItemKind::KEYWORD),\n            (\"elseif\", \"Else-if clause\", CompletionItemKind::KEYWORD),\n            (\"end\", \"End block\", CompletionItemKind::KEYWORD),\n            (\"while\", \"While loop\", CompletionItemKind::KEYWORD),\n            (\"for\", \"For loop\", CompletionItemKind::KEYWORD),\n            (\"in\", \"In operator\", CompletionItemKind::KEYWORD),\n            (\"do\", \"Do block\", CompletionItemKind::KEYWORD),\n            (\"repeat\", \"Repeat loop\", CompletionItemKind::KEYWORD),\n            (\"until\", \"Until condition\", CompletionItemKind::KEYWORD),\n            (\"return\", \"Return statement\", CompletionItemKind::KEYWORD),\n            (\"break\", \"Break statement\", CompletionItemKind::KEYWORD),\n            (\n                \"continue\",\n                \"Continue statement\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\"and\", \"Logical and\", CompletionItemKind::OPERATOR),\n            (\"or\", \"Logical or\", CompletionItemKind::OPERATOR),\n            (\"not\", \"Logical not\", CompletionItemKind::OPERATOR),\n            (\"true\", \"Boolean true\", CompletionItemKind::VALUE),\n            (\"false\", \"Boolean false\", CompletionItemKind::VALUE),\n            (\"nil\", \"Nil value\", CompletionItemKind::VALUE),\n            (\n                \"type\",\n                \"Type alias declaration\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\n                \"interface\",\n                \"Interface declaration\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\"enum\", \"Enum declaration\", CompletionItemKind::ENUM),\n            (\"class\", \"Class declaration\", CompletionItemKind::CLASS),\n            (\"extends\", \"Extends clause\", CompletionItemKind::KEYWORD),\n            (\n                \"implements\",\n                \"Implements clause\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\n                \"public\",\n                \"Public access modifier\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\n                \"private\",\n                \"Private access modifier\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\n                \"protected\",\n                \"Protected access modifier\",\n                CompletionItemKind::KEYWORD,\n            ),\n            (\"static\", \"Static modifier\", CompletionItemKind::KEYWORD),\n            (\"abstract\", \"Abstract modifier\", CompletionItemKind::KEYWORD),\n            (\"readonly\", \"Readonly modifier\", CompletionItemKind::KEYWORD),\n            (\"match\", \"Match expression\", CompletionItemKind::KEYWORD),\n            (\"when\", \"When guard\", CompletionItemKind::KEYWORD),\n            (\"import\", \"Import statement\", CompletionItemKind::KEYWORD),\n            (\"from\", \"From clause\", CompletionItemKind::KEYWORD),\n            (\"export\", \"Export statement\", CompletionItemKind::KEYWORD),\n        ];\n\n        keywords\n            .into_iter()\n            .map(|(label, detail, kind)| CompletionItem {\n                label: label.to_string(),\n                kind: Some(kind),\n                detail: Some(detail.to_string()),\n                documentation: None,\n                ..Default::default()\n            })\n            .collect()\n    }\n\n    /// Complete symbols from the type checker\n    fn complete_symbols(\u0026self, document: \u0026Document) -\u003e Vec\u003cCompletionItem\u003e {\n        // Parse and type check the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let mut ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        let mut type_checker = TypeChecker::new(handler, \u0026interner, \u0026common_ids);\n        if type_checker.check_program(\u0026mut ast).is_err() {\n            // Even with errors, the symbol table may have useful information\n        }\n\n        // Get all visible symbols from the symbol table\n        let symbol_table = type_checker.symbol_table();\n        let mut items = Vec::new();\n\n        for (name, symbol) in symbol_table.all_visible_symbols() {\n            let kind = match symbol.kind {\n                SymbolKind::Const | SymbolKind::Variable =\u003e CompletionItemKind::VARIABLE,\n                SymbolKind::Function =\u003e CompletionItemKind::FUNCTION,\n                SymbolKind::Class =\u003e CompletionItemKind::CLASS,\n                SymbolKind::Interface =\u003e CompletionItemKind::INTERFACE,\n                SymbolKind::TypeAlias =\u003e CompletionItemKind::STRUCT,\n                SymbolKind::Enum =\u003e CompletionItemKind::ENUM,\n                SymbolKind::Parameter =\u003e CompletionItemKind::VARIABLE,\n                SymbolKind::Namespace =\u003e CompletionItemKind::MODULE,\n            };\n\n            items.push(CompletionItem {\n                label: name.clone(),\n                kind: Some(kind),\n                detail: Some(Self::format_symbol_detail(symbol)),\n                documentation: None,\n                ..Default::default()\n            });\n        }\n\n        items\n    }\n\n    /// Format symbol detail for completion\n    fn format_symbol_detail(symbol: \u0026Symbol) -\u003e String {\n        use typedlua_parser::ast::types::{PrimitiveType, TypeKind};\n\n        let kind_str = match symbol.kind {\n            SymbolKind::Const =\u003e \"const\",\n            SymbolKind::Variable =\u003e \"let\",\n            SymbolKind::Function =\u003e \"function\",\n            SymbolKind::Class =\u003e \"class\",\n            SymbolKind::Interface =\u003e \"interface\",\n            SymbolKind::TypeAlias =\u003e \"type\",\n            SymbolKind::Enum =\u003e \"enum\",\n            SymbolKind::Parameter =\u003e \"param\",\n            SymbolKind::Namespace =\u003e \"namespace\",\n        };\n\n        // Simple type display\n        let type_str = match \u0026symbol.typ.kind {\n            TypeKind::Primitive(PrimitiveType::Number) =\u003e \"number\",\n            TypeKind::Primitive(PrimitiveType::String) =\u003e \"string\",\n            TypeKind::Primitive(PrimitiveType::Boolean) =\u003e \"boolean\",\n            TypeKind::Primitive(PrimitiveType::Nil) =\u003e \"nil\",\n            TypeKind::Function(_) =\u003e \"function\",\n            TypeKind::Object(_) =\u003e \"object\",\n            TypeKind::Array(_) =\u003e \"array\",\n            _ =\u003e \"type\",\n        };\n\n        format!(\"{}: {}\", kind_str, type_str)\n    }\n\n    /// Complete type names\n    fn complete_types(\u0026self) -\u003e Vec\u003cCompletionItem\u003e {\n        let types = vec![\n            (\"nil\", \"Nil type\", CompletionItemKind::TYPE_PARAMETER),\n            (\n                \"boolean\",\n                \"Boolean type\",\n                CompletionItemKind::TYPE_PARAMETER,\n            ),\n            (\"number\", \"Number type\", CompletionItemKind::TYPE_PARAMETER),\n            (\"string\", \"String type\", CompletionItemKind::TYPE_PARAMETER),\n            (\n                \"unknown\",\n                \"Unknown type\",\n                CompletionItemKind::TYPE_PARAMETER,\n            ),\n            (\"never\", \"Never type\", CompletionItemKind::TYPE_PARAMETER),\n            (\"void\", \"Void type\", CompletionItemKind::TYPE_PARAMETER),\n            (\"any\", \"Any type\", CompletionItemKind::TYPE_PARAMETER),\n        ];\n\n        types\n            .into_iter()\n            .map(|(label, detail, kind)| CompletionItem {\n                label: label.to_string(),\n                kind: Some(kind),\n                detail: Some(detail.to_string()),\n                documentation: None,\n                insert_text: Some(label.to_string()),\n                ..Default::default()\n            })\n            .collect()\n    }\n\n    /// Complete decorator names\n    fn complete_decorators(\u0026self) -\u003e Vec\u003cCompletionItem\u003e {\n        let decorators = vec![\n            (\n                \"readonly\",\n                \"Make property readonly\",\n                \"TypedLua built-in decorator\",\n            ),\n            (\n                \"sealed\",\n                \"Seal class from extension\",\n                \"TypedLua built-in decorator\",\n            ),\n            (\n                \"deprecated\",\n                \"Mark as deprecated\",\n                \"TypedLua built-in decorator\",\n            ),\n        ];\n\n        decorators\n            .into_iter()\n            .map(|(label, detail, doc)| CompletionItem {\n                label: label.to_string(),\n                kind: Some(CompletionItemKind::FUNCTION),\n                detail: Some(detail.to_string()),\n                documentation: Some(Documentation::String(doc.to_string())),\n                insert_text: Some(label.to_string()),\n                ..Default::default()\n            })\n            .collect()\n    }\n\n    /// Resolve additional details for a completion item\n    #[allow(dead_code)]\n    pub fn resolve(\u0026self, item: CompletionItem) -\u003e CompletionItem {\n        // For now, just return the item as-is\n        item\n    }\n}\n\n/// Completion context type\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\nenum CompletionContext {\n    /// Completing after '.' (member access)\n    MemberAccess,\n    /// Completing after ':' (method call)\n    MethodCall,\n    /// Completing type annotations\n    TypeAnnotation,\n    /// Completing after '@' (decorators)\n    Decorator,\n    /// Completing import paths\n    Import,\n    /// General statement context (keywords, identifiers)\n    Statement,\n}\n\nimpl CompletionProviderTrait for CompletionProvider {\n    fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Vec\u003cCompletionItem\u003e {\n        Self::provide(self, document, position)\n    }\n\n    fn resolve(\u0026self, item: CompletionItem) -\u003e CompletionItem {\n        item\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":207},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","edit","mod.rs"],"content":"//! Editing assistance features\n\npub mod code_actions;\npub mod completion;\npub mod rename;\npub mod signature_help;\n\npub use code_actions::CodeActionsProvider;\npub use completion::CompletionProvider;\npub use rename::RenameProvider;\npub use signature_help::SignatureHelpProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","edit","rename.rs"],"content":"use crate::core::document::{Document, DocumentManager};\nuse lsp_types::{Uri, *};\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse typedlua_parser::ast::expression::{Expression, ExpressionKind};\nuse typedlua_parser::ast::statement::Statement;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides rename functionality\n#[derive(Clone)]\npub struct RenameProvider;\n\nimpl RenameProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Prepare a rename operation (validate rename position and provide placeholder)\n    pub fn prepare(\n        \u0026self,\n        document: \u0026Document,\n        position: Position,\n    ) -\u003e Option\u003cPrepareRenameResponse\u003e {\n        // Get the word at the current position\n        let word = self.get_word_at_position(document, position)?;\n\n        // Get the range of the word\n        let range = self.get_word_range(document, position)?;\n\n        // Return the range and current name as placeholder\n        Some(PrepareRenameResponse::RangeWithPlaceholder {\n            range,\n            placeholder: word,\n        })\n    }\n\n    /// Perform the rename operation\n    pub fn rename(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        new_name: \u0026str,\n        document_manager: \u0026DocumentManager,\n    ) -\u003e Option\u003cWorkspaceEdit\u003e {\n        // Get the word at the current position\n        let word = self.get_word_at_position(document, position)?;\n\n        // Validate the new name\n        if !self.is_valid_identifier(new_name) {\n            return None;\n        }\n\n        // Parse the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = parser.parse().ok()?;\n\n        // Create a map to store edits for each file\n        let mut all_edits: HashMap\u003cUri, Vec\u003cTextEdit\u003e\u003e = HashMap::new();\n\n        // Find all occurrences in the current file (including declaration)\n        let mut current_file_occurrences = Vec::new();\n        self.find_all_occurrences(\n            \u0026ast.statements,\n            \u0026word,\n            \u0026mut current_file_occurrences,\n            \u0026interner,\n        );\n\n        // Find the declaration to include it\n        if let Some(decl_span) = self.find_declaration(\u0026ast.statements, \u0026word, \u0026interner) {\n            current_file_occurrences.push(decl_span);\n        }\n\n        // Convert spans to text edits for current file\n        let current_edits: Vec\u003cTextEdit\u003e = current_file_occurrences\n            .into_iter()\n            .map(|span| TextEdit {\n                range: span_to_range(\u0026span),\n                new_text: new_name.to_string(),\n            })\n            .collect();\n\n        all_edits.insert(uri.clone(), current_edits);\n\n        // Check if this symbol is exported - if so, rename in all importing files\n        if self.is_symbol_exported(\u0026ast.statements, \u0026word, \u0026interner) {\n            if let Some(module_id) = \u0026document.module_id {\n                self.collect_renames_in_importing_files(\n                    module_id,\n                    \u0026word,\n                    new_name,\n                    document_manager,\n                    \u0026mut all_edits,\n                );\n            }\n        }\n\n        // Check if this symbol is imported - if so, rename in the source file\n        if let Some((source_uri, exported_name)) = self.find_import_source(\n            \u0026ast.statements,\n            \u0026word,\n            document,\n            document_manager,\n            \u0026interner,\n        ) {\n            if let Some(source_doc) = document_manager.get(\u0026source_uri) {\n                // Parse source document\n                let handler = Arc::new(CollectingDiagnosticHandler::new());\n                let mut lexer = Lexer::new(\u0026source_doc.text, handler.clone(), \u0026interner);\n                if let Ok(tokens) = lexer.tokenize() {\n                    let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n                    if let Ok(ast) = parser.parse() {\n                        let mut source_occurrences = Vec::new();\n                        self.find_all_occurrences(\n                            \u0026ast.statements,\n                            \u0026exported_name,\n                            \u0026mut source_occurrences,\n                            \u0026interner,\n                        );\n\n                        // Include declaration in source file\n                        if let Some(decl_span) =\n                            self.find_declaration(\u0026ast.statements, \u0026exported_name, \u0026interner)\n                        {\n                            source_occurrences.push(decl_span);\n                        }\n\n                        // Convert to text edits\n                        let source_edits: Vec\u003cTextEdit\u003e = source_occurrences\n                            .into_iter()\n                            .map(|span| TextEdit {\n                                range: span_to_range(\u0026span),\n                                new_text: new_name.to_string(),\n                            })\n                            .collect();\n\n                        all_edits.insert(source_uri, source_edits);\n                    }\n                }\n            }\n        }\n\n        // Create workspace edit\n        Some(WorkspaceEdit {\n            changes: Some(all_edits),\n            document_changes: None,\n            change_annotations: None,\n        })\n    }\n\n    /// Check if a symbol is exported from the file\n    fn is_symbol_exported(\n        \u0026self,\n        statements: \u0026[Statement],\n        symbol_name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e bool {\n        use typedlua_parser::ast::statement::ExportKind;\n\n        for stmt in statements {\n            if let Statement::Export(export_decl) = stmt {\n                match \u0026export_decl.kind {\n                    ExportKind::Declaration(decl) =\u003e {\n                        if self\n                            .get_declaration_name_span(decl, symbol_name, interner)\n                            .is_some()\n                        {\n                            return true;\n                        }\n                    }\n                    ExportKind::Named {\n                        specifiers,\n                        source: _,\n                    } =\u003e {\n                        for spec in specifiers {\n                            let exported_name = spec.exported.as_ref().unwrap_or(\u0026spec.local);\n                            if interner.resolve(exported_name.node) == symbol_name\n                                || interner.resolve(spec.local.node) == symbol_name\n                            {\n                                return true;\n                            }\n                        }\n                    }\n                    ExportKind::Default(_) if symbol_name == \"default\" =\u003e {\n                        return true;\n                    }\n                    _ =\u003e {}\n                }\n            }\n        }\n        false\n    }\n\n    /// Get the declaration name span from a statement\n    fn get_declaration_name_span(\n        \u0026self,\n        stmt: \u0026Statement,\n        name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSpan\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    if interner.resolve(ident.node) == name {\n                        return Some(ident.span);\n                    }\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                if interner.resolve(func_decl.name.node) == name {\n                    return Some(func_decl.name.span);\n                }\n            }\n            Statement::Class(class_decl) =\u003e {\n                if interner.resolve(class_decl.name.node) == name {\n                    return Some(class_decl.name.span);\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                if interner.resolve(interface_decl.name.node) == name {\n                    return Some(interface_decl.name.span);\n                }\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                if interner.resolve(type_decl.name.node) == name {\n                    return Some(type_decl.name.span);\n                }\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                if interner.resolve(enum_decl.name.node) == name {\n                    return Some(enum_decl.name.span);\n                }\n            }\n            _ =\u003e {}\n        }\n        None\n    }\n\n    /// Collect rename edits in files that import from the current module\n    fn collect_renames_in_importing_files(\n        \u0026self,\n        module_id: \u0026typedlua_typechecker::module_resolver::ModuleId,\n        symbol_name: \u0026str,\n        new_name: \u0026str,\n        document_manager: \u0026DocumentManager,\n        all_edits: \u0026mut HashMap\u003cUri, Vec\u003cTextEdit\u003e\u003e,\n    ) {\n        // Use symbol index to quickly find all files that import this symbol\n        let importing_uris = document_manager\n            .symbol_index()\n            .get_importers(module_id.as_str(), symbol_name);\n\n        // For each importing file, find and rename all occurrences of the local name\n        for uri in importing_uris {\n            if let Some(doc) = document_manager.get(\u0026uri) {\n                // Get the document's module ID\n                if let Some(doc_module_id) = \u0026doc.module_id {\n                    // Use symbol index to get import info\n                    if let Some(imports) = document_manager\n                        .symbol_index()\n                        .get_imports(doc_module_id.as_str(), symbol_name)\n                    {\n                        for import_info in imports {\n                            // Check if this import is from our source module\n                            if let Some(source_module_id) =\n                                document_manager.uri_to_module_id(\u0026import_info.source_uri)\n                            {\n                                if source_module_id == module_id\n                                    \u0026\u0026 import_info.imported_name == symbol_name\n                                {\n                                    // Parse the document to find all occurrences\n                                    if let Some((ast, interner, _)) = doc.get_or_parse_ast() {\n                                        let mut occurrences = Vec::new();\n                                        self.find_all_occurrences(\n                                            \u0026ast.statements,\n                                            \u0026import_info.local_name,\n                                            \u0026mut occurrences,\n                                            \u0026*interner,\n                                        );\n\n                                        // Convert to text edits\n                                        let edits: Vec\u003cTextEdit\u003e = occurrences\n                                            .into_iter()\n                                            .map(|span| TextEdit {\n                                                range: span_to_range(\u0026span),\n                                                new_text: new_name.to_string(),\n                                            })\n                                            .collect();\n\n                                        if !edits.is_empty() {\n                                            all_edits.insert(uri.clone(), edits);\n                                        }\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /// Find the source file and exported name for an imported symbol\n    fn find_import_source(\n        \u0026self,\n        statements: \u0026[Statement],\n        symbol_name: \u0026str,\n        current_document: \u0026Document,\n        document_manager: \u0026DocumentManager,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003c(Uri, String)\u003e {\n        use typedlua_parser::ast::statement::ImportClause;\n\n        for stmt in statements {\n            if let Statement::Import(import_decl) = stmt {\n                let import_source = \u0026import_decl.source;\n\n                // Check if this import contains our symbol\n                let exported_name = match \u0026import_decl.clause {\n                    ImportClause::Named(specs) =\u003e specs.iter().find_map(|spec| {\n                        let local_name = spec.local.as_ref().unwrap_or(\u0026spec.imported);\n                        if interner.resolve(local_name.node) == symbol_name {\n                            Some(interner.resolve(spec.imported.node).to_string())\n                        } else {\n                            None\n                        }\n                    }),\n                    ImportClause::Default(ident) =\u003e {\n                        if interner.resolve(ident.node) == symbol_name {\n                            Some(\"default\".to_string())\n                        } else {\n                            None\n                        }\n                    }\n                    ImportClause::Namespace(ident) =\u003e {\n                        if interner.resolve(ident.node) == symbol_name {\n                            None // Skip namespace imports for now\n                        } else {\n                            None\n                        }\n                    }\n                    ImportClause::TypeOnly(_) =\u003e None,\n                    ImportClause::Mixed { default, named } =\u003e {\n                        // Check default import first\n                        if interner.resolve(default.node) == symbol_name {\n                            Some(\"default\".to_string())\n                        } else {\n                            // Check named imports\n                            named.iter().find_map(|spec| {\n                                let local_name = spec.local.as_ref().unwrap_or(\u0026spec.imported);\n                                if interner.resolve(local_name.node) == symbol_name {\n                                    Some(interner.resolve(spec.imported.node).to_string())\n                                } else {\n                                    None\n                                }\n                            })\n                        }\n                    }\n                };\n\n                if let Some(exported_name) = exported_name {\n                    // Resolve the import path\n                    if let Some(module_id) = \u0026current_document.module_id {\n                        let resolver = document_manager.module_resolver();\n                        {\n                            if let Ok(target_module_id) = resolver\n                                .resolve(import_source, std::path::Path::new(module_id.as_str()))\n                            {\n                                if let Some(target_uri) =\n                                    document_manager.module_id_to_uri(\u0026target_module_id)\n                                {\n                                    return Some((target_uri.clone(), exported_name));\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        None\n    }\n\n    /// Validate that a name is a valid identifier\n    fn is_valid_identifier(\u0026self, name: \u0026str) -\u003e bool {\n        if name.is_empty() {\n            return false;\n        }\n\n        // Check first character (must be letter or underscore)\n        let mut chars = name.chars();\n        if let Some(first) = chars.next() {\n            if !first.is_alphabetic() \u0026\u0026 first != '_' {\n                return false;\n            }\n        } else {\n            return false;\n        }\n\n        // Check remaining characters (letter, digit, or underscore)\n        for ch in chars {\n            if !ch.is_alphanumeric() \u0026\u0026 ch != '_' {\n                return false;\n            }\n        }\n\n        // Check if it's a reserved keyword\n        if self.is_keyword(name) {\n            return false;\n        }\n\n        true\n    }\n\n    /// Check if a name is a reserved keyword\n    fn is_keyword(\u0026self, name: \u0026str) -\u003e bool {\n        matches!(\n            name,\n            \"const\"\n                | \"local\"\n                | \"function\"\n                | \"if\"\n                | \"then\"\n                | \"else\"\n                | \"elseif\"\n                | \"end\"\n                | \"while\"\n                | \"for\"\n                | \"in\"\n                | \"do\"\n                | \"repeat\"\n                | \"until\"\n                | \"return\"\n                | \"break\"\n                | \"continue\"\n                | \"and\"\n                | \"or\"\n                | \"not\"\n                | \"true\"\n                | \"false\"\n                | \"nil\"\n                | \"type\"\n                | \"interface\"\n                | \"enum\"\n                | \"class\"\n                | \"extends\"\n                | \"implements\"\n                | \"public\"\n                | \"private\"\n                | \"protected\"\n                | \"static\"\n                | \"abstract\"\n                | \"readonly\"\n                | \"match\"\n                | \"when\"\n                | \"import\"\n                | \"from\"\n                | \"export\"\n        )\n    }\n\n    /// Get the word at the cursor position\n    fn get_word_at_position(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        // Find word boundaries\n        let chars: Vec\u003cchar\u003e = line.chars().collect();\n        if char_pos \u003e= chars.len() {\n            return None;\n        }\n\n        // Check if we're on a word character\n        if !chars[char_pos].is_alphanumeric() \u0026\u0026 chars[char_pos] != '_' {\n            return None;\n        }\n\n        // Find start of word\n        let mut start = char_pos;\n        while start \u003e 0 \u0026\u0026 (chars[start - 1].is_alphanumeric() || chars[start - 1] == '_') {\n            start -= 1;\n        }\n\n        // Find end of word\n        let mut end = char_pos;\n        while end \u003c chars.len() \u0026\u0026 (chars[end].is_alphanumeric() || chars[end] == '_') {\n            end += 1;\n        }\n\n        Some(chars[start..end].iter().collect())\n    }\n\n    /// Get the range of the word at the cursor position\n    fn get_word_range(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cRange\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        // Find word boundaries\n        let chars: Vec\u003cchar\u003e = line.chars().collect();\n        if char_pos \u003e= chars.len() {\n            return None;\n        }\n\n        // Check if we're on a word character\n        if !chars[char_pos].is_alphanumeric() \u0026\u0026 chars[char_pos] != '_' {\n            return None;\n        }\n\n        // Find start of word\n        let mut start = char_pos;\n        while start \u003e 0 \u0026\u0026 (chars[start - 1].is_alphanumeric() || chars[start - 1] == '_') {\n            start -= 1;\n        }\n\n        // Find end of word\n        let mut end = char_pos;\n        while end \u003c chars.len() \u0026\u0026 (chars[end].is_alphanumeric() || chars[end] == '_') {\n            end += 1;\n        }\n\n        Some(Range {\n            start: Position {\n                line: position.line,\n                character: start as u32,\n            },\n            end: Position {\n                line: position.line,\n                character: end as u32,\n            },\n        })\n    }\n\n    /// Find the declaration span for a given symbol name\n    fn find_declaration(\n        \u0026self,\n        statements: \u0026[Statement],\n        name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSpan\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        for stmt in statements {\n            match stmt {\n                Statement::Variable(var_decl) =\u003e {\n                    if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                        if interner.resolve(ident.node) == name {\n                            return Some(ident.span);\n                        }\n                    }\n                }\n                Statement::Function(func_decl) =\u003e {\n                    if interner.resolve(func_decl.name.node) == name {\n                        return Some(func_decl.name.span);\n                    }\n                }\n                Statement::Class(class_decl) =\u003e {\n                    if interner.resolve(class_decl.name.node) == name {\n                        return Some(class_decl.name.span);\n                    }\n                }\n                Statement::Interface(interface_decl) =\u003e {\n                    if interner.resolve(interface_decl.name.node) == name {\n                        return Some(interface_decl.name.span);\n                    }\n                }\n                Statement::TypeAlias(type_decl) =\u003e {\n                    if interner.resolve(type_decl.name.node) == name {\n                        return Some(type_decl.name.span);\n                    }\n                }\n                Statement::Enum(enum_decl) =\u003e {\n                    if interner.resolve(enum_decl.name.node) == name {\n                        return Some(enum_decl.name.span);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        None\n    }\n\n    /// Find all occurrences of a symbol\n    fn find_all_occurrences(\n        \u0026self,\n        statements: \u0026[Statement],\n        name: \u0026str,\n        refs: \u0026mut Vec\u003cSpan\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            self.find_occurrences_in_statement(stmt, name, refs, interner);\n        }\n    }\n\n    fn find_occurrences_in_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        name: \u0026str,\n        refs: \u0026mut Vec\u003cSpan\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match stmt {\n            Statement::Expression(expr) =\u003e {\n                self.find_occurrences_in_expression(expr, name, refs, interner);\n            }\n            Statement::Variable(var_decl) =\u003e {\n                self.find_occurrences_in_expression(\u0026var_decl.initializer, name, refs, interner);\n            }\n            Statement::Function(func_decl) =\u003e {\n                for stmt in \u0026func_decl.body.statements {\n                    self.find_occurrences_in_statement(stmt, name, refs, interner);\n                }\n            }\n            Statement::If(if_stmt) =\u003e {\n                self.find_occurrences_in_expression(\u0026if_stmt.condition, name, refs, interner);\n                self.find_all_occurrences(\u0026if_stmt.then_block.statements, name, refs, interner);\n                for else_if in \u0026if_stmt.else_ifs {\n                    self.find_occurrences_in_expression(\u0026else_if.condition, name, refs, interner);\n                    self.find_all_occurrences(\u0026else_if.block.statements, name, refs, interner);\n                }\n                if let Some(else_block) = \u0026if_stmt.else_block {\n                    self.find_all_occurrences(\u0026else_block.statements, name, refs, interner);\n                }\n            }\n            Statement::While(while_stmt) =\u003e {\n                self.find_occurrences_in_expression(\u0026while_stmt.condition, name, refs, interner);\n                self.find_all_occurrences(\u0026while_stmt.body.statements, name, refs, interner);\n            }\n            Statement::Return(ret) =\u003e {\n                for expr in \u0026ret.values {\n                    self.find_occurrences_in_expression(expr, name, refs, interner);\n                }\n            }\n            Statement::Block(block) =\u003e {\n                self.find_all_occurrences(\u0026block.statements, name, refs, interner);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    fn find_occurrences_in_expression(\n        \u0026self,\n        expr: \u0026Expression,\n        name: \u0026str,\n        refs: \u0026mut Vec\u003cSpan\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match \u0026expr.kind {\n            ExpressionKind::Identifier(ident) =\u003e {\n                if interner.resolve(*ident) == name {\n                    refs.push(expr.span);\n                }\n            }\n            ExpressionKind::Binary(_, left, right) =\u003e {\n                self.find_occurrences_in_expression(left, name, refs, interner);\n                self.find_occurrences_in_expression(right, name, refs, interner);\n            }\n            ExpressionKind::Unary(_, operand) =\u003e {\n                self.find_occurrences_in_expression(operand, name, refs, interner);\n            }\n            ExpressionKind::Call(callee, args, _typeargs) =\u003e {\n                self.find_occurrences_in_expression(callee, name, refs, interner);\n                for arg in args {\n                    self.find_occurrences_in_expression(\u0026arg.value, name, refs, interner);\n                }\n            }\n            ExpressionKind::Member(object, _) =\u003e {\n                self.find_occurrences_in_expression(object, name, refs, interner);\n            }\n            ExpressionKind::Index(object, index) =\u003e {\n                self.find_occurrences_in_expression(object, name, refs, interner);\n                self.find_occurrences_in_expression(index, name, refs, interner);\n            }\n            ExpressionKind::Assignment(target, _, value) =\u003e {\n                self.find_occurrences_in_expression(target, name, refs, interner);\n                self.find_occurrences_in_expression(value, name, refs, interner);\n            }\n            ExpressionKind::Conditional(condition, then_expr, else_expr) =\u003e {\n                self.find_occurrences_in_expression(condition, name, refs, interner);\n                self.find_occurrences_in_expression(then_expr, name, refs, interner);\n                self.find_occurrences_in_expression(else_expr, name, refs, interner);\n            }\n            ExpressionKind::Parenthesized(inner) =\u003e {\n                self.find_occurrences_in_expression(inner, name, refs, interner);\n            }\n            _ =\u003e {}\n        }\n    }\n}\n\n/// Convert a Span to an LSP Range\nfn span_to_range(span: \u0026Span) -\u003e Range {\n    Range {\n        start: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: (span.column.saturating_sub(1)) as u32,\n        },\n        end: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: ((span.column + span.len()).saturating_sub(1)) as u32,\n        },\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":321},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","edit","signature_help.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_typechecker::TypeChecker;\n\n/// Provides signature help (parameter info while typing function calls)\n#[derive(Clone)]\npub struct SignatureHelpProvider;\n\nimpl SignatureHelpProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide signature help at the given position\n    pub fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cSignatureHelp\u003e {\n        // Get the text before the cursor to analyze context\n        let (function_name, active_parameter) = self.analyze_call_context(document, position)?;\n\n        // Parse and type check the document to get function signature\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let mut ast = parser.parse().ok()?;\n\n        let mut type_checker = TypeChecker::new(handler, \u0026interner, \u0026common_ids);\n        type_checker.check_program(\u0026mut ast).ok()?;\n\n        // Look up the function symbol\n        let symbol = type_checker.lookup_symbol(\u0026function_name)?;\n\n        // Format the signature\n        let signature = self.format_signature(\u0026function_name, symbol, \u0026interner)?;\n\n        Some(SignatureHelp {\n            signatures: vec![signature],\n            active_signature: Some(0),\n            active_parameter: Some(active_parameter),\n        })\n    }\n\n    /// Analyze the call context to determine function name and active parameter\n    fn analyze_call_context(\n        \u0026self,\n        document: \u0026Document,\n        position: Position,\n    ) -\u003e Option\u003c(String, u32)\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        // Get text before cursor\n        let text_before = \u0026line[..char_pos];\n\n        // Find the opening paren going backwards\n        let mut paren_count = 0;\n        let mut call_start = None;\n\n        for (i, ch) in text_before.char_indices().rev() {\n            match ch {\n                ')' =\u003e paren_count += 1,\n                '(' =\u003e {\n                    if paren_count == 0 {\n                        call_start = Some(i);\n                        break;\n                    }\n                    paren_count -= 1;\n                }\n                _ =\u003e {}\n            }\n        }\n\n        let call_start = call_start?;\n\n        // Extract function name before the '('\n        let text_before_paren = \u0026text_before[..call_start].trim_end();\n        let function_name = text_before_paren\n            .split(|c: char| !c.is_alphanumeric() \u0026\u0026 c != '_' \u0026\u0026 c != ':')\n            .last()?\n            .to_string();\n\n        if function_name.is_empty() {\n            return None;\n        }\n\n        // Count commas to determine active parameter (excluding nested calls)\n        let text_in_call = \u0026text_before[call_start + 1..];\n        let active_parameter = self.count_parameters(text_in_call);\n\n        Some((function_name, active_parameter))\n    }\n\n    /// Count the number of commas (parameters) considering nesting\n    fn count_parameters(\u0026self, text: \u0026str) -\u003e u32 {\n        let mut count = 0;\n        let mut paren_depth = 0;\n        let mut bracket_depth = 0;\n        let mut in_string = false;\n        let mut string_char = '\\0';\n\n        for ch in text.chars() {\n            match ch {\n                '\"' | '\\'' if !in_string =\u003e {\n                    in_string = true;\n                    string_char = ch;\n                }\n                c if in_string \u0026\u0026 c == string_char =\u003e {\n                    in_string = false;\n                }\n                '(' if !in_string =\u003e paren_depth += 1,\n                ')' if !in_string =\u003e paren_depth -= 1,\n                '[' if !in_string =\u003e bracket_depth += 1,\n                ']' if !in_string =\u003e bracket_depth -= 1,\n                ',' if !in_string \u0026\u0026 paren_depth == 0 \u0026\u0026 bracket_depth == 0 =\u003e count += 1,\n                _ =\u003e {}\n            }\n        }\n\n        count\n    }\n\n    /// Format a signature from a symbol\n    fn format_signature(\n        \u0026self,\n        name: \u0026str,\n        symbol: \u0026typedlua_typechecker::Symbol,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSignatureInformation\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n        use typedlua_parser::ast::types::TypeKind;\n\n        // Check if the type is a function\n        if let TypeKind::Function(func_type) = \u0026symbol.typ.kind {\n            let mut parameters = Vec::new();\n\n            for (i, param) in func_type.parameters.iter().enumerate() {\n                let param_name = if let Pattern::Identifier(ident) = \u0026param.pattern {\n                    interner.resolve(ident.node).to_string()\n                } else {\n                    format!(\"param{}\", i)\n                };\n\n                let param_type = if let Some(ref type_ann) = param.type_annotation {\n                    self.format_type_simple(type_ann, interner)\n                } else {\n                    \"unknown\".to_string()\n                };\n\n                parameters.push(ParameterInformation {\n                    label: ParameterLabel::Simple(format!(\"{}: {}\", param_name, param_type)),\n                    documentation: None,\n                });\n            }\n\n            let return_type = self.format_type_simple(\u0026func_type.return_type, interner);\n\n            let label = format!(\"function {}(...): {}\", name, return_type);\n\n            Some(SignatureInformation {\n                label,\n                documentation: None,\n                parameters: Some(parameters),\n                active_parameter: None,\n            })\n        } else {\n            None\n        }\n    }\n\n    /// Simple type formatting\n    fn format_type_simple(\n        \u0026self,\n        typ: \u0026typedlua_parser::ast::types::Type,\n        interner: \u0026StringInterner,\n    ) -\u003e String {\n        use typedlua_parser::ast::types::{PrimitiveType, TypeKind};\n\n        match \u0026typ.kind {\n            TypeKind::Primitive(PrimitiveType::Nil) =\u003e \"nil\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Boolean) =\u003e \"boolean\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Number) =\u003e \"number\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Integer) =\u003e \"integer\".to_string(),\n            TypeKind::Primitive(PrimitiveType::String) =\u003e \"string\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Unknown) =\u003e \"unknown\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Never) =\u003e \"never\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Void) =\u003e \"void\".to_string(),\n            TypeKind::Reference(type_ref) =\u003e interner.resolve(type_ref.name.node).to_string(),\n            TypeKind::Function(_) =\u003e \"function\".to_string(),\n            _ =\u003e \"unknown\".to_string(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_signature_help_scenarios() {\n        let provider = SignatureHelpProvider::new();\n\n        // Test simple function call\n        let doc = Document::new_test(\"foo(\".to_string(), 1);\n        let result = provider.analyze_call_context(\n            \u0026doc,\n            Position {\n                line: 0,\n                character: 4,\n            },\n        );\n        assert!(result.is_some());\n        let (func_name, param) = result.unwrap();\n        assert_eq!(func_name, \"foo\");\n        assert_eq!(param, 0);\n\n        // Test multiple parameters with cursor after first comma\n        let doc = Document::new_test(\"foo(a, \".to_string(), 1);\n        let result = provider.analyze_call_context(\n            \u0026doc,\n            Position {\n                line: 0,\n                character: 7,\n            },\n        );\n        assert!(result.is_some());\n        let (func_name, param) = result.unwrap();\n        assert_eq!(func_name, \"foo\");\n        assert_eq!(param, 1);\n\n        // Test method calls\n        let doc = Document::new_test(\"obj:method(\".to_string(), 1);\n        let result = provider.analyze_call_context(\n            \u0026doc,\n            Position {\n                line: 0,\n                character: 11,\n            },\n        );\n        assert!(result.is_some());\n        let (func_name, param) = result.unwrap();\n        // May extract full \"obj:method\" or just \"method\" depending on implementation\n        assert!(func_name.contains(\"method\"));\n        assert_eq!(param, 0);\n    }\n\n    #[test]\n    fn test_parameter_detection() {\n        let provider = SignatureHelpProvider::new();\n\n        // Test \"foo(|)\" -\u003e parameter 0\n        assert_eq!(provider.count_parameters(\"\"), 0);\n\n        // Test \"foo(a, |)\" -\u003e parameter 1\n        assert_eq!(provider.count_parameters(\"a, \"), 1);\n\n        // Test \"foo(a, b, |)\" -\u003e parameter 2\n        assert_eq!(provider.count_parameters(\"a, b, \"), 2);\n\n        // Test \"foo(bar(x), |)\" -\u003e parameter 1 (not confused by nested call)\n        assert_eq!(provider.count_parameters(\"bar(x), \"), 1);\n\n        // Test \"foo('a, b', |)\" -\u003e parameter 1 (not confused by comma in string)\n        assert_eq!(provider.count_parameters(\"'a, b', \"), 1);\n\n        // Test \"foo(\\\"a, b\\\", |)\" -\u003e parameter 1 (double quotes)\n        assert_eq!(provider.count_parameters(\"\\\"a, b\\\", \"), 1);\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":4}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":6}},{"line":54,"address":[],"length":0,"stats":{"Line":24}},{"line":55,"address":[],"length":0,"stats":{"Line":12}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":12}},{"line":60,"address":[],"length":0,"stats":{"Line":12}},{"line":61,"address":[],"length":0,"stats":{"Line":12}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":12}},{"line":69,"address":[],"length":0,"stats":{"Line":12}},{"line":70,"address":[],"length":0,"stats":{"Line":12}},{"line":72,"address":[],"length":0,"stats":{"Line":42}},{"line":73,"address":[],"length":0,"stats":{"Line":12}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":6}},{"line":78,"address":[],"length":0,"stats":{"Line":6}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":12}},{"line":89,"address":[],"length":0,"stats":{"Line":12}},{"line":90,"address":[],"length":0,"stats":{"Line":12}},{"line":91,"address":[],"length":0,"stats":{"Line":42}},{"line":95,"address":[],"length":0,"stats":{"Line":12}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":12}},{"line":101,"address":[],"length":0,"stats":{"Line":24}},{"line":103,"address":[],"length":0,"stats":{"Line":6}},{"line":107,"address":[],"length":0,"stats":{"Line":18}},{"line":108,"address":[],"length":0,"stats":{"Line":36}},{"line":109,"address":[],"length":0,"stats":{"Line":36}},{"line":110,"address":[],"length":0,"stats":{"Line":36}},{"line":111,"address":[],"length":0,"stats":{"Line":36}},{"line":112,"address":[],"length":0,"stats":{"Line":36}},{"line":114,"address":[],"length":0,"stats":{"Line":108}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":6}},{"line":117,"address":[],"length":0,"stats":{"Line":4}},{"line":118,"address":[],"length":0,"stats":{"Line":4}},{"line":120,"address":[],"length":0,"stats":{"Line":100}},{"line":121,"address":[],"length":0,"stats":{"Line":4}},{"line":123,"address":[],"length":0,"stats":{"Line":4}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":74}},{"line":128,"address":[],"length":0,"stats":{"Line":46}},{"line":132,"address":[],"length":0,"stats":{"Line":18}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}}],"covered":43,"coverable":100},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","formatting","formatting.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\n\nuse std::sync::Arc;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides code formatting functionality\n#[derive(Clone)]\npub struct FormattingProvider;\n\nimpl FormattingProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Format the entire document\n    pub fn format_document(\n        \u0026self,\n        document: \u0026Document,\n        options: FormattingOptions,\n    ) -\u003e Vec\u003cTextEdit\u003e {\n        // Parse the document to ensure it's valid\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return Vec::new(), // Don't format invalid code\n        };\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let _ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return Vec::new(), // Don't format invalid code\n        };\n\n        // Apply basic formatting fixes\n        let mut edits = Vec::new();\n\n        // Fix indentation and trailing whitespace\n        self.fix_indentation_and_whitespace(document, options, \u0026mut edits);\n\n        edits\n    }\n\n    /// Format a specific range in the document\n    pub fn format_range(\n        \u0026self,\n        document: \u0026Document,\n        range: Range,\n        options: FormattingOptions,\n    ) -\u003e Vec\u003cTextEdit\u003e {\n        // Parse the document to ensure it's valid\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let _ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        // Apply formatting only within the specified range\n        let mut edits = Vec::new();\n        self.fix_indentation_in_range(document, range, options, \u0026mut edits);\n\n        edits\n    }\n\n    /// Format text as the user types (on-type formatting)\n    pub fn format_on_type(\n        \u0026self,\n        document: \u0026Document,\n        position: Position,\n        ch: \u0026str,\n        options: FormattingOptions,\n    ) -\u003e Vec\u003cTextEdit\u003e {\n        let mut edits = Vec::new();\n\n        // When user types 'end', auto-indent the line\n        if ch == \"d\" {\n            let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n            if position.line as usize \u003e= lines.len() {\n                return edits;\n            }\n\n            let line = lines[position.line as usize];\n            let trimmed = line.trim();\n\n            if trimmed == \"end\" {\n                // Calculate correct indentation for 'end'\n                if let Some(indent_level) =\n                    self.calculate_end_indent(document, position.line as usize)\n                {\n                    let indent = self.make_indent(indent_level, \u0026options);\n\n                    edits.push(TextEdit {\n                        range: Range {\n                            start: Position {\n                                line: position.line,\n                                character: 0,\n                            },\n                            end: Position {\n                                line: position.line,\n                                character: line.len() as u32,\n                            },\n                        },\n                        new_text: format!(\"{}end\", indent),\n                    });\n                }\n            }\n        }\n\n        edits\n    }\n\n    // Helper methods\n\n    /// Fix indentation and trailing whitespace\n    fn fix_indentation_and_whitespace(\n        \u0026self,\n        document: \u0026Document,\n        options: FormattingOptions,\n        edits: \u0026mut Vec\u003cTextEdit\u003e,\n    ) {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        let mut indent_level: usize = 0;\n\n        for (line_num, line) in lines.iter().enumerate() {\n            let trimmed = line.trim();\n\n            // Skip empty lines\n            if trimmed.is_empty() {\n                // Remove trailing whitespace from empty lines\n                if !line.is_empty() {\n                    edits.push(TextEdit {\n                        range: Range {\n                            start: Position {\n                                line: line_num as u32,\n                                character: 0,\n                            },\n                            end: Position {\n                                line: line_num as u32,\n                                character: line.len() as u32,\n                            },\n                        },\n                        new_text: String::new(),\n                    });\n                }\n                continue;\n            }\n\n            // Decrease indent for closing keywords\n            if trimmed.starts_with(\"end\")\n                || trimmed.starts_with(\"else\")\n                || trimmed.starts_with(\"elseif\")\n            {\n                indent_level = indent_level.saturating_sub(1);\n            }\n\n            // Calculate expected indentation\n            let expected_indent = self.make_indent(indent_level, \u0026options);\n            let current_indent: String = line.chars().take_while(|c| c.is_whitespace()).collect();\n\n            // Only add edit if indentation is wrong\n            if expected_indent != current_indent {\n                edits.push(TextEdit {\n                    range: Range {\n                        start: Position {\n                            line: line_num as u32,\n                            character: 0,\n                        },\n                        end: Position {\n                            line: line_num as u32,\n                            character: current_indent.len() as u32,\n                        },\n                    },\n                    new_text: expected_indent.clone(),\n                });\n            }\n\n            // Remove trailing whitespace\n            if let Some(trailing_ws_start) = line.rfind(|c: char| !c.is_whitespace()) {\n                let trailing_ws_start = trailing_ws_start + 1;\n                if trailing_ws_start \u003c line.len() {\n                    edits.push(TextEdit {\n                        range: Range {\n                            start: Position {\n                                line: line_num as u32,\n                                character: trailing_ws_start as u32,\n                            },\n                            end: Position {\n                                line: line_num as u32,\n                                character: line.len() as u32,\n                            },\n                        },\n                        new_text: String::new(),\n                    });\n                }\n            }\n\n            // Increase indent for opening keywords\n            if trimmed.starts_with(\"function\")\n                || trimmed.starts_with(\"if\")\n                || trimmed.starts_with(\"while\")\n                || trimmed.starts_with(\"for\")\n                || trimmed.starts_with(\"class\")\n                || trimmed.starts_with(\"interface\")\n                || (trimmed.starts_with(\"else\") \u0026\u0026 !trimmed.starts_with(\"elseif\"))\n            {\n                indent_level += 1;\n            }\n        }\n    }\n\n    /// Fix indentation within a specific range\n    fn fix_indentation_in_range(\n        \u0026self,\n        document: \u0026Document,\n        range: Range,\n        options: FormattingOptions,\n        edits: \u0026mut Vec\u003cTextEdit\u003e,\n    ) {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n\n        // Calculate the indent level at the start of the range\n        let mut indent_level = self.calculate_indent_level(document, range.start.line as usize);\n\n        for line_num in range.start.line..=range.end.line {\n            let line_num = line_num as usize;\n            if line_num \u003e= lines.len() {\n                break;\n            }\n\n            let line = lines[line_num];\n            let trimmed = line.trim();\n\n            if trimmed.is_empty() {\n                continue;\n            }\n\n            // Decrease indent for closing keywords\n            if trimmed.starts_with(\"end\")\n                || trimmed.starts_with(\"else\")\n                || trimmed.starts_with(\"elseif\")\n            {\n                indent_level = indent_level.saturating_sub(1);\n            }\n\n            // Calculate expected indentation\n            let expected_indent = self.make_indent(indent_level, \u0026options);\n            let current_indent: String = line.chars().take_while(|c| c.is_whitespace()).collect();\n\n            // Only add edit if indentation is wrong\n            if expected_indent != current_indent {\n                edits.push(TextEdit {\n                    range: Range {\n                        start: Position {\n                            line: line_num as u32,\n                            character: 0,\n                        },\n                        end: Position {\n                            line: line_num as u32,\n                            character: current_indent.len() as u32,\n                        },\n                    },\n                    new_text: expected_indent.clone(),\n                });\n            }\n\n            // Increase indent for opening keywords\n            if trimmed.starts_with(\"function\")\n                || trimmed.starts_with(\"if\")\n                || trimmed.starts_with(\"while\")\n                || trimmed.starts_with(\"for\")\n                || trimmed.starts_with(\"class\")\n                || trimmed.starts_with(\"interface\")\n                || (trimmed.starts_with(\"else\") \u0026\u0026 !trimmed.starts_with(\"elseif\"))\n            {\n                indent_level += 1;\n            }\n        }\n    }\n\n    /// Calculate the indent level at a given line\n    fn calculate_indent_level(\u0026self, document: \u0026Document, target_line: usize) -\u003e usize {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        let mut level: usize = 0;\n\n        for line_num in 0..=target_line.min(lines.len().saturating_sub(1)) {\n            let trimmed = lines[line_num].trim();\n\n            if trimmed.is_empty() {\n                continue;\n            }\n\n            // Decrease for closing keywords\n            if trimmed.starts_with(\"end\")\n                || trimmed.starts_with(\"else\")\n                || trimmed.starts_with(\"elseif\")\n            {\n                level = level.saturating_sub(1);\n            }\n\n            // Don't count the target line for increment\n            if line_num \u003c target_line {\n                // Increase for opening keywords\n                if trimmed.starts_with(\"function\")\n                    || trimmed.starts_with(\"if\")\n                    || trimmed.starts_with(\"while\")\n                    || trimmed.starts_with(\"for\")\n                    || trimmed.starts_with(\"class\")\n                    || trimmed.starts_with(\"interface\")\n                    || (trimmed.starts_with(\"else\") \u0026\u0026 !trimmed.starts_with(\"elseif\"))\n                {\n                    level += 1;\n                }\n            }\n        }\n\n        level\n    }\n\n    /// Calculate the correct indent level for 'end' keyword\n    fn calculate_end_indent(\u0026self, document: \u0026Document, line: usize) -\u003e Option\u003cusize\u003e {\n        let indent_level = self.calculate_indent_level(document, line);\n        Some(indent_level.saturating_sub(1))\n    }\n\n    /// Create indentation string\n    fn make_indent(\u0026self, level: usize, options: \u0026FormattingOptions) -\u003e String {\n        if options.insert_spaces {\n            \" \".repeat(level * options.tab_size as usize)\n        } else {\n            \"\\t\".repeat(level)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_formatting_options() {\n        let provider = FormattingProvider::new();\n\n        // Test with spaces\n        let doc = Document::new_test(\"function foo()\\nlocal x = 1\\nend\".to_string(), 1);\n\n        let options = FormattingOptions {\n            tab_size: 4,\n            insert_spaces: true,\n            properties: Default::default(),\n            trim_trailing_whitespace: Some(true),\n            insert_final_newline: Some(false),\n            trim_final_newlines: Some(false),\n        };\n\n        let edits = provider.format_document(\u0026doc, options);\n        // Should produce edits for indentation\n        assert!(edits.len() \u003e 0);\n\n        // Test with tabs\n        let options = FormattingOptions {\n            tab_size: 1,\n            insert_spaces: false,\n            properties: Default::default(),\n            trim_trailing_whitespace: Some(true),\n            insert_final_newline: Some(false),\n            trim_final_newlines: Some(false),\n        };\n\n        let edits = provider.format_document(\u0026doc, options.clone());\n        assert!(edits.len() \u003e 0);\n    }\n\n    #[test]\n    fn test_formatting_cases() {\n        let provider = FormattingProvider::new();\n\n        // Test indentation normalization\n        let doc = Document::new_test(\n            \"function foo()\\n        local x = 1\\n    end\".to_string(),\n            1,\n        );\n\n        let options = FormattingOptions {\n            tab_size: 4,\n            insert_spaces: true,\n            properties: Default::default(),\n            trim_trailing_whitespace: Some(true),\n            insert_final_newline: Some(false),\n            trim_final_newlines: Some(false),\n        };\n\n        let edits = provider.format_document(\u0026doc, options);\n        // Should fix misaligned indentation\n        assert!(edits.len() \u003e 0);\n\n        // Test trailing whitespace removal\n        let doc = Document::new_test(\"local x = 1   \\nlocal y = 2  \".to_string(), 1);\n\n        let options2 = FormattingOptions {\n            tab_size: 4,\n            insert_spaces: true,\n            properties: Default::default(),\n            trim_trailing_whitespace: Some(true),\n            insert_final_newline: Some(false),\n            trim_final_newlines: Some(false),\n        };\n\n        let edits = provider.format_document(\u0026doc, options2);\n        // Should remove trailing spaces\n        assert!(edits.len() \u003e 0);\n\n        // Test on-type formatting for 'end' keyword\n        let doc = Document::new_test(\n            \"function foo()\\n    local x = 1\\n        end\".to_string(),\n            1,\n        );\n\n        let options3 = FormattingOptions {\n            tab_size: 4,\n            insert_spaces: true,\n            properties: Default::default(),\n            trim_trailing_whitespace: Some(true),\n            insert_final_newline: Some(false),\n            trim_final_newlines: Some(false),\n        };\n\n        let position = Position {\n            line: 2,\n            character: 11,\n        }; // After 'end'\n        let _edits = provider.format_on_type(\u0026doc, position, \"d\", options3);\n        // Should auto-indent 'end' to correct level\n        // May or may not produce edits depending on state\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":4}},{"line":15,"address":[],"length":0,"stats":{"Line":4}},{"line":19,"address":[],"length":0,"stats":{"Line":8}},{"line":25,"address":[],"length":0,"stats":{"Line":24}},{"line":26,"address":[],"length":0,"stats":{"Line":24}},{"line":27,"address":[],"length":0,"stats":{"Line":40}},{"line":28,"address":[],"length":0,"stats":{"Line":16}},{"line":29,"address":[],"length":0,"stats":{"Line":16}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":48}},{"line":34,"address":[],"length":0,"stats":{"Line":16}},{"line":35,"address":[],"length":0,"stats":{"Line":16}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":16}},{"line":43,"address":[],"length":0,"stats":{"Line":40}},{"line":45,"address":[],"length":0,"stats":{"Line":8}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":85,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":2}},{"line":89,"address":[],"length":0,"stats":{"Line":8}},{"line":90,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":4}},{"line":95,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":6}},{"line":102,"address":[],"length":0,"stats":{"Line":12}},{"line":104,"address":[],"length":0,"stats":{"Line":6}},{"line":105,"address":[],"length":0,"stats":{"Line":4}},{"line":106,"address":[],"length":0,"stats":{"Line":6}},{"line":107,"address":[],"length":0,"stats":{"Line":6}},{"line":108,"address":[],"length":0,"stats":{"Line":6}},{"line":110,"address":[],"length":0,"stats":{"Line":4}},{"line":111,"address":[],"length":0,"stats":{"Line":6}},{"line":112,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":121,"address":[],"length":0,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":8}},{"line":133,"address":[],"length":0,"stats":{"Line":32}},{"line":134,"address":[],"length":0,"stats":{"Line":24}},{"line":136,"address":[],"length":0,"stats":{"Line":60}},{"line":137,"address":[],"length":0,"stats":{"Line":66}},{"line":140,"address":[],"length":0,"stats":{"Line":44}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":44}},{"line":162,"address":[],"length":0,"stats":{"Line":32}},{"line":163,"address":[],"length":0,"stats":{"Line":32}},{"line":165,"address":[],"length":0,"stats":{"Line":6}},{"line":169,"address":[],"length":0,"stats":{"Line":110}},{"line":170,"address":[],"length":0,"stats":{"Line":224}},{"line":173,"address":[],"length":0,"stats":{"Line":30}},{"line":174,"address":[],"length":0,"stats":{"Line":24}},{"line":175,"address":[],"length":0,"stats":{"Line":16}},{"line":176,"address":[],"length":0,"stats":{"Line":24}},{"line":177,"address":[],"length":0,"stats":{"Line":24}},{"line":178,"address":[],"length":0,"stats":{"Line":24}},{"line":180,"address":[],"length":0,"stats":{"Line":16}},{"line":181,"address":[],"length":0,"stats":{"Line":24}},{"line":182,"address":[],"length":0,"stats":{"Line":16}},{"line":185,"address":[],"length":0,"stats":{"Line":8}},{"line":190,"address":[],"length":0,"stats":{"Line":130}},{"line":191,"address":[],"length":0,"stats":{"Line":44}},{"line":192,"address":[],"length":0,"stats":{"Line":48}},{"line":193,"address":[],"length":0,"stats":{"Line":12}},{"line":194,"address":[],"length":0,"stats":{"Line":4}},{"line":195,"address":[],"length":0,"stats":{"Line":8}},{"line":196,"address":[],"length":0,"stats":{"Line":8}},{"line":197,"address":[],"length":0,"stats":{"Line":8}},{"line":199,"address":[],"length":0,"stats":{"Line":4}},{"line":200,"address":[],"length":0,"stats":{"Line":8}},{"line":201,"address":[],"length":0,"stats":{"Line":4}},{"line":204,"address":[],"length":0,"stats":{"Line":4}},{"line":210,"address":[],"length":0,"stats":{"Line":44}},{"line":211,"address":[],"length":0,"stats":{"Line":32}},{"line":212,"address":[],"length":0,"stats":{"Line":32}},{"line":213,"address":[],"length":0,"stats":{"Line":32}},{"line":214,"address":[],"length":0,"stats":{"Line":32}},{"line":215,"address":[],"length":0,"stats":{"Line":32}},{"line":216,"address":[],"length":0,"stats":{"Line":32}},{"line":218,"address":[],"length":0,"stats":{"Line":6}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":8}},{"line":295,"address":[],"length":0,"stats":{"Line":6}},{"line":297,"address":[],"length":0,"stats":{"Line":16}},{"line":298,"address":[],"length":0,"stats":{"Line":18}},{"line":300,"address":[],"length":0,"stats":{"Line":12}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":12}},{"line":306,"address":[],"length":0,"stats":{"Line":8}},{"line":307,"address":[],"length":0,"stats":{"Line":8}},{"line":309,"address":[],"length":0,"stats":{"Line":2}},{"line":313,"address":[],"length":0,"stats":{"Line":6}},{"line":315,"address":[],"length":0,"stats":{"Line":8}},{"line":316,"address":[],"length":0,"stats":{"Line":4}},{"line":317,"address":[],"length":0,"stats":{"Line":4}},{"line":318,"address":[],"length":0,"stats":{"Line":4}},{"line":319,"address":[],"length":0,"stats":{"Line":4}},{"line":320,"address":[],"length":0,"stats":{"Line":4}},{"line":321,"address":[],"length":0,"stats":{"Line":4}},{"line":323,"address":[],"length":0,"stats":{"Line":2}},{"line":328,"address":[],"length":0,"stats":{"Line":2}},{"line":332,"address":[],"length":0,"stats":{"Line":2}},{"line":333,"address":[],"length":0,"stats":{"Line":10}},{"line":334,"address":[],"length":0,"stats":{"Line":2}},{"line":338,"address":[],"length":0,"stats":{"Line":24}},{"line":339,"address":[],"length":0,"stats":{"Line":24}},{"line":340,"address":[],"length":0,"stats":{"Line":54}},{"line":342,"address":[],"length":0,"stats":{"Line":18}}],"covered":104,"coverable":168},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","formatting","mod.rs"],"content":"//! Code formatting features\n\npub mod formatting;\n\npub use formatting::FormattingProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","hints","inlay_hints.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::ast::expression::{Expression, ExpressionKind};\nuse typedlua_parser::ast::statement::Statement;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_typechecker::TypeChecker;\n\n/// Provides inlay hints (inline type annotations and parameter names)\n#[derive(Clone)]\npub struct InlayHintsProvider;\n\nimpl InlayHintsProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide inlay hints for a given range in the document\n    pub fn provide(\u0026self, document: \u0026Document, range: Range) -\u003e Vec\u003cInlayHint\u003e {\n        let mut hints = Vec::new();\n\n        // Parse and type check the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return hints,\n        };\n\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let mut ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return hints,\n        };\n\n        let mut type_checker = TypeChecker::new(handler, \u0026interner, \u0026common_ids);\n        if type_checker.check_program(\u0026mut ast).is_err() {\n            return hints;\n        }\n\n        // Traverse AST and collect hints within the range\n        for stmt in \u0026ast.statements {\n            self.collect_hints_from_statement(stmt, \u0026type_checker, range, \u0026mut hints, \u0026interner);\n        }\n\n        hints\n    }\n\n    /// Resolve additional details for an inlay hint\n    pub fn resolve(\u0026self, hint: InlayHint) -\u003e InlayHint {\n        // For now, just return the hint as-is\n        hint\n    }\n\n    /// Collect hints from a statement\n    fn collect_hints_from_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        type_checker: \u0026TypeChecker,\n        range: Range,\n        hints: \u0026mut Vec\u003cInlayHint\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match stmt {\n            Statement::Variable(decl) =\u003e {\n                if decl.type_annotation.is_none() {\n                    let stmt_start = span_to_position_start(\u0026decl.span);\n                    let stmt_end = span_to_position_end(\u0026decl.span);\n\n                    if stmt_start.line \u003e= range.start.line \u0026\u0026 stmt_end.line \u003c= range.end.line {\n                        let pattern_end = span_to_position_end(\u0026decl.pattern.span());\n\n                        hints.push(InlayHint {\n                            position: pattern_end,\n                            label: InlayHintLabel::String(\": unknown\".to_string()),\n                            kind: Some(InlayHintKind::TYPE),\n                            text_edits: None,\n                            tooltip: None,\n                            padding_left: Some(true),\n                            padding_right: Some(false),\n                            data: None,\n                        });\n                    }\n                }\n            }\n            Statement::Block(block) =\u003e {\n                for inner_stmt in \u0026block.statements {\n                    self.collect_hints_from_statement(\n                        inner_stmt,\n                        type_checker,\n                        range,\n                        hints,\n                        interner,\n                    );\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Collect parameter name hints from function calls\n    #[allow(dead_code)]\n    fn collect_hints_from_expression(\n        \u0026self,\n        expr: \u0026Expression,\n        type_checker: \u0026TypeChecker,\n        range: Range,\n        hints: \u0026mut Vec\u003cInlayHint\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match \u0026expr.kind {\n            ExpressionKind::Call(callee, args, _type_args) =\u003e {\n                // Try to get the function name for parameter hints\n                if let ExpressionKind::Identifier(func_name) = \u0026callee.kind {\n                    let func_name_str = interner.resolve(*func_name);\n                    if let Some(symbol) = type_checker.lookup_symbol(\u0026func_name_str) {\n                        // Get function type parameters\n                        use typedlua_parser::ast::types::TypeKind;\n                        if let TypeKind::Function(func_type) = \u0026symbol.typ.kind {\n                            // Show parameter name hints for function arguments\n                            for (i, arg) in args.iter().enumerate() {\n                                if i \u003c func_type.parameters.len() {\n                                    let param = \u0026func_type.parameters[i];\n                                    if let typedlua_parser::ast::pattern::Pattern::Identifier(\n                                        ident,\n                                    ) = \u0026param.pattern\n                                    {\n                                        if self.span_in_range(\u0026arg.span, range) {\n                                            let position = span_to_position_start(\u0026arg.span);\n\n                                            hints.push(InlayHint {\n                                                position,\n                                                label: InlayHintLabel::String(format!(\n                                                    \"{}: \",\n                                                    ident.node\n                                                )),\n                                                kind: Some(InlayHintKind::PARAMETER),\n                                                text_edits: None,\n                                                tooltip: None,\n                                                padding_left: Some(false),\n                                                padding_right: Some(false),\n                                                data: None,\n                                            });\n                                        }\n                                    }\n                                }\n\n                                // Recursively check nested expressions\n                                self.collect_hints_from_expression(\n                                    \u0026arg.value,\n                                    type_checker,\n                                    range,\n                                    hints,\n                                    interner,\n                                );\n                            }\n                        }\n                    }\n                }\n\n                // Also check the callee for nested calls\n                self.collect_hints_from_expression(callee, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Binary(_, left, right) =\u003e {\n                self.collect_hints_from_expression(left, type_checker, range, hints, interner);\n                self.collect_hints_from_expression(right, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Unary(_, operand) =\u003e {\n                self.collect_hints_from_expression(operand, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Member(object, _) =\u003e {\n                self.collect_hints_from_expression(object, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Index(object, index) =\u003e {\n                self.collect_hints_from_expression(object, type_checker, range, hints, interner);\n                self.collect_hints_from_expression(index, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Assignment(target, _, value) =\u003e {\n                self.collect_hints_from_expression(target, type_checker, range, hints, interner);\n                self.collect_hints_from_expression(value, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Conditional(condition, then_expr, else_expr) =\u003e {\n                self.collect_hints_from_expression(condition, type_checker, range, hints, interner);\n                self.collect_hints_from_expression(then_expr, type_checker, range, hints, interner);\n                self.collect_hints_from_expression(else_expr, type_checker, range, hints, interner);\n            }\n            ExpressionKind::Parenthesized(inner) =\u003e {\n                self.collect_hints_from_expression(inner, type_checker, range, hints, interner);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Check if a span is within the requested range\n    #[allow(dead_code)]\n    fn span_in_range(\u0026self, span: \u0026Span, range: Range) -\u003e bool {\n        let span_line = (span.line.saturating_sub(1)) as u32;\n        span_line \u003e= range.start.line \u0026\u0026 span_line \u003c= range.end.line\n    }\n\n    /// Format a type for display\n    #[allow(dead_code)]\n    fn format_type_simple(\n        \u0026self,\n        typ: \u0026typedlua_parser::ast::types::Type,\n        interner: \u0026StringInterner,\n    ) -\u003e String {\n        use typedlua_parser::ast::types::{PrimitiveType, TypeKind};\n\n        match \u0026typ.kind {\n            TypeKind::Primitive(PrimitiveType::Nil) =\u003e \"nil\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Boolean) =\u003e \"boolean\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Number) =\u003e \"number\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Integer) =\u003e \"integer\".to_string(),\n            TypeKind::Primitive(PrimitiveType::String) =\u003e \"string\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Unknown) =\u003e \"unknown\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Never) =\u003e \"never\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Void) =\u003e \"void\".to_string(),\n            TypeKind::Reference(type_ref) =\u003e interner.resolve(type_ref.name.node).to_string(),\n            TypeKind::Function(_) =\u003e \"function\".to_string(),\n            TypeKind::Array(elem_type) =\u003e {\n                format!(\"{}[]\", self.format_type_simple(elem_type, interner))\n            }\n            _ =\u003e \"unknown\".to_string(),\n        }\n    }\n}\n\n/// Convert a Span to an LSP Position (start)\n#[allow(dead_code)]\nfn span_to_position_start(span: \u0026Span) -\u003e Position {\n    Position {\n        line: (span.line.saturating_sub(1)) as u32,\n        character: (span.column.saturating_sub(1)) as u32,\n    }\n}\n\n/// Convert a Span to an LSP Position (end)\n#[allow(dead_code)]\nfn span_to_position_end(span: \u0026Span) -\u003e Position {\n    Position {\n        line: (span.line.saturating_sub(1)) as u32,\n        character: ((span.column + span.len()).saturating_sub(1)) as u32,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_type_hint_scenarios() {\n        let provider = InlayHintsProvider::new();\n\n        // Test variable without type annotation - should show hint\n        let doc = Document::new_test(\"local x = 10\".to_string(), 1);\n\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 0,\n                character: 12,\n            },\n        };\n\n        let _hints = provider.provide(\u0026doc, range);\n        // May or may not have hints depending on type checker availability\n        // Just verify the function runs without errors\n\n        // Test variable WITH type annotation - should NOT show hint\n        let doc = Document::new_test(\"local x: number = 10\".to_string(), 1);\n\n        let _hints = provider.provide(\u0026doc, range);\n        // Should not add duplicate type hints\n    }\n\n    #[test]\n    fn test_parameter_hint_scenarios() {\n        let provider = InlayHintsProvider::new();\n\n        // Test simple function call\n        let doc = Document::new_test(\"foo(10, 20)\".to_string(), 1);\n\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 0,\n                character: 11,\n            },\n        };\n\n        let _hints = provider.provide(\u0026doc, range);\n        // May need type information to provide parameter hints\n\n        // Test that we can process method calls without errors\n        let doc = Document::new_test(\"obj.method(true)\".to_string(), 1);\n\n        let _hints = provider.provide(\u0026doc, range);\n    }\n\n    #[test]\n    fn test_hint_positions() {\n        let provider = InlayHintsProvider::new();\n\n        let doc = Document::new_test(\"local x = 10\".to_string(), 1);\n\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 0,\n                character: 12,\n            },\n        };\n\n        let hints = provider.provide(\u0026doc, range);\n\n        // Verify each hint has valid position\n        for hint in \u0026hints {\n            assert_eq!(hint.position.line, 0);\n            // Position should be within document bounds\n            assert!(hint.position.character \u003c= 12);\n\n            // Verify hint has appropriate structure\n            match \u0026hint.label {\n                InlayHintLabel::String(s) =\u003e {\n                    assert!(!s.is_empty());\n                }\n                InlayHintLabel::LabelParts(_) =\u003e {}\n            }\n\n            // Verify kind is set\n            assert!(hint.kind.is_some());\n        }\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":6}},{"line":17,"address":[],"length":0,"stats":{"Line":6}},{"line":21,"address":[],"length":0,"stats":{"Line":10}},{"line":22,"address":[],"length":0,"stats":{"Line":20}},{"line":25,"address":[],"length":0,"stats":{"Line":30}},{"line":26,"address":[],"length":0,"stats":{"Line":30}},{"line":27,"address":[],"length":0,"stats":{"Line":50}},{"line":28,"address":[],"length":0,"stats":{"Line":20}},{"line":29,"address":[],"length":0,"stats":{"Line":20}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":60}},{"line":34,"address":[],"length":0,"stats":{"Line":20}},{"line":35,"address":[],"length":0,"stats":{"Line":20}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":50}},{"line":40,"address":[],"length":0,"stats":{"Line":30}},{"line":41,"address":[],"length":0,"stats":{"Line":4}},{"line":45,"address":[],"length":0,"stats":{"Line":24}},{"line":46,"address":[],"length":0,"stats":{"Line":36}},{"line":49,"address":[],"length":0,"stats":{"Line":6}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":6}},{"line":67,"address":[],"length":0,"stats":{"Line":6}},{"line":68,"address":[],"length":0,"stats":{"Line":6}},{"line":69,"address":[],"length":0,"stats":{"Line":12}},{"line":70,"address":[],"length":0,"stats":{"Line":12}},{"line":71,"address":[],"length":0,"stats":{"Line":12}},{"line":73,"address":[],"length":0,"stats":{"Line":12}},{"line":74,"address":[],"length":0,"stats":{"Line":16}},{"line":76,"address":[],"length":0,"stats":{"Line":12}},{"line":77,"address":[],"length":0,"stats":{"Line":8}},{"line":78,"address":[],"length":0,"stats":{"Line":8}},{"line":79,"address":[],"length":0,"stats":{"Line":8}},{"line":80,"address":[],"length":0,"stats":{"Line":8}},{"line":81,"address":[],"length":0,"stats":{"Line":8}},{"line":82,"address":[],"length":0,"stats":{"Line":8}},{"line":83,"address":[],"length":0,"stats":{"Line":4}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":4}},{"line":236,"address":[],"length":0,"stats":{"Line":12}},{"line":237,"address":[],"length":0,"stats":{"Line":4}},{"line":243,"address":[],"length":0,"stats":{"Line":8}},{"line":245,"address":[],"length":0,"stats":{"Line":24}},{"line":246,"address":[],"length":0,"stats":{"Line":16}}],"covered":41,"coverable":124},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","hints","mod.rs"],"content":"//! Inlay hints features\n\npub mod inlay_hints;\n\npub use inlay_hints::InlayHintsProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","mod.rs"],"content":"//! LSP feature providers organized by category\n\npub mod edit;\npub mod formatting;\npub mod hints;\npub mod navigation;\npub mod semantic;\npub mod structure;\n\npub use edit::{CodeActionsProvider, CompletionProvider, RenameProvider, SignatureHelpProvider};\npub use formatting::FormattingProvider;\npub use hints::InlayHintsProvider;\npub use navigation::{DefinitionProvider, HoverProvider, ReferencesProvider};\npub use semantic::SemanticTokensProvider;\npub use structure::{FoldingRangeProvider, SelectionRangeProvider, SymbolsProvider};\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","navigation","definition.rs"],"content":"use crate::core::document::{Document, DocumentManager};\nuse crate::traits::DefinitionProviderTrait;\nuse lsp_types::{GotoDefinitionResponse, Location, Position, Range, Uri};\nuse std::sync::Arc;\nuse typedlua_parser::ast::statement::Statement;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides go-to-definition functionality\n#[derive(Clone)]\npub struct DefinitionProvider;\n\nimpl DefinitionProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide definition location for symbol at position (internal method with manager)\n    pub fn provide_with_manager(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        document_manager: \u0026DocumentManager,\n    ) -\u003e Option\u003cGotoDefinitionResponse\u003e {\n        // Get the word at the current position\n        let word = self.get_word_at_position(document, position)?;\n\n        // Parse the document to find declarations\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = parser.parse().ok()?;\n\n        // First, check if the symbol is from an import statement\n        if let Some(import_location) = self.find_import_definition(\n            \u0026ast.statements,\n            \u0026word,\n            document,\n            document_manager,\n            \u0026interner,\n        ) {\n            return Some(GotoDefinitionResponse::Scalar(import_location));\n        }\n\n        // Otherwise, search for local declaration\n        let def_span = self.find_declaration(\u0026ast.statements, \u0026word, \u0026interner)?;\n\n        // Convert span to LSP Location\n        let location = Location {\n            uri: uri.clone(),\n            range: span_to_range(\u0026def_span),\n        };\n\n        Some(GotoDefinitionResponse::Scalar(location))\n    }\n\n    /// Find definition for symbols imported from other files\n    fn find_import_definition(\n        \u0026self,\n        statements: \u0026[Statement],\n        symbol_name: \u0026str,\n        current_document: \u0026Document,\n        document_manager: \u0026DocumentManager,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cLocation\u003e {\n        use typedlua_parser::ast::statement::ImportClause;\n\n        // Search for import statements that import this symbol\n        for stmt in statements {\n            if let Statement::Import(import_decl) = stmt {\n                let import_source = \u0026import_decl.source;\n\n                // Check if this import contains our symbol\n                let exported_name = match \u0026import_decl.clause {\n                    ImportClause::Named(specs) =\u003e {\n                        // Find the import spec that matches our symbol\n                        specs.iter().find_map(|spec| {\n                            let local_name = spec.local.as_ref().unwrap_or(\u0026spec.imported);\n                            if interner.resolve(local_name.node) == symbol_name {\n                                Some(interner.resolve(spec.imported.node))\n                            } else {\n                                None\n                            }\n                        })\n                    }\n                    ImportClause::Default(ident) =\u003e {\n                        if interner.resolve(ident.node) == symbol_name {\n                            Some(\"default\".to_string())\n                        } else {\n                            None\n                        }\n                    }\n                    ImportClause::Namespace(ident) =\u003e {\n                        if interner.resolve(ident.node) == symbol_name {\n                            // For namespace imports, we'd need to handle property access\n                            // For now, just return None\n                            None\n                        } else {\n                            None\n                        }\n                    }\n                    ImportClause::TypeOnly(_) =\u003e {\n                        // Type-only imports - could handle similarly to Named\n                        None\n                    }\n                    ImportClause::Mixed { default, named } =\u003e {\n                        // Check default import first\n                        if interner.resolve(default.node) == symbol_name {\n                            Some(\"default\".to_string())\n                        } else {\n                            // Check named imports\n                            named.iter().find_map(|spec| {\n                                let local_name = spec.local.as_ref().unwrap_or(\u0026spec.imported);\n                                if interner.resolve(local_name.node) == symbol_name {\n                                    Some(interner.resolve(spec.imported.node))\n                                } else {\n                                    None\n                                }\n                            })\n                        }\n                    }\n                };\n\n                if let Some(exported_name) = exported_name {\n                    // Resolve the import path to a module ID\n                    if let Some(module_id) = \u0026current_document.module_id {\n                        let resolver = document_manager.module_resolver();\n                        {\n                            if let Ok(target_module_id) = resolver\n                                .resolve(import_source, std::path::Path::new(module_id.as_str()))\n                            {\n                                // Convert module ID to URI\n                                if let Some(target_uri) =\n                                    document_manager.module_id_to_uri(\u0026target_module_id)\n                                {\n                                    // Try to get the target document if it's open\n                                    if let Some(target_doc) = document_manager.get(target_uri) {\n                                        // Parse the target document and find the export\n                                        return self.find_export_in_document(\n                                            target_doc,\n                                            \u0026exported_name,\n                                            target_uri,\n                                        );\n                                    } else {\n                                        // Document not open - we could potentially read it from disk\n                                        // For now, just return the file location\n                                        return Some(Location {\n                                            uri: target_uri.clone(),\n                                            range: Range {\n                                                start: Position {\n                                                    line: 0,\n                                                    character: 0,\n                                                },\n                                                end: Position {\n                                                    line: 0,\n                                                    character: 0,\n                                                },\n                                            },\n                                        });\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        None\n    }\n\n    /// Find an exported symbol in a document\n    fn find_export_in_document(\n        \u0026self,\n        document: \u0026Document,\n        symbol_name: \u0026str,\n        uri: \u0026Uri,\n    ) -\u003e Option\u003cLocation\u003e {\n        // Parse the target document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = parser.parse().ok()?;\n\n        // Search for the exported declaration\n        use typedlua_parser::ast::statement::ExportKind;\n\n        for stmt in \u0026ast.statements {\n            if let Statement::Export(export_decl) = stmt {\n                match \u0026export_decl.kind {\n                    ExportKind::Declaration(decl) =\u003e {\n                        // Check if this declaration exports our symbol\n                        if let Some(span) =\n                            self.get_declaration_name_span(decl, symbol_name, \u0026interner)\n                        {\n                            return Some(Location {\n                                uri: uri.clone(),\n                                range: span_to_range(\u0026span),\n                            });\n                        }\n                    }\n                    ExportKind::Named {\n                        specifiers,\n                        source: _,\n                    } =\u003e {\n                        // Check if this is a named export of our symbol\n                        for spec in specifiers {\n                            if interner.resolve(spec.exported.as_ref().unwrap_or(\u0026spec.local).node)\n                                == symbol_name\n                            {\n                                // Find the local declaration\n                                if let Some(local_span) = self.find_declaration(\n                                    \u0026ast.statements,\n                                    \u0026interner.resolve(spec.local.node),\n                                    \u0026interner,\n                                ) {\n                                    return Some(Location {\n                                        uri: uri.clone(),\n                                        range: span_to_range(\u0026local_span),\n                                    });\n                                }\n                            }\n                        }\n                    }\n                    ExportKind::Default(_) if symbol_name == \"default\" =\u003e {\n                        // For default exports, return the export statement location\n                        return Some(Location {\n                            uri: uri.clone(),\n                            range: span_to_range(\u0026export_decl.span),\n                        });\n                    }\n                    _ =\u003e {}\n                }\n            }\n        }\n\n        None\n    }\n\n    /// Get the name span from a declaration statement\n    fn get_declaration_name_span(\n        \u0026self,\n        stmt: \u0026Statement,\n        name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSpan\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    if interner.resolve(ident.node) == name {\n                        return Some(ident.span);\n                    }\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                if interner.resolve(func_decl.name.node) == name {\n                    return Some(func_decl.name.span);\n                }\n            }\n            Statement::Class(class_decl) =\u003e {\n                if interner.resolve(class_decl.name.node) == name {\n                    return Some(class_decl.name.span);\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                if interner.resolve(interface_decl.name.node) == name {\n                    return Some(interface_decl.name.span);\n                }\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                if interner.resolve(type_decl.name.node) == name {\n                    return Some(type_decl.name.span);\n                }\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                if interner.resolve(enum_decl.name.node) == name {\n                    return Some(enum_decl.name.span);\n                }\n            }\n            _ =\u003e {}\n        }\n        None\n    }\n\n    /// Find the declaration span for a given symbol name\n    fn find_declaration(\n        \u0026self,\n        statements: \u0026[Statement],\n        name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSpan\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        for stmt in statements {\n            match stmt {\n                Statement::Variable(var_decl) =\u003e {\n                    // Check if the pattern contains this identifier\n                    if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                        if interner.resolve(ident.node) == name {\n                            return Some(ident.span);\n                        }\n                    }\n                }\n                Statement::Function(func_decl) =\u003e {\n                    if interner.resolve(func_decl.name.node) == name {\n                        return Some(func_decl.name.span);\n                    }\n                }\n                Statement::Class(class_decl) =\u003e {\n                    if interner.resolve(class_decl.name.node) == name {\n                        return Some(class_decl.name.span);\n                    }\n                }\n                Statement::Interface(interface_decl) =\u003e {\n                    if interner.resolve(interface_decl.name.node) == name {\n                        return Some(interface_decl.name.span);\n                    }\n                }\n                Statement::TypeAlias(type_decl) =\u003e {\n                    if interner.resolve(type_decl.name.node) == name {\n                        return Some(type_decl.name.span);\n                    }\n                }\n                Statement::Enum(enum_decl) =\u003e {\n                    if interner.resolve(enum_decl.name.node) == name {\n                        return Some(enum_decl.name.span);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        None\n    }\n\n    /// Get the word at the cursor position\n    fn get_word_at_position(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        // Find word boundaries\n        let chars: Vec\u003cchar\u003e = line.chars().collect();\n        if char_pos \u003e= chars.len() {\n            return None;\n        }\n\n        // Check if we're on a word character\n        if !chars[char_pos].is_alphanumeric() \u0026\u0026 chars[char_pos] != '_' {\n            return None;\n        }\n\n        // Find start of word\n        let mut start = char_pos;\n        while start \u003e 0 \u0026\u0026 (chars[start - 1].is_alphanumeric() || chars[start - 1] == '_') {\n            start -= 1;\n        }\n\n        // Find end of word\n        let mut end = char_pos;\n        while end \u003c chars.len() \u0026\u0026 (chars[end].is_alphanumeric() || chars[end] == '_') {\n            end += 1;\n        }\n\n        Some(chars[start..end].iter().collect())\n    }\n}\n\n/// Convert a Span to an LSP Range\nfn span_to_range(span: \u0026Span) -\u003e Range {\n    Range {\n        start: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: (span.column.saturating_sub(1)) as u32,\n        },\n        end: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: ((span.column + span.len()).saturating_sub(1)) as u32,\n        },\n    }\n}\n\nimpl DefinitionProviderTrait for DefinitionProvider {\n    fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n    ) -\u003e Option\u003cGotoDefinitionResponse\u003e {\n        use typedlua_typechecker::cli::config::CompilerOptions;\n        use typedlua_typechecker::cli::fs::MockFileSystem;\n        use typedlua_typechecker::module_resolver::{ModuleRegistry, ModuleResolver};\n\n        let workspace_root = std::path::PathBuf::from(\"/test\");\n        let fs = std::sync::Arc::new(MockFileSystem::new());\n        let compiler_options = CompilerOptions::default();\n        let module_config =\n            typedlua_typechecker::module_resolver::ModuleConfig::from_compiler_options(\n                \u0026compiler_options,\n                \u0026workspace_root,\n            );\n        let module_registry = std::sync::Arc::new(ModuleRegistry::new());\n        let module_resolver = std::sync::Arc::new(ModuleResolver::new(\n            fs,\n            module_config,\n            workspace_root.clone(),\n        ));\n        let manager = DocumentManager::new(workspace_root, module_registry, module_resolver);\n        self.provide_with_manager(uri, document, position, \u0026manager)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":188},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","navigation","hover.rs"],"content":"use crate::core::document::Document;\nuse crate::traits::HoverProviderTrait;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_typechecker::{SymbolKind, TypeChecker};\n\n/// Provides hover information (type info, documentation, signatures)\n#[derive(Clone)]\npub struct HoverProvider;\n\nimpl HoverProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide hover information at a given position (internal method)\n    pub fn provide_impl(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cHover\u003e {\n        // Get the word at the current position\n        let word = self.get_word_at_position(document, position)?;\n\n        // Check if it's a built-in keyword or type\n        if let Some(hover) = self.hover_for_keyword(\u0026word) {\n            return Some(hover);\n        }\n\n        if let Some(hover) = self.hover_for_builtin_type(\u0026word) {\n            return Some(hover);\n        }\n\n        // Try to get type information from type checker\n        if let Some(hover) = self.hover_for_symbol(document, \u0026word) {\n            return Some(hover);\n        }\n\n        None\n    }\n\n    /// Get hover information for a symbol using the type checker\n    fn hover_for_symbol(\u0026self, document: \u0026Document, word: \u0026str) -\u003e Option\u003cHover\u003e {\n        // Parse and type check the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler.clone(), \u0026interner, \u0026common_ids);\n        let mut ast = parser.parse().ok()?;\n\n        let mut type_checker = TypeChecker::new(handler, \u0026interner, \u0026common_ids);\n        type_checker.check_program(\u0026mut ast).ok()?;\n\n        // Look up the symbol\n        let symbol = type_checker.lookup_symbol(word)?.clone();\n\n        // Format the type information\n        let type_str = Self::format_type(\u0026symbol.typ, \u0026interner);\n        let kind_str = match symbol.kind {\n            SymbolKind::Const =\u003e \"const\",\n            SymbolKind::Variable =\u003e \"let\",\n            SymbolKind::Function =\u003e \"function\",\n            SymbolKind::Class =\u003e \"class\",\n            SymbolKind::Interface =\u003e \"interface\",\n            SymbolKind::TypeAlias =\u003e \"type\",\n            SymbolKind::Enum =\u003e \"enum\",\n            SymbolKind::Parameter =\u003e \"parameter\",\n            SymbolKind::Namespace =\u003e \"namespace\",\n        };\n\n        Some(Hover {\n            contents: HoverContents::Markup(MarkupContent {\n                kind: MarkupKind::Markdown,\n                value: format!(\"```typedlua\\n{} {}: {}\\n```\", kind_str, word, type_str),\n            }),\n            range: None,\n        })\n    }\n\n    /// Format a type for display\n    fn format_type(typ: \u0026typedlua_parser::ast::types::Type, interner: \u0026StringInterner) -\u003e String {\n        use typedlua_parser::ast::types::{PrimitiveType, TypeKind};\n\n        match \u0026typ.kind {\n            TypeKind::Primitive(PrimitiveType::Nil) =\u003e \"nil\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Boolean) =\u003e \"boolean\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Number) =\u003e \"number\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Integer) =\u003e \"integer\".to_string(),\n            TypeKind::Primitive(PrimitiveType::String) =\u003e \"string\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Unknown) =\u003e \"unknown\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Never) =\u003e \"never\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Void) =\u003e \"void\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Table) =\u003e \"table\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Coroutine) =\u003e \"coroutine\".to_string(),\n            TypeKind::Primitive(PrimitiveType::Thread) =\u003e \"thread\".to_string(),\n            TypeKind::Literal(_) =\u003e \"literal\".to_string(),\n            TypeKind::Union(_) =\u003e \"union type\".to_string(),\n            TypeKind::Intersection(_) =\u003e \"intersection type\".to_string(),\n            TypeKind::Function(_) =\u003e \"function\".to_string(),\n            TypeKind::Object(_) =\u003e \"object\".to_string(),\n            TypeKind::Array(_) =\u003e \"array\".to_string(),\n            TypeKind::Tuple(_) =\u003e \"tuple\".to_string(),\n            TypeKind::TypeQuery(_) =\u003e \"typeof\".to_string(),\n            TypeKind::Reference(type_ref) =\u003e interner.resolve(type_ref.name.node).to_string(),\n            TypeKind::Nullable(_) =\u003e \"nullable\".to_string(),\n            TypeKind::IndexAccess(_, _) =\u003e \"indexed access\".to_string(),\n            TypeKind::Conditional(_) =\u003e \"conditional type\".to_string(),\n            TypeKind::Infer(_) =\u003e \"infer\".to_string(),\n            TypeKind::KeyOf(_) =\u003e \"keyof\".to_string(),\n            TypeKind::Mapped(_) =\u003e \"mapped type\".to_string(),\n            TypeKind::TemplateLiteral(_) =\u003e \"template literal type\".to_string(),\n            TypeKind::Parenthesized(inner) =\u003e Self::format_type(inner, interner),\n            TypeKind::TypePredicate(_) =\u003e \"type predicate\".to_string(),\n            TypeKind::Variadic(_) =\u003e \"variadic\".to_string(),\n            TypeKind::Namespace(_) =\u003e \"namespace\".to_string(),\n        }\n    }\n\n    /// Get the word at the cursor position\n    fn get_word_at_position(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        // Find word boundaries\n        let chars: Vec\u003cchar\u003e = line.chars().collect();\n        if char_pos \u003e= chars.len() {\n            return None;\n        }\n\n        // Check if we're on a word character\n        if !chars[char_pos].is_alphanumeric() \u0026\u0026 chars[char_pos] != '_' {\n            return None;\n        }\n\n        // Find start of word\n        let mut start = char_pos;\n        while start \u003e 0 \u0026\u0026 (chars[start - 1].is_alphanumeric() || chars[start - 1] == '_') {\n            start -= 1;\n        }\n\n        // Find end of word\n        let mut end = char_pos;\n        while end \u003c chars.len() \u0026\u0026 (chars[end].is_alphanumeric() || chars[end] == '_') {\n            end += 1;\n        }\n\n        Some(chars[start..end].iter().collect())\n    }\n\n    /// Provide hover information for keywords\n    fn hover_for_keyword(\u0026self, word: \u0026str) -\u003e Option\u003cHover\u003e {\n        let (description, detail) = match word {\n            \"const\" =\u003e (\n                \"Constant declaration\",\n                \"Declares a constant value that cannot be reassigned.\\n\\n```typedlua\\nconst PI: number = 3.14159\\n```\"\n            ),\n            \"local\" =\u003e (\n                \"Local variable declaration\",\n                \"Declares a local variable with block scope.\\n\\n```typedlua\\nlocal x: number = 10\\n```\"\n            ),\n            \"function\" =\u003e (\n                \"Function declaration\",\n                \"Declares a function.\\n\\n```typedlua\\nfunction add(a: number, b: number): number\\n    return a + b\\nend\\n```\"\n            ),\n            \"if\" =\u003e (\"Conditional statement\", \"Executes code based on a condition.\\n\\n```typedlua\\nif condition then\\n    -- code\\nend\\n```\"),\n            \"then\" =\u003e (\"Then clause\", \"Marks the beginning of an if block.\"),\n            \"else\" =\u003e (\"Else clause\", \"Alternative branch in conditional statements.\"),\n            \"elseif\" =\u003e (\"Else-if clause\", \"Additional conditional branch.\"),\n            \"end\" =\u003e (\"End block\", \"Marks the end of a block (function, if, loop, etc).\"),\n            \"while\" =\u003e (\"While loop\", \"Repeats code while a condition is true.\\n\\n```typedlua\\nwhile condition do\\n    -- code\\nend\\n```\"),\n            \"for\" =\u003e (\"For loop\", \"Iteration statement.\\n\\n```typedlua\\nfor i = 1, 10 do\\n    -- code\\nend\\n```\"),\n            \"in\" =\u003e (\"In operator\", \"Used in for-in loops to iterate over collections.\"),\n            \"do\" =\u003e (\"Do block\", \"Marks the beginning of a loop body.\"),\n            \"repeat\" =\u003e (\"Repeat-until loop\", \"Executes code at least once, then repeats until condition is true.\\n\\n```typedlua\\nrepeat\\n    -- code\\nuntil condition\\n```\"),\n            \"until\" =\u003e (\"Until condition\", \"Termination condition for repeat loops.\"),\n            \"return\" =\u003e (\"Return statement\", \"Returns a value from a function.\"),\n            \"break\" =\u003e (\"Break statement\", \"Exits the current loop.\"),\n            \"continue\" =\u003e (\"Continue statement\", \"Skips to the next iteration of a loop.\"),\n            \"and\" =\u003e (\"Logical AND operator\", \"Returns true if both operands are true.\"),\n            \"or\" =\u003e (\"Logical OR operator\", \"Returns true if at least one operand is true.\"),\n            \"not\" =\u003e (\"Logical NOT operator\", \"Negates a boolean value.\"),\n            \"true\" =\u003e (\"Boolean true value\", \"Represents the boolean value true.\"),\n            \"false\" =\u003e (\"Boolean false value\", \"Represents the boolean value false.\"),\n            \"nil\" =\u003e (\"Nil value\", \"Represents the absence of a value.\"),\n            \"type\" =\u003e (\"Type alias declaration\", \"Declares a type alias.\\n\\n```typedlua\\ntype Point = { x: number, y: number }\\n```\"),\n            \"interface\" =\u003e (\"Interface declaration\", \"Declares an interface for object shapes.\\n\\n```typedlua\\ninterface Drawable {\\n    draw(): void\\n}\\n```\"),\n            \"enum\" =\u003e (\"Enum declaration\", \"Declares an enumeration.\\n\\n```typedlua\\nenum Color {\\n    Red,\\n    Green,\\n    Blue\\n}\\n```\"),\n            \"class\" =\u003e (\"Class declaration\", \"Declares a class.\\n\\n```typedlua\\nclass Point {\\n    x: number\\n    y: number\\n}\\n```\"),\n            \"extends\" =\u003e (\"Extends clause\", \"Specifies class inheritance.\"),\n            \"implements\" =\u003e (\"Implements clause\", \"Specifies interface implementation.\"),\n            \"public\" =\u003e (\"Public access modifier\", \"Members are accessible from anywhere.\"),\n            \"private\" =\u003e (\"Private access modifier\", \"Members are only accessible within the class.\"),\n            \"protected\" =\u003e (\"Protected access modifier\", \"Members are accessible within the class and subclasses.\"),\n            \"static\" =\u003e (\"Static modifier\", \"Members belong to the class rather than instances.\"),\n            \"abstract\" =\u003e (\"Abstract modifier\", \"Declares abstract classes or methods.\"),\n            \"readonly\" =\u003e (\"Readonly modifier\", \"Prevents reassignment after initialization.\"),\n            \"match\" =\u003e (\"Match expression\", \"Pattern matching expression.\\n\\n```typedlua\\nmatch value {\\n    pattern1 =\u003e result1,\\n    pattern2 =\u003e result2\\n}\\n```\"),\n            \"when\" =\u003e (\"When guard\", \"Adds conditions to match patterns.\"),\n            \"import\" =\u003e (\"Import statement\", \"Imports modules or specific exports.\\n\\n```typedlua\\nimport { func } from \\\"module\\\"\\n```\"),\n            \"from\" =\u003e (\"From clause\", \"Specifies the module to import from.\"),\n            \"export\" =\u003e (\"Export statement\", \"Exports declarations from a module.\"),\n            _ =\u003e return None,\n        };\n\n        Some(Hover {\n            contents: HoverContents::Markup(MarkupContent {\n                kind: MarkupKind::Markdown,\n                value: format!(\"**{}**\\n\\n{}\", description, detail),\n            }),\n            range: None,\n        })\n    }\n\n    /// Provide hover information for built-in types\n    fn hover_for_builtin_type(\u0026self, word: \u0026str) -\u003e Option\u003cHover\u003e {\n        let detail = match word {\n            \"nil\" =\u003e \"The type of the nil value, representing absence of a value.\",\n            \"boolean\" =\u003e \"Represents true or false values.\",\n            \"number\" =\u003e \"Represents numeric values (integers and floats).\",\n            \"string\" =\u003e \"Represents text/string values.\",\n            \"unknown\" =\u003e \"Top type - all types are assignable to unknown.\",\n            \"never\" =\u003e \"Bottom type - represents values that never occur.\",\n            \"void\" =\u003e \"Represents the absence of a return value.\",\n            \"any\" =\u003e \"Escape hatch - disables type checking for this value.\",\n            _ =\u003e return None,\n        };\n\n        Some(Hover {\n            contents: HoverContents::Markup(MarkupContent {\n                kind: MarkupKind::Markdown,\n                value: format!(\"```typedlua\\n{}\\n```\\n\\n{}\", word, detail),\n            }),\n            range: None,\n        })\n    }\n}\n\nimpl HoverProviderTrait for HoverProvider {\n    fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cHover\u003e {\n        self.provide_impl(document, position)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":162},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","navigation","mod.rs"],"content":"//! Navigation features (go-to, hover, references)\n\npub mod definition;\npub mod hover;\npub mod references;\n\npub use definition::DefinitionProvider;\npub use hover::HoverProvider;\npub use references::ReferencesProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","navigation","references.rs"],"content":"use crate::core::document::{Document, DocumentManager};\nuse crate::traits::ReferencesProviderTrait;\nuse lsp_types::{Uri, *};\n\nuse std::str::FromStr;\nuse std::sync::Arc;\nuse typedlua_parser::ast::statement::{Block, Statement};\nuse typedlua_parser::ast::{\n    expression::{Argument, Expression, ExpressionKind, ObjectProperty},\n    pattern::Pattern,\n};\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides find-references functionality\n#[derive(Clone)]\npub struct ReferencesProvider;\n\nimpl ReferencesProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Find all references to the symbol at the given position (internal method)\n    pub fn provide_impl(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        include_declaration: bool,\n        _document_manager: Option\u003c\u0026DocumentManager\u003e,\n    ) -\u003e Option\u003cVec\u003cLocation\u003e\u003e {\n        let word = self.get_word_at_position(document, position)?;\n\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = lexer.tokenize().ok()?;\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = parser.parse().ok()?;\n\n        let mut references = Vec::new();\n        self.find_references_in_statements(\u0026ast.statements, \u0026word, \u0026mut references, \u0026interner);\n\n        if include_declaration {\n            if let Some(decl_span) = self.find_declaration(\u0026ast.statements, \u0026word, \u0026interner) {\n                references.insert(\n                    0,\n                    Location {\n                        uri: uri.clone(),\n                        range: span_to_range(\u0026decl_span),\n                    },\n                );\n            }\n        }\n\n        Some(references)\n    }\n\n    fn find_references_in_statements(\n        \u0026self,\n        statements: \u0026[Statement],\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in statements {\n            self.find_references_in_statement(stmt, word, references, interner);\n        }\n    }\n\n    fn find_references_in_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    if interner.resolve(ident.node) == word {\n                        references.push(Location {\n                            uri: Uri::from_str(\"file://current\").unwrap(),\n                            range: span_to_range(\u0026ident.span),\n                        });\n                    }\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                if interner.resolve(func_decl.name.node) == word {\n                    references.push(Location {\n                        uri: Uri::from_str(\"file://current\").unwrap(),\n                        range: span_to_range(\u0026func_decl.name.span),\n                    });\n                }\n                self.find_references_in_function(func_decl, word, references, interner);\n            }\n            Statement::Expression(expr) =\u003e {\n                self.find_references_in_expression(expr, word, references, interner);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    fn find_references_in_function(\n        \u0026self,\n        func: \u0026typedlua_parser::ast::statement::FunctionDeclaration,\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        for param in \u0026func.parameters {\n            if let Pattern::Identifier(ident) = \u0026param.pattern {\n                if interner.resolve(ident.node) == word {\n                    references.push(Location {\n                        uri: Uri::from_str(\"file://current\").unwrap(),\n                        range: span_to_range(\u0026ident.span),\n                    });\n                }\n            }\n        }\n        self.find_references_in_block(\u0026func.body, word, references, interner);\n    }\n\n    fn find_references_in_block(\n        \u0026self,\n        block: \u0026Block,\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        for stmt in \u0026block.statements {\n            self.find_references_in_statement(stmt, word, references, interner);\n        }\n    }\n\n    fn find_references_in_arguments(\n        \u0026self,\n        arguments: \u0026[Argument],\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        for arg in arguments {\n            self.find_references_in_expression(\u0026arg.value, word, references, interner);\n        }\n    }\n\n    fn find_references_in_expression(\n        \u0026self,\n        expr: \u0026Expression,\n        word: \u0026str,\n        references: \u0026mut Vec\u003cLocation\u003e,\n        interner: \u0026StringInterner,\n    ) {\n        match \u0026expr.kind {\n            ExpressionKind::Identifier(ident) =\u003e {\n                if interner.resolve(*ident) == word {\n                    references.push(Location {\n                        uri: Uri::from_str(\"file://current\").unwrap(),\n                        range: span_to_range(\u0026expr.span),\n                    });\n                }\n            }\n            ExpressionKind::Call(callee, args, _types) =\u003e {\n                self.find_references_in_expression(callee, word, references, interner);\n                self.find_references_in_arguments(args, word, references, interner);\n            }\n            ExpressionKind::MethodCall(expr, _name, args, _types) =\u003e {\n                self.find_references_in_expression(expr, word, references, interner);\n                self.find_references_in_arguments(args, word, references, interner);\n            }\n            ExpressionKind::Object(properties) =\u003e {\n                for prop in properties {\n                    match prop {\n                        ObjectProperty::Property { key, value, .. } =\u003e {\n                            if interner.resolve(key.node) == word {\n                                references.push(Location {\n                                    uri: Uri::from_str(\"file://current\").unwrap(),\n                                    range: span_to_range(\u0026key.span),\n                                });\n                            }\n                            self.find_references_in_expression(value, word, references, interner);\n                        }\n                        ObjectProperty::Computed { key, value, .. } =\u003e {\n                            self.find_references_in_expression(key, word, references, interner);\n                            self.find_references_in_expression(value, word, references, interner);\n                        }\n                        ObjectProperty::Spread { value, .. } =\u003e {\n                            self.find_references_in_expression(value, word, references, interner);\n                        }\n                    }\n                }\n            }\n            ExpressionKind::Binary(_binop, left, right) =\u003e {\n                self.find_references_in_expression(left, word, references, interner);\n                self.find_references_in_expression(right, word, references, interner);\n            }\n            ExpressionKind::Unary(_unop, operand) =\u003e {\n                self.find_references_in_expression(operand, word, references, interner);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    fn get_word_at_position(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        if position.line as usize \u003e= lines.len() {\n            return None;\n        }\n\n        let line = lines[position.line as usize];\n        let char_pos = position.character as usize;\n        if char_pos \u003e line.len() {\n            return None;\n        }\n\n        let chars: Vec\u003cchar\u003e = line.chars().collect();\n        if char_pos \u003e= chars.len() {\n            return None;\n        }\n\n        if !chars[char_pos].is_alphanumeric() \u0026\u0026 chars[char_pos] != '_' {\n            return None;\n        }\n\n        let mut start = char_pos;\n        while start \u003e 0 \u0026\u0026 (chars[start - 1].is_alphanumeric() || chars[start - 1] == '_') {\n            start -= 1;\n        }\n\n        let mut end = char_pos;\n        while end \u003c chars.len() \u0026\u0026 (chars[end].is_alphanumeric() || chars[end] == '_') {\n            end += 1;\n        }\n\n        Some(chars[start..end].iter().collect())\n    }\n\n    fn find_declaration(\n        \u0026self,\n        statements: \u0026[Statement],\n        name: \u0026str,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cSpan\u003e {\n        for stmt in statements {\n            match stmt {\n                Statement::Variable(var_decl) =\u003e {\n                    if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                        if interner.resolve(ident.node) == name {\n                            return Some(ident.span);\n                        }\n                    }\n                }\n                Statement::Function(func_decl) =\u003e {\n                    if interner.resolve(func_decl.name.node) == name {\n                        return Some(func_decl.name.span);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        None\n    }\n}\n\n/// Convert a Span to an LSP Range\nfn span_to_range(span: \u0026Span) -\u003e Range {\n    Range {\n        start: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: (span.column.saturating_sub(1)) as u32,\n        },\n        end: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: ((span.column + span.len()).saturating_sub(1)) as u32,\n        },\n    }\n}\n\nimpl ReferencesProviderTrait for ReferencesProvider {\n    fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        include_declaration: bool,\n    ) -\u003e Vec\u003cLocation\u003e {\n        let _document_manager = None;\n        self.provide_impl(\n            uri,\n            document,\n            position,\n            include_declaration,\n            _document_manager,\n        )\n        .unwrap_or_default()\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":129},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","semantic","mod.rs"],"content":"//! Semantic highlighting features\n\npub mod semantic_lexeme;\npub mod semantic_tokens;\n\npub use semantic_tokens::SemanticTokensProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","semantic","semantic_lexeme.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::ast::expression::{Expression, ExpressionKind};\nuse typedlua_parser::ast::pattern::Pattern;\nuse typedlua_parser::ast::statement::{ClassMember, Statement, VariableKind};\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides semantic tokens for syntax highlighting based on semantic analysis\npub struct SemanticTokensProvider {\n    /// Token types legend (must match what's advertised in server capabilities)\n    token_types: Vec\u003cSemanticTokenType\u003e,\n    /// Token modifiers legend (must match what's advertised in server capabilities)\n    token_modifiers: Vec\u003cSemanticTokenModifier\u003e,\n}\n\n#[allow(dead_code)]\nimpl SemanticTokensProvider {\n    pub fn new() -\u003e Self {\n        Self {\n            token_types: vec![\n                SemanticTokenType::CLASS,\n                SemanticTokenType::INTERFACE,\n                SemanticTokenType::ENUM,\n                SemanticTokenType::TYPE,\n                SemanticTokenType::PARAMETER,\n                SemanticTokenType::VARIABLE,\n                SemanticTokenType::PROPERTY,\n                SemanticTokenType::FUNCTION,\n                SemanticTokenType::METHOD,\n                SemanticTokenType::KEYWORD,\n                SemanticTokenType::COMMENT,\n                SemanticTokenType::STRING,\n                SemanticTokenType::NUMBER,\n            ],\n            token_modifiers: vec![\n                SemanticTokenModifier::DECLARATION,\n                SemanticTokenModifier::READONLY,\n                SemanticTokenModifier::STATIC,\n                SemanticTokenModifier::ABSTRACT,\n                SemanticTokenModifier::DEPRECATED,\n                SemanticTokenModifier::MODIFICATION,\n            ],\n        }\n    }\n\n    /// Provide semantic tokens for the entire document\n    pub fn provide_full(\u0026self, document: \u0026Document) -\u003e SemanticTokens {\n        // Parse the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (_interner, _common_ids) = StringInterner::new_with_common_identifiers();\n        let (mut interner, common_ids) =\n            typedlua_parser::string_interner::StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026mut interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e {\n                return SemanticTokens {\n                    result_id: None,\n                    data: vec![],\n                }\n            }\n        };\n\n        let mut parser = Parser::new(tokens, handler, \u0026mut interner, \u0026common_ids);\n        let ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e {\n                return SemanticTokens {\n                    result_id: None,\n                    data: vec![],\n                }\n            }\n        };\n\n        // Collect semantic tokens from AST\n        let mut tokens_data = Vec::new();\n        let mut last_line = 0;\n        let mut last_char = 0;\n\n        for stmt in \u0026ast.statements {\n            self.collect_tokens_from_statement(\n                stmt,\n                \u0026mut tokens_data,\n                \u0026mut last_line,\n                \u0026mut last_char,\n            );\n        }\n\n        SemanticTokens {\n            result_id: Some(format!(\n                \"{}\",\n                std::time::SystemTime::now()\n                    .duration_since(std::time::UNIX_EPOCH)\n                    .unwrap()\n                    .as_secs()\n            )),\n            data: tokens_data,\n        }\n    }\n\n    /// Provide semantic tokens for a specific range in the document\n    pub fn provide_range(\u0026self, _document: \u0026Document, _range: Range) -\u003e SemanticTokens {\n        // This is useful for visible viewport optimization\n\n        SemanticTokens {\n            result_id: None,\n            data: vec![],\n        }\n    }\n\n    /// Provide semantic tokens delta (incremental update)\n    pub fn provide_full_delta(\n        \u0026self,\n        _document: \u0026Document,\n        _previous_result_id: String,\n    ) -\u003e SemanticTokensDelta {\n        // This is for efficient incremental updates\n\n        SemanticTokensDelta {\n            result_id: None,\n            edits: vec![],\n        }\n    }\n\n    /// Helper: Get token type index for a given semantic token type\n    fn get_token_type_index(\u0026self, token_type: \u0026SemanticTokenType) -\u003e u32 {\n        self.token_types\n            .iter()\n            .position(|t| t == token_type)\n            .unwrap_or(0) as u32\n    }\n\n    /// Helper: Encode token modifiers as a bitset\n    fn encode_modifiers(\u0026self, modifiers: \u0026[SemanticTokenModifier]) -\u003e u32 {\n        let mut result = 0u32;\n        for modifier in modifiers {\n            if let Some(index) = self.token_modifiers.iter().position(|m| m == modifier) {\n                result |= 1 \u003c\u003c index;\n            }\n        }\n        result\n    }\n\n    /// Helper: Create a semantic token entry\n    ///\n    /// LSP semantic tokens use a relative encoding:\n    /// [deltaLine, deltaStartChar, length, tokenType, tokenModifiers]\n    ///\n    /// Each token is encoded relative to the previous token\n    #[allow(dead_code)]\n    fn create_token(\n        \u0026self,\n        delta_line: u32,\n        delta_start: u32,\n        length: u32,\n        token_type: \u0026SemanticTokenType,\n        modifiers: \u0026[SemanticTokenModifier],\n    ) -\u003e Vec\u003cu32\u003e {\n        vec![\n            delta_line,\n            delta_start,\n            length,\n            self.get_token_type_index(token_type),\n            self.encode_modifiers(modifiers),\n        ]\n    }\n\n    /// Helper: Classify a token based on AST node type\n    #[allow(dead_code)]\n    fn classify_token(\u0026self, _node_kind: \u0026str) -\u003e (SemanticTokenType, Vec\u003cSemanticTokenModifier\u003e) {\n        // Examples:\n        // - FunctionDeclaration -\u003e (FUNCTION, [DECLARATION])\n        // - ClassDeclaration -\u003e (CLASS, [DECLARATION])\n        // - VariableDeclaration with const -\u003e (VARIABLE, [DECLARATION, READONLY])\n        // - Parameter -\u003e (PARAMETER, [DECLARATION])\n        // - PropertyAccess -\u003e (PROPERTY, [])\n        // - MethodCall -\u003e (METHOD, [])\n        // - TypeReference -\u003e (TYPE, [])\n\n        (SemanticTokenType::VARIABLE, vec![])\n    }\n\n    /// Collect semantic tokens from a statement\n    fn collect_tokens_from_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let modifiers = if var_decl.kind == VariableKind::Const {\n                        vec![\n                            SemanticTokenModifier::DECLARATION,\n                            SemanticTokenModifier::READONLY,\n                        ]\n                    } else {\n                        vec![SemanticTokenModifier::DECLARATION]\n                    };\n\n                    self.add_token(\n                        \u0026ident.span,\n                        \u0026SemanticTokenType::VARIABLE,\n                        \u0026modifiers,\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                self.add_token(\n                    \u0026func_decl.name.span,\n                    \u0026SemanticTokenType::FUNCTION,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n\n                // Process function body\n                for body_stmt in \u0026func_decl.body.statements {\n                    self.collect_tokens_from_statement(body_stmt, tokens, last_line, last_char);\n                }\n            }\n            Statement::Class(class_decl) =\u003e {\n                self.add_token(\n                    \u0026class_decl.name.span,\n                    \u0026SemanticTokenType::CLASS,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n\n                // Process class members\n                for member in \u0026class_decl.members {\n                    self.collect_tokens_from_class_member(member, tokens, last_line, last_char);\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                self.add_token(\n                    \u0026interface_decl.name.span,\n                    \u0026SemanticTokenType::INTERFACE,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                self.add_token(\n                    \u0026type_decl.name.span,\n                    \u0026SemanticTokenType::TYPE,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                self.add_token(\n                    \u0026enum_decl.name.span,\n                    \u0026SemanticTokenType::ENUM,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::Expression(expr) =\u003e {\n                self.collect_tokens_from_expression(expr, tokens, last_line, last_char);\n            }\n            Statement::If(if_stmt) =\u003e {\n                self.collect_tokens_from_expression(\n                    \u0026if_stmt.condition,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n                for stmt in \u0026if_stmt.then_block.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n                for else_if in \u0026if_stmt.else_ifs {\n                    self.collect_tokens_from_expression(\n                        \u0026else_if.condition,\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                    for stmt in \u0026else_if.block.statements {\n                        self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                    }\n                }\n                if let Some(else_block) = \u0026if_stmt.else_block {\n                    for stmt in \u0026else_block.statements {\n                        self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                    }\n                }\n            }\n            Statement::While(while_stmt) =\u003e {\n                self.collect_tokens_from_expression(\n                    \u0026while_stmt.condition,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n                for stmt in \u0026while_stmt.body.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n            }\n            Statement::Return(ret) =\u003e {\n                for expr in \u0026ret.values {\n                    self.collect_tokens_from_expression(expr, tokens, last_line, last_char);\n                }\n            }\n            Statement::Block(block) =\u003e {\n                for stmt in \u0026block.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Collect semantic tokens from class members\n    fn collect_tokens_from_class_member(\n        \u0026self,\n        member: \u0026ClassMember,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match member {\n            ClassMember::Property(prop) =\u003e {\n                let mut modifiers = vec![SemanticTokenModifier::DECLARATION];\n                if prop.is_static {\n                    modifiers.push(SemanticTokenModifier::STATIC);\n                }\n                if prop.is_readonly {\n                    modifiers.push(SemanticTokenModifier::READONLY);\n                }\n\n                self.add_token(\n                    \u0026prop.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026modifiers,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Method(method) =\u003e {\n                let mut modifiers = vec![SemanticTokenModifier::DECLARATION];\n                if method.is_static {\n                    modifiers.push(SemanticTokenModifier::STATIC);\n                }\n\n                self.add_token(\n                    \u0026method.name.span,\n                    \u0026SemanticTokenType::METHOD,\n                    \u0026modifiers,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Getter(getter) =\u003e {\n                self.add_token(\n                    \u0026getter.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Setter(setter) =\u003e {\n                self.add_token(\n                    \u0026setter.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[\n                        SemanticTokenModifier::DECLARATION,\n                        SemanticTokenModifier::MODIFICATION,\n                    ],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Collect semantic tokens from expressions\n    fn collect_tokens_from_expression(\n        \u0026self,\n        expr: \u0026Expression,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match \u0026expr.kind {\n            ExpressionKind::Identifier(_name) =\u003e {\n                self.add_token(\n                    \u0026expr.span,\n                    \u0026SemanticTokenType::VARIABLE,\n                    \u0026[],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ExpressionKind::Call(callee, args, _types) =\u003e {\n                // Mark function calls\n                if let ExpressionKind::Identifier(_) = \u0026callee.kind {\n                    self.add_token(\n                        \u0026callee.span,\n                        \u0026SemanticTokenType::FUNCTION,\n                        \u0026[],\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                } else {\n                    self.collect_tokens_from_expression(callee, tokens, last_line, last_char);\n                }\n\n                for arg in args {\n                    self.collect_tokens_from_expression(\u0026arg.value, tokens, last_line, last_char);\n                }\n            }\n            ExpressionKind::Member(object, property) =\u003e {\n                self.collect_tokens_from_expression(object, tokens, last_line, last_char);\n                self.add_token(\n                    \u0026property.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ExpressionKind::Binary(_, left, right) =\u003e {\n                self.collect_tokens_from_expression(left, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(right, tokens, last_line, last_char);\n            }\n            ExpressionKind::Unary(_, operand) =\u003e {\n                self.collect_tokens_from_expression(operand, tokens, last_line, last_char);\n            }\n            ExpressionKind::Index(object, index) =\u003e {\n                self.collect_tokens_from_expression(object, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(index, tokens, last_line, last_char);\n            }\n            ExpressionKind::Assignment(target, _, value) =\u003e {\n                self.collect_tokens_from_expression(target, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(value, tokens, last_line, last_char);\n            }\n            ExpressionKind::Conditional(condition, then_expr, else_expr) =\u003e {\n                self.collect_tokens_from_expression(condition, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(then_expr, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(else_expr, tokens, last_line, last_char);\n            }\n            ExpressionKind::Parenthesized(inner) =\u003e {\n                self.collect_tokens_from_expression(inner, tokens, last_line, last_char);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Add a semantic token with delta encoding\n    fn add_token(\n        \u0026self,\n        span: \u0026Span,\n        token_type: \u0026SemanticTokenType,\n        modifiers: \u0026[SemanticTokenModifier],\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        let line = (span.line.saturating_sub(1)) as u32;\n        let start_char = (span.column.saturating_sub(1)) as u32;\n        let length = span.len() as u32;\n\n        // Calculate deltas\n        let delta_line = line.saturating_sub(*last_line);\n        let delta_start = if delta_line == 0 {\n            start_char.saturating_sub(*last_char)\n        } else {\n            start_char\n        };\n\n        tokens.push(SemanticToken {\n            delta_line,\n            delta_start,\n            length,\n            token_type: self.get_token_type_index(token_type),\n            token_modifiers_bitset: self.encode_modifiers(modifiers),\n        });\n\n        // Update last position\n        *last_line = line;\n        *last_char = start_char;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_semantic_tokens_encoding() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test basic variable declaration\n        let doc = Document::new_test(\"local x = 42\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have at least one token for the variable 'x'\n        assert!(!result.data.is_empty());\n        assert!(result.result_id.is_some());\n\n        // Verify first token is for variable 'x'\n        let first_token = \u0026result.data[0];\n        assert_eq!(first_token.delta_line, 0); // First line\n        assert_eq!(first_token.length, 1); // 'x' is 1 character\n\n        // Should have modifiers for DECLARATION\n        assert!(first_token.token_modifiers_bitset \u003e 0);\n    }\n\n    #[test]\n    fn test_function_declaration_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\n            \"function calculateSum(a, b) return a + b end\".to_string(),\n            1,\n        );\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have tokens for the function name\n        assert!(!result.data.is_empty());\n\n        // First token should be for 'calculateSum'\n        let function_token = \u0026result.data[0];\n        assert_eq!(function_token.length, 12); // 'calculateSum' is 12 characters\n\n        // Verify it's a FUNCTION token type\n        let function_type_index = provider.get_token_type_index(\u0026SemanticTokenType::FUNCTION);\n        assert_eq!(function_token.token_type, function_type_index);\n\n        // Should have DECLARATION modifier\n        let declaration_modifiers =\n            provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(function_token.token_modifiers_bitset, declaration_modifiers);\n    }\n\n    #[test]\n    fn test_class_declaration_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\"class Point end\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have at least one token for 'Point'\n        assert!(!result.data.is_empty());\n\n        let class_token = \u0026result.data[0];\n        assert_eq!(class_token.length, 5); // 'Point' is 5 characters\n\n        // Verify it's a CLASS token type\n        let class_type_index = provider.get_token_type_index(\u0026SemanticTokenType::CLASS);\n        assert_eq!(class_token.token_type, class_type_index);\n\n        // Should have DECLARATION modifier\n        let declaration_modifiers =\n            provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(class_token.token_modifiers_bitset, declaration_modifiers);\n    }\n\n    #[test]\n    fn test_const_variable_modifiers() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test const variable\n        let doc = Document::new_test(\"const PI = 3.14159\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        assert!(!result.data.is_empty());\n\n        let const_token = \u0026result.data[0];\n        // Should have both DECLARATION and READONLY modifiers\n        let expected_modifiers = provider.encode_modifiers(\u0026[\n            SemanticTokenModifier::DECLARATION,\n            SemanticTokenModifier::READONLY,\n        ]);\n        assert_eq!(const_token.token_modifiers_bitset, expected_modifiers);\n\n        // Test local (mutable) variable\n        let doc = Document::new_test(\"local mutable = 42\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        assert!(!result.data.is_empty());\n\n        let var_token = \u0026result.data[0];\n        // Should have only DECLARATION modifier\n        let expected_modifiers = provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(var_token.token_modifiers_bitset, expected_modifiers);\n    }\n\n    #[test]\n    fn test_deprecated_modifier() {\n        // This test is a placeholder for when we implement decorator support\n        // For now, we don't parse @deprecated decorators yet\n        assert!(true);\n    }\n\n    #[test]\n    fn test_multiline_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\"local x = 10\\nlocal y = 20\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have tokens for both variables\n        assert!(result.data.len() \u003e= 2);\n\n        // First token (x) should be on line 0\n        let first_token = \u0026result.data[0];\n        assert_eq!(first_token.delta_line, 0);\n\n        // Second token (y) should be on next line (delta_line = 1)\n        let second_token = \u0026result.data[1];\n        assert_eq!(second_token.delta_line, 1);\n    }\n\n    #[test]\n    fn test_token_modifiers_encoding() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test single modifier\n        let declaration_only = provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(declaration_only, 1); // bit 0 = 1\n\n        // Test multiple modifiers\n        let declaration_readonly = provider.encode_modifiers(\u0026[\n            SemanticTokenModifier::DECLARATION,\n            SemanticTokenModifier::READONLY,\n        ]);\n        assert_eq!(declaration_readonly, 3); // 1 | 2 = 3\n\n        // Test different combination\n        let static_modifier = provider.encode_modifiers(\u0026[SemanticTokenModifier::STATIC]);\n        assert_eq!(static_modifier, 4); // bit 2 = 4\n\n        // Test empty modifiers\n        let no_modifiers = provider.encode_modifiers(\u0026[]);\n        assert_eq!(no_modifiers, 0);\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":12}},{"line":23,"address":[],"length":0,"stats":{"Line":24}},{"line":38,"address":[],"length":0,"stats":{"Line":24}},{"line":50,"address":[],"length":0,"stats":{"Line":12}},{"line":52,"address":[],"length":0,"stats":{"Line":36}},{"line":53,"address":[],"length":0,"stats":{"Line":36}},{"line":54,"address":[],"length":0,"stats":{"Line":24}},{"line":55,"address":[],"length":0,"stats":{"Line":12}},{"line":56,"address":[],"length":0,"stats":{"Line":60}},{"line":57,"address":[],"length":0,"stats":{"Line":24}},{"line":58,"address":[],"length":0,"stats":{"Line":24}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":72}},{"line":68,"address":[],"length":0,"stats":{"Line":24}},{"line":69,"address":[],"length":0,"stats":{"Line":24}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":24}},{"line":80,"address":[],"length":0,"stats":{"Line":24}},{"line":81,"address":[],"length":0,"stats":{"Line":24}},{"line":83,"address":[],"length":0,"stats":{"Line":54}},{"line":84,"address":[],"length":0,"stats":{"Line":42}},{"line":85,"address":[],"length":0,"stats":{"Line":28}},{"line":86,"address":[],"length":0,"stats":{"Line":28}},{"line":87,"address":[],"length":0,"stats":{"Line":14}},{"line":88,"address":[],"length":0,"stats":{"Line":14}},{"line":93,"address":[],"length":0,"stats":{"Line":24}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":22}},{"line":130,"address":[],"length":0,"stats":{"Line":22}},{"line":131,"address":[],"length":0,"stats":{"Line":22}},{"line":132,"address":[],"length":0,"stats":{"Line":262}},{"line":133,"address":[],"length":0,"stats":{"Line":22}},{"line":137,"address":[],"length":0,"stats":{"Line":34}},{"line":138,"address":[],"length":0,"stats":{"Line":68}},{"line":139,"address":[],"length":0,"stats":{"Line":102}},{"line":140,"address":[],"length":0,"stats":{"Line":224}},{"line":141,"address":[],"length":0,"stats":{"Line":34}},{"line":144,"address":[],"length":0,"stats":{"Line":34}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":16}},{"line":194,"address":[],"length":0,"stats":{"Line":16}},{"line":195,"address":[],"length":0,"stats":{"Line":10}},{"line":196,"address":[],"length":0,"stats":{"Line":20}},{"line":197,"address":[],"length":0,"stats":{"Line":20}},{"line":198,"address":[],"length":0,"stats":{"Line":2}},{"line":199,"address":[],"length":0,"stats":{"Line":2}},{"line":200,"address":[],"length":0,"stats":{"Line":2}},{"line":203,"address":[],"length":0,"stats":{"Line":16}},{"line":206,"address":[],"length":0,"stats":{"Line":20}},{"line":207,"address":[],"length":0,"stats":{"Line":10}},{"line":208,"address":[],"length":0,"stats":{"Line":10}},{"line":209,"address":[],"length":0,"stats":{"Line":10}},{"line":210,"address":[],"length":0,"stats":{"Line":10}},{"line":211,"address":[],"length":0,"stats":{"Line":10}},{"line":212,"address":[],"length":0,"stats":{"Line":10}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":4}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":2}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":2}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":227,"address":[],"length":0,"stats":{"Line":8}},{"line":228,"address":[],"length":0,"stats":{"Line":10}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":4}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":2}},{"line":235,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":237,"address":[],"length":0,"stats":{"Line":2}},{"line":238,"address":[],"length":0,"stats":{"Line":2}},{"line":242,"address":[],"length":0,"stats":{"Line":2}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":2}},{"line":318,"address":[],"length":0,"stats":{"Line":8}},{"line":319,"address":[],"length":0,"stats":{"Line":10}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":6}},{"line":408,"address":[],"length":0,"stats":{"Line":6}},{"line":409,"address":[],"length":0,"stats":{"Line":8}},{"line":410,"address":[],"length":0,"stats":{"Line":12}},{"line":411,"address":[],"length":0,"stats":{"Line":8}},{"line":412,"address":[],"length":0,"stats":{"Line":8}},{"line":413,"address":[],"length":0,"stats":{"Line":8}},{"line":414,"address":[],"length":0,"stats":{"Line":8}},{"line":415,"address":[],"length":0,"stats":{"Line":4}},{"line":416,"address":[],"length":0,"stats":{"Line":4}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":6}},{"line":450,"address":[],"length":0,"stats":{"Line":14}},{"line":451,"address":[],"length":0,"stats":{"Line":10}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":18}},{"line":486,"address":[],"length":0,"stats":{"Line":54}},{"line":487,"address":[],"length":0,"stats":{"Line":54}},{"line":488,"address":[],"length":0,"stats":{"Line":54}},{"line":491,"address":[],"length":0,"stats":{"Line":72}},{"line":492,"address":[],"length":0,"stats":{"Line":36}},{"line":493,"address":[],"length":0,"stats":{"Line":48}},{"line":495,"address":[],"length":0,"stats":{"Line":2}},{"line":498,"address":[],"length":0,"stats":{"Line":54}},{"line":499,"address":[],"length":0,"stats":{"Line":36}},{"line":500,"address":[],"length":0,"stats":{"Line":36}},{"line":501,"address":[],"length":0,"stats":{"Line":36}},{"line":502,"address":[],"length":0,"stats":{"Line":72}},{"line":503,"address":[],"length":0,"stats":{"Line":36}},{"line":507,"address":[],"length":0,"stats":{"Line":18}},{"line":508,"address":[],"length":0,"stats":{"Line":18}}],"covered":102,"coverable":260},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","semantic","semantic_tokens.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\nuse std::sync::Arc;\nuse typedlua_parser::ast::expression::{Expression, ExpressionKind};\nuse typedlua_parser::ast::pattern::Pattern;\nuse typedlua_parser::ast::statement::{ClassMember, Statement, VariableKind};\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides semantic tokens for syntax highlighting based on semantic analysis\n#[derive(Clone)]\npub struct SemanticTokensProvider {\n    /// Token types legend (must match what's advertised in server capabilities)\n    token_types: Vec\u003cSemanticTokenType\u003e,\n    /// Token modifiers legend (must match what's advertised in server capabilities)\n    token_modifiers: Vec\u003cSemanticTokenModifier\u003e,\n}\n\nimpl SemanticTokensProvider {\n    pub fn new() -\u003e Self {\n        Self {\n            token_types: vec![\n                SemanticTokenType::CLASS,\n                SemanticTokenType::INTERFACE,\n                SemanticTokenType::ENUM,\n                SemanticTokenType::TYPE,\n                SemanticTokenType::PARAMETER,\n                SemanticTokenType::VARIABLE,\n                SemanticTokenType::PROPERTY,\n                SemanticTokenType::FUNCTION,\n                SemanticTokenType::METHOD,\n                SemanticTokenType::KEYWORD,\n                SemanticTokenType::COMMENT,\n                SemanticTokenType::STRING,\n                SemanticTokenType::NUMBER,\n            ],\n            token_modifiers: vec![\n                SemanticTokenModifier::DECLARATION,\n                SemanticTokenModifier::READONLY,\n                SemanticTokenModifier::STATIC,\n                SemanticTokenModifier::ABSTRACT,\n                SemanticTokenModifier::DEPRECATED,\n                SemanticTokenModifier::MODIFICATION,\n            ],\n        }\n    }\n\n    /// Provide semantic tokens for the entire document\n    pub fn provide_full(\u0026self, document: \u0026Document) -\u003e SemanticTokens {\n        // Parse the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e {\n                return SemanticTokens {\n                    result_id: None,\n                    data: vec![],\n                }\n            }\n        };\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e {\n                return SemanticTokens {\n                    result_id: None,\n                    data: vec![],\n                }\n            }\n        };\n\n        // Collect semantic tokens from AST\n        let mut tokens_data = Vec::new();\n        let mut last_line = 0;\n        let mut last_char = 0;\n\n        for stmt in \u0026ast.statements {\n            self.collect_tokens_from_statement(\n                stmt,\n                \u0026mut tokens_data,\n                \u0026mut last_line,\n                \u0026mut last_char,\n            );\n        }\n\n        SemanticTokens {\n            result_id: Some(format!(\n                \"{}\",\n                std::time::SystemTime::now()\n                    .duration_since(std::time::UNIX_EPOCH)\n                    .unwrap()\n                    .as_secs()\n            )),\n            data: tokens_data,\n        }\n    }\n\n    /// Provide semantic tokens for a specific range in the document\n    pub fn provide_range(\u0026self, _document: \u0026Document, _range: Range) -\u003e SemanticTokens {\n        // This is useful for visible viewport optimization\n\n        SemanticTokens {\n            result_id: None,\n            data: vec![],\n        }\n    }\n\n    /// Provide semantic tokens delta (incremental update)\n    pub fn provide_full_delta(\n        \u0026self,\n        _document: \u0026Document,\n        _previous_result_id: String,\n    ) -\u003e SemanticTokensDelta {\n        // This is for efficient incremental updates\n\n        SemanticTokensDelta {\n            result_id: None,\n            edits: vec![],\n        }\n    }\n\n    /// Helper: Get token type index for a given semantic token type\n    fn get_token_type_index(\u0026self, token_type: \u0026SemanticTokenType) -\u003e u32 {\n        self.token_types\n            .iter()\n            .position(|t| t == token_type)\n            .unwrap_or(0) as u32\n    }\n\n    /// Helper: Encode token modifiers as a bitset\n    fn encode_modifiers(\u0026self, modifiers: \u0026[SemanticTokenModifier]) -\u003e u32 {\n        let mut result = 0u32;\n        for modifier in modifiers {\n            if let Some(index) = self.token_modifiers.iter().position(|m| m == modifier) {\n                result |= 1 \u003c\u003c index;\n            }\n        }\n        result\n    }\n\n    /// Helper: Create a semantic token entry\n    ///\n    /// LSP semantic tokens use a relative encoding:\n    /// [deltaLine, deltaStartChar, length, tokenType, tokenModifiers]\n    ///\n    /// Each token is encoded relative to the previous token\n    #[allow(dead_code)]\n    fn create_token(\n        \u0026self,\n        delta_line: u32,\n        delta_start: u32,\n        length: u32,\n        token_type: \u0026SemanticTokenType,\n        modifiers: \u0026[SemanticTokenModifier],\n    ) -\u003e Vec\u003cu32\u003e {\n        vec![\n            delta_line,\n            delta_start,\n            length,\n            self.get_token_type_index(token_type),\n            self.encode_modifiers(modifiers),\n        ]\n    }\n\n    /// Helper: Classify a token based on AST node type\n    #[allow(dead_code)]\n    fn classify_token(\u0026self, _node_kind: \u0026str) -\u003e (SemanticTokenType, Vec\u003cSemanticTokenModifier\u003e) {\n        // Examples:\n        // - FunctionDeclaration -\u003e (FUNCTION, [DECLARATION])\n        // - ClassDeclaration -\u003e (CLASS, [DECLARATION])\n        // - VariableDeclaration with const -\u003e (VARIABLE, [DECLARATION, READONLY])\n        // - Parameter -\u003e (PARAMETER, [DECLARATION])\n        // - PropertyAccess -\u003e (PROPERTY, [])\n        // - MethodCall -\u003e (METHOD, [])\n        // - TypeReference -\u003e (TYPE, [])\n\n        (SemanticTokenType::VARIABLE, vec![])\n    }\n\n    /// Collect semantic tokens from a statement\n    fn collect_tokens_from_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let modifiers = if var_decl.kind == VariableKind::Const {\n                        vec![\n                            SemanticTokenModifier::DECLARATION,\n                            SemanticTokenModifier::READONLY,\n                        ]\n                    } else {\n                        vec![SemanticTokenModifier::DECLARATION]\n                    };\n\n                    self.add_token(\n                        \u0026ident.span,\n                        \u0026SemanticTokenType::VARIABLE,\n                        \u0026modifiers,\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                self.add_token(\n                    \u0026func_decl.name.span,\n                    \u0026SemanticTokenType::FUNCTION,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n\n                // Process function body\n                for body_stmt in \u0026func_decl.body.statements {\n                    self.collect_tokens_from_statement(body_stmt, tokens, last_line, last_char);\n                }\n            }\n            Statement::Class(class_decl) =\u003e {\n                self.add_token(\n                    \u0026class_decl.name.span,\n                    \u0026SemanticTokenType::CLASS,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n\n                // Process class members\n                for member in \u0026class_decl.members {\n                    self.collect_tokens_from_class_member(member, tokens, last_line, last_char);\n                }\n            }\n            Statement::Interface(interface_decl) =\u003e {\n                self.add_token(\n                    \u0026interface_decl.name.span,\n                    \u0026SemanticTokenType::INTERFACE,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::TypeAlias(type_decl) =\u003e {\n                self.add_token(\n                    \u0026type_decl.name.span,\n                    \u0026SemanticTokenType::TYPE,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::Enum(enum_decl) =\u003e {\n                self.add_token(\n                    \u0026enum_decl.name.span,\n                    \u0026SemanticTokenType::ENUM,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            Statement::Expression(expr) =\u003e {\n                self.collect_tokens_from_expression(expr, tokens, last_line, last_char);\n            }\n            Statement::If(if_stmt) =\u003e {\n                self.collect_tokens_from_expression(\n                    \u0026if_stmt.condition,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n                for stmt in \u0026if_stmt.then_block.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n                for else_if in \u0026if_stmt.else_ifs {\n                    self.collect_tokens_from_expression(\n                        \u0026else_if.condition,\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                    for stmt in \u0026else_if.block.statements {\n                        self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                    }\n                }\n                if let Some(else_block) = \u0026if_stmt.else_block {\n                    for stmt in \u0026else_block.statements {\n                        self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                    }\n                }\n            }\n            Statement::While(while_stmt) =\u003e {\n                self.collect_tokens_from_expression(\n                    \u0026while_stmt.condition,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n                for stmt in \u0026while_stmt.body.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n            }\n            Statement::Return(ret) =\u003e {\n                for expr in \u0026ret.values {\n                    self.collect_tokens_from_expression(expr, tokens, last_line, last_char);\n                }\n            }\n            Statement::Block(block) =\u003e {\n                for stmt in \u0026block.statements {\n                    self.collect_tokens_from_statement(stmt, tokens, last_line, last_char);\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Collect semantic tokens from class members\n    fn collect_tokens_from_class_member(\n        \u0026self,\n        member: \u0026ClassMember,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match member {\n            ClassMember::Property(prop) =\u003e {\n                let mut modifiers = vec![SemanticTokenModifier::DECLARATION];\n                if prop.is_static {\n                    modifiers.push(SemanticTokenModifier::STATIC);\n                }\n                if prop.is_readonly {\n                    modifiers.push(SemanticTokenModifier::READONLY);\n                }\n\n                self.add_token(\n                    \u0026prop.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026modifiers,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Method(method) =\u003e {\n                let mut modifiers = vec![SemanticTokenModifier::DECLARATION];\n                if method.is_static {\n                    modifiers.push(SemanticTokenModifier::STATIC);\n                }\n\n                self.add_token(\n                    \u0026method.name.span,\n                    \u0026SemanticTokenType::METHOD,\n                    \u0026modifiers,\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Getter(getter) =\u003e {\n                self.add_token(\n                    \u0026getter.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[SemanticTokenModifier::DECLARATION],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ClassMember::Setter(setter) =\u003e {\n                self.add_token(\n                    \u0026setter.name.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[\n                        SemanticTokenModifier::DECLARATION,\n                        SemanticTokenModifier::MODIFICATION,\n                    ],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Collect semantic tokens from expressions\n    fn collect_tokens_from_expression(\n        \u0026self,\n        expr: \u0026Expression,\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        match \u0026expr.kind {\n            ExpressionKind::Identifier(_name) =\u003e {\n                self.add_token(\n                    \u0026expr.span,\n                    \u0026SemanticTokenType::VARIABLE,\n                    \u0026[],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ExpressionKind::Call(callee, args, _type_args) =\u003e {\n                // Mark function calls\n                if let ExpressionKind::Identifier(_) = \u0026callee.kind {\n                    self.add_token(\n                        \u0026callee.span,\n                        \u0026SemanticTokenType::FUNCTION,\n                        \u0026[],\n                        tokens,\n                        last_line,\n                        last_char,\n                    );\n                } else {\n                    self.collect_tokens_from_expression(callee, tokens, last_line, last_char);\n                }\n\n                for arg in args {\n                    self.collect_tokens_from_expression(\u0026arg.value, tokens, last_line, last_char);\n                }\n            }\n            ExpressionKind::Member(object, property) =\u003e {\n                self.collect_tokens_from_expression(object, tokens, last_line, last_char);\n                self.add_token(\n                    \u0026property.span,\n                    \u0026SemanticTokenType::PROPERTY,\n                    \u0026[],\n                    tokens,\n                    last_line,\n                    last_char,\n                );\n            }\n            ExpressionKind::Binary(_, left, right) =\u003e {\n                self.collect_tokens_from_expression(left, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(right, tokens, last_line, last_char);\n            }\n            ExpressionKind::Unary(_, operand) =\u003e {\n                self.collect_tokens_from_expression(operand, tokens, last_line, last_char);\n            }\n            ExpressionKind::Index(object, index) =\u003e {\n                self.collect_tokens_from_expression(object, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(index, tokens, last_line, last_char);\n            }\n            ExpressionKind::Assignment(target, _, value) =\u003e {\n                self.collect_tokens_from_expression(target, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(value, tokens, last_line, last_char);\n            }\n            ExpressionKind::Conditional(condition, then_expr, else_expr) =\u003e {\n                self.collect_tokens_from_expression(condition, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(then_expr, tokens, last_line, last_char);\n                self.collect_tokens_from_expression(else_expr, tokens, last_line, last_char);\n            }\n            ExpressionKind::Parenthesized(inner) =\u003e {\n                self.collect_tokens_from_expression(inner, tokens, last_line, last_char);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    /// Add a semantic token with delta encoding\n    fn add_token(\n        \u0026self,\n        span: \u0026Span,\n        token_type: \u0026SemanticTokenType,\n        modifiers: \u0026[SemanticTokenModifier],\n        tokens: \u0026mut Vec\u003cSemanticToken\u003e,\n        last_line: \u0026mut u32,\n        last_char: \u0026mut u32,\n    ) {\n        let line = (span.line.saturating_sub(1)) as u32;\n        let start_char = (span.column.saturating_sub(1)) as u32;\n        let length = span.len() as u32;\n\n        // Calculate deltas\n        let delta_line = line.saturating_sub(*last_line);\n        let delta_start = if delta_line == 0 {\n            start_char.saturating_sub(*last_char)\n        } else {\n            start_char\n        };\n\n        tokens.push(SemanticToken {\n            delta_line,\n            delta_start,\n            length,\n            token_type: self.get_token_type_index(token_type),\n            token_modifiers_bitset: self.encode_modifiers(modifiers),\n        });\n\n        // Update last position\n        *last_line = line;\n        *last_char = start_char;\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_semantic_tokens_encoding() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test basic variable declaration\n        let doc = Document::new_test(\"local x = 42\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have at least one token for the variable 'x'\n        assert!(!result.data.is_empty());\n        assert!(result.result_id.is_some());\n\n        // Verify first token is for variable 'x'\n        let first_token = \u0026result.data[0];\n        assert_eq!(first_token.delta_line, 0); // First line\n        assert_eq!(first_token.length, 1); // 'x' is 1 character\n\n        // Should have modifiers for DECLARATION\n        assert!(first_token.token_modifiers_bitset \u003e 0);\n    }\n\n    #[test]\n    fn test_function_declaration_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\n            \"function calculateSum(a, b) return a + b end\".to_string(),\n            1,\n        );\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have tokens for the function name\n        assert!(!result.data.is_empty());\n\n        // First token should be for 'calculateSum'\n        let function_token = \u0026result.data[0];\n        assert_eq!(function_token.length, 12); // 'calculateSum' is 12 characters\n\n        // Verify it's a FUNCTION token type\n        let function_type_index = provider.get_token_type_index(\u0026SemanticTokenType::FUNCTION);\n        assert_eq!(function_token.token_type, function_type_index);\n\n        // Should have DECLARATION modifier\n        let declaration_modifiers =\n            provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(function_token.token_modifiers_bitset, declaration_modifiers);\n    }\n\n    #[test]\n    fn test_class_declaration_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\"class Point end\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have at least one token for 'Point'\n        assert!(!result.data.is_empty());\n\n        let class_token = \u0026result.data[0];\n        assert_eq!(class_token.length, 5); // 'Point' is 5 characters\n\n        // Verify it's a CLASS token type\n        let class_type_index = provider.get_token_type_index(\u0026SemanticTokenType::CLASS);\n        assert_eq!(class_token.token_type, class_type_index);\n\n        // Should have DECLARATION modifier\n        let declaration_modifiers =\n            provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(class_token.token_modifiers_bitset, declaration_modifiers);\n    }\n\n    #[test]\n    fn test_const_variable_modifiers() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test const variable\n        let doc = Document::new_test(\"const PI = 3.14159\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        assert!(!result.data.is_empty());\n\n        let const_token = \u0026result.data[0];\n        // Should have both DECLARATION and READONLY modifiers\n        let expected_modifiers = provider.encode_modifiers(\u0026[\n            SemanticTokenModifier::DECLARATION,\n            SemanticTokenModifier::READONLY,\n        ]);\n        assert_eq!(const_token.token_modifiers_bitset, expected_modifiers);\n\n        // Test local (mutable) variable\n        let doc = Document::new_test(\"local mutable = 42\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        assert!(!result.data.is_empty());\n\n        let var_token = \u0026result.data[0];\n        // Should have only DECLARATION modifier\n        let expected_modifiers = provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(var_token.token_modifiers_bitset, expected_modifiers);\n    }\n\n    #[test]\n    fn test_deprecated_modifier() {\n        // This test is a placeholder for when we implement decorator support\n        // For now, we don't parse @deprecated decorators yet\n        assert!(true);\n    }\n\n    #[test]\n    fn test_multiline_tokens() {\n        let provider = SemanticTokensProvider::new();\n\n        let doc = Document::new_test(\"local x = 10\\nlocal y = 20\".to_string(), 1);\n        let result = provider.provide_full(\u0026doc);\n\n        // Should have tokens for both variables\n        assert!(result.data.len() \u003e= 2);\n\n        // First token (x) should be on line 0\n        let first_token = \u0026result.data[0];\n        assert_eq!(first_token.delta_line, 0);\n\n        // Second token (y) should be on next line (delta_line = 1)\n        let second_token = \u0026result.data[1];\n        assert_eq!(second_token.delta_line, 1);\n    }\n\n    #[test]\n    fn test_token_modifiers_encoding() {\n        let provider = SemanticTokensProvider::new();\n\n        // Test single modifier\n        let declaration_only = provider.encode_modifiers(\u0026[SemanticTokenModifier::DECLARATION]);\n        assert_eq!(declaration_only, 1); // bit 0 = 1\n\n        // Test multiple modifiers\n        let declaration_readonly = provider.encode_modifiers(\u0026[\n            SemanticTokenModifier::DECLARATION,\n            SemanticTokenModifier::READONLY,\n        ]);\n        assert_eq!(declaration_readonly, 3); // 1 | 2 = 3\n\n        // Test different combination\n        let static_modifier = provider.encode_modifiers(\u0026[SemanticTokenModifier::STATIC]);\n        assert_eq!(static_modifier, 4); // bit 2 = 4\n\n        // Test empty modifiers\n        let no_modifiers = provider.encode_modifiers(\u0026[]);\n        assert_eq!(no_modifiers, 0);\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":12}},{"line":23,"address":[],"length":0,"stats":{"Line":24}},{"line":38,"address":[],"length":0,"stats":{"Line":24}},{"line":50,"address":[],"length":0,"stats":{"Line":12}},{"line":52,"address":[],"length":0,"stats":{"Line":36}},{"line":53,"address":[],"length":0,"stats":{"Line":36}},{"line":54,"address":[],"length":0,"stats":{"Line":60}},{"line":55,"address":[],"length":0,"stats":{"Line":24}},{"line":56,"address":[],"length":0,"stats":{"Line":24}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":72}},{"line":66,"address":[],"length":0,"stats":{"Line":24}},{"line":67,"address":[],"length":0,"stats":{"Line":24}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":24}},{"line":78,"address":[],"length":0,"stats":{"Line":24}},{"line":79,"address":[],"length":0,"stats":{"Line":24}},{"line":81,"address":[],"length":0,"stats":{"Line":54}},{"line":82,"address":[],"length":0,"stats":{"Line":42}},{"line":83,"address":[],"length":0,"stats":{"Line":28}},{"line":84,"address":[],"length":0,"stats":{"Line":28}},{"line":85,"address":[],"length":0,"stats":{"Line":14}},{"line":86,"address":[],"length":0,"stats":{"Line":14}},{"line":91,"address":[],"length":0,"stats":{"Line":24}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":22}},{"line":128,"address":[],"length":0,"stats":{"Line":22}},{"line":129,"address":[],"length":0,"stats":{"Line":22}},{"line":130,"address":[],"length":0,"stats":{"Line":262}},{"line":131,"address":[],"length":0,"stats":{"Line":22}},{"line":135,"address":[],"length":0,"stats":{"Line":34}},{"line":136,"address":[],"length":0,"stats":{"Line":68}},{"line":137,"address":[],"length":0,"stats":{"Line":102}},{"line":138,"address":[],"length":0,"stats":{"Line":224}},{"line":139,"address":[],"length":0,"stats":{"Line":34}},{"line":142,"address":[],"length":0,"stats":{"Line":34}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":16}},{"line":192,"address":[],"length":0,"stats":{"Line":16}},{"line":193,"address":[],"length":0,"stats":{"Line":10}},{"line":194,"address":[],"length":0,"stats":{"Line":20}},{"line":195,"address":[],"length":0,"stats":{"Line":20}},{"line":196,"address":[],"length":0,"stats":{"Line":2}},{"line":197,"address":[],"length":0,"stats":{"Line":2}},{"line":198,"address":[],"length":0,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":16}},{"line":204,"address":[],"length":0,"stats":{"Line":20}},{"line":205,"address":[],"length":0,"stats":{"Line":10}},{"line":206,"address":[],"length":0,"stats":{"Line":10}},{"line":207,"address":[],"length":0,"stats":{"Line":10}},{"line":208,"address":[],"length":0,"stats":{"Line":10}},{"line":209,"address":[],"length":0,"stats":{"Line":10}},{"line":210,"address":[],"length":0,"stats":{"Line":10}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":4}},{"line":216,"address":[],"length":0,"stats":{"Line":2}},{"line":217,"address":[],"length":0,"stats":{"Line":2}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":2}},{"line":220,"address":[],"length":0,"stats":{"Line":2}},{"line":221,"address":[],"length":0,"stats":{"Line":2}},{"line":225,"address":[],"length":0,"stats":{"Line":8}},{"line":226,"address":[],"length":0,"stats":{"Line":10}},{"line":229,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":4}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":2}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":234,"address":[],"length":0,"stats":{"Line":2}},{"line":235,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":240,"address":[],"length":0,"stats":{"Line":2}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":2}},{"line":316,"address":[],"length":0,"stats":{"Line":8}},{"line":317,"address":[],"length":0,"stats":{"Line":10}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":6}},{"line":406,"address":[],"length":0,"stats":{"Line":6}},{"line":407,"address":[],"length":0,"stats":{"Line":8}},{"line":408,"address":[],"length":0,"stats":{"Line":12}},{"line":409,"address":[],"length":0,"stats":{"Line":8}},{"line":410,"address":[],"length":0,"stats":{"Line":8}},{"line":411,"address":[],"length":0,"stats":{"Line":8}},{"line":412,"address":[],"length":0,"stats":{"Line":8}},{"line":413,"address":[],"length":0,"stats":{"Line":4}},{"line":414,"address":[],"length":0,"stats":{"Line":4}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":6}},{"line":448,"address":[],"length":0,"stats":{"Line":14}},{"line":449,"address":[],"length":0,"stats":{"Line":10}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":18}},{"line":484,"address":[],"length":0,"stats":{"Line":54}},{"line":485,"address":[],"length":0,"stats":{"Line":54}},{"line":486,"address":[],"length":0,"stats":{"Line":54}},{"line":489,"address":[],"length":0,"stats":{"Line":72}},{"line":490,"address":[],"length":0,"stats":{"Line":36}},{"line":491,"address":[],"length":0,"stats":{"Line":48}},{"line":493,"address":[],"length":0,"stats":{"Line":2}},{"line":496,"address":[],"length":0,"stats":{"Line":54}},{"line":497,"address":[],"length":0,"stats":{"Line":36}},{"line":498,"address":[],"length":0,"stats":{"Line":36}},{"line":499,"address":[],"length":0,"stats":{"Line":36}},{"line":500,"address":[],"length":0,"stats":{"Line":72}},{"line":501,"address":[],"length":0,"stats":{"Line":36}},{"line":505,"address":[],"length":0,"stats":{"Line":18}},{"line":506,"address":[],"length":0,"stats":{"Line":18}}],"covered":100,"coverable":258},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","structure","folding_range.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\n\n/// Provides folding ranges for code sections (functions, blocks, comments)\n#[derive(Clone)]\npub struct FoldingRangeProvider;\n\nimpl FoldingRangeProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide folding ranges for the entire document\n    pub fn provide(\u0026self, document: \u0026Document) -\u003e Vec\u003cFoldingRange\u003e {\n        let mut ranges = Vec::new();\n\n        //   - Function bodies\n        //   - if/then/else blocks\n        //   - while/for loops\n        //   - match expressions\n        //   - Table/array literals\n        //   - Class/interface declarations\n        //   - Multi-line comments\n\n        // For now, implement basic line-based folding by detecting indentation patterns\n        self.find_block_ranges(document, \u0026mut ranges);\n        self.find_comment_ranges(document, \u0026mut ranges);\n\n        ranges\n    }\n\n    /// Find block-based folding ranges (functions, if/then/end, etc.)\n    fn find_block_ranges(\u0026self, document: \u0026Document, ranges: \u0026mut Vec\u003cFoldingRange\u003e) {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        let mut stack: Vec\u003c(usize, FoldingRangeKind)\u003e = Vec::new();\n\n        for (line_num, line) in lines.iter().enumerate() {\n            let trimmed = line.trim_start();\n\n            // Check for block start keywords\n            if self.is_block_start(trimmed) {\n                let kind = self.get_block_kind(trimmed);\n                stack.push((line_num, kind));\n            }\n            // Check for block end\n            else if trimmed.starts_with(\"end\") {\n                if let Some((start_line, kind)) = stack.pop() {\n                    // Only create range if it spans multiple lines\n                    if line_num \u003e start_line {\n                        ranges.push(FoldingRange {\n                            start_line: start_line as u32,\n                            start_character: None,\n                            end_line: line_num as u32,\n                            end_character: None,\n                            kind: Some(kind),\n                            collapsed_text: None,\n                        });\n                    }\n                }\n            }\n            // Check for closing braces (table literals, etc.)\n            else if trimmed.starts_with('}') || trimmed.starts_with(']') {\n                if let Some((start_line, kind)) = stack.pop() {\n                    if line_num \u003e start_line {\n                        ranges.push(FoldingRange {\n                            start_line: start_line as u32,\n                            start_character: None,\n                            end_line: line_num as u32,\n                            end_character: None,\n                            kind: Some(kind),\n                            collapsed_text: None,\n                        });\n                    }\n                }\n            }\n            // Check for opening braces\n            else if trimmed.ends_with('{') || trimmed.ends_with('[') {\n                stack.push((line_num, FoldingRangeKind::Region));\n            }\n        }\n    }\n\n    /// Find multi-line comment ranges for folding\n    fn find_comment_ranges(\u0026self, document: \u0026Document, ranges: \u0026mut Vec\u003cFoldingRange\u003e) {\n        let lines: Vec\u003c\u0026str\u003e = document.text.lines().collect();\n        let mut in_multiline_comment = false;\n        let mut comment_start = 0;\n\n        for (line_num, line) in lines.iter().enumerate() {\n            let trimmed = line.trim_start();\n\n            if !in_multiline_comment {\n                // Start of multi-line comment: --[[\n                if trimmed.contains(\"--[[\") {\n                    in_multiline_comment = true;\n                    comment_start = line_num;\n                }\n                // Consecutive single-line comments (fold if 3+ lines)\n                else if trimmed.starts_with(\"--\") \u0026\u0026 !trimmed.starts_with(\"---\") {\n                    // Check if next lines are also comments\n                }\n            } else {\n                // End of multi-line comment: ]]\n                if trimmed.contains(\"]]\") {\n                    if line_num \u003e comment_start {\n                        ranges.push(FoldingRange {\n                            start_line: comment_start as u32,\n                            start_character: None,\n                            end_line: line_num as u32,\n                            end_character: None,\n                            kind: Some(FoldingRangeKind::Comment),\n                            collapsed_text: None,\n                        });\n                    }\n                    in_multiline_comment = false;\n                }\n            }\n        }\n    }\n\n    fn is_block_start(\u0026self, line: \u0026str) -\u003e bool {\n        line.starts_with(\"function\")\n            || line.starts_with(\"if\")\n            || line.starts_with(\"while\")\n            || line.starts_with(\"for\")\n            || line.starts_with(\"repeat\")\n            || line.starts_with(\"do\")\n            || line.starts_with(\"class\")\n            || line.starts_with(\"interface\")\n            || line.starts_with(\"enum\")\n            || line.starts_with(\"match\")\n    }\n\n    fn get_block_kind(\u0026self, line: \u0026str) -\u003e FoldingRangeKind {\n        if line.starts_with(\"function\") {\n            FoldingRangeKind::Region\n        } else if line.starts_with(\"if\") || line.starts_with(\"else\") {\n            FoldingRangeKind::Region\n        } else if line.starts_with(\"while\") || line.starts_with(\"for\") {\n            FoldingRangeKind::Region\n        } else if line.starts_with(\"class\") {\n            FoldingRangeKind::Region\n        } else if line.starts_with(\"interface\") {\n            FoldingRangeKind::Region\n        } else {\n            FoldingRangeKind::Region\n        }\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":81},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","structure","mod.rs"],"content":"//! Code structure features\n\npub mod folding_range;\npub mod selection_range;\npub mod symbols;\n\npub use folding_range::FoldingRangeProvider;\npub use selection_range::SelectionRangeProvider;\npub use symbols::SymbolsProvider;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","structure","selection_range.rs"],"content":"use crate::core::document::Document;\nuse lsp_types::*;\n\n/// Provides smart selection ranges (expand/shrink selection)\n#[derive(Clone)]\npub struct SelectionRangeProvider;\n\nimpl SelectionRangeProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide selection ranges for the given positions\n    pub fn provide(\u0026self, document: \u0026Document, positions: Vec\u003cPosition\u003e) -\u003e Vec\u003cSelectionRange\u003e {\n        positions\n            .iter()\n            .filter_map(|pos| self.get_selection_range_at_position(document, *pos))\n            .collect()\n    }\n\n    /// Get the selection range hierarchy at a specific position\n    fn get_selection_range_at_position(\n        \u0026self,\n        document: \u0026Document,\n        position: Position,\n    ) -\u003e Option\u003cSelectionRange\u003e {\n        //\n        // Selection hierarchy (from innermost to outermost):\n        // 1. Identifier/literal\n        // 2. Expression\n        // 3. Statement\n        // 4. Block\n        // 5. Function/class body\n        // 6. Entire file\n\n        // For now, provide basic word-based selection\n        let offset = self.position_to_offset(document, position)?;\n        let text = \u0026document.text;\n\n        // Start with word selection\n        let word_range = self.get_word_range(text, offset)?;\n        let word_selection = SelectionRange {\n            range: self.offset_range_to_lsp_range(document, word_range.0, word_range.1)?,\n            parent: None,\n        };\n\n        // Expand to line\n        let line_range = self.get_line_range(text, offset)?;\n        let line_selection = SelectionRange {\n            range: self.offset_range_to_lsp_range(document, line_range.0, line_range.1)?,\n            parent: Some(Box::new(word_selection)),\n        };\n\n        // Expand to surrounding brackets/parentheses\n        if let Some(bracket_range) = self.get_bracket_range(text, offset) {\n            let bracket_selection = SelectionRange {\n                range: self.offset_range_to_lsp_range(\n                    document,\n                    bracket_range.0,\n                    bracket_range.1,\n                )?,\n                parent: Some(Box::new(line_selection)),\n            };\n            return Some(bracket_selection);\n        }\n\n        Some(line_selection)\n    }\n\n    /// Get the range of the word at the given offset\n    fn get_word_range(\u0026self, text: \u0026str, offset: usize) -\u003e Option\u003c(usize, usize)\u003e {\n        if offset \u003e text.len() {\n            return None;\n        }\n\n        let chars: Vec\u003cchar\u003e = text.chars().collect();\n        if offset \u003e= chars.len() {\n            return None;\n        }\n\n        // Find word boundaries\n        let mut start = offset;\n        let mut end = offset;\n\n        // Expand backwards\n        while start \u003e 0 \u0026\u0026 self.is_identifier_char(chars[start - 1]) {\n            start -= 1;\n        }\n\n        // Expand forwards\n        while end \u003c chars.len() \u0026\u0026 self.is_identifier_char(chars[end]) {\n            end += 1;\n        }\n\n        if start \u003c end {\n            Some((start, end))\n        } else {\n            None\n        }\n    }\n\n    /// Get the range of the current line\n    fn get_line_range(\u0026self, text: \u0026str, offset: usize) -\u003e Option\u003c(usize, usize)\u003e {\n        if offset \u003e text.len() {\n            return None;\n        }\n\n        let mut start = offset;\n        let mut end = offset;\n\n        let chars: Vec\u003cchar\u003e = text.chars().collect();\n\n        // Find line start\n        while start \u003e 0 \u0026\u0026 chars[start - 1] != '\\n' {\n            start -= 1;\n        }\n\n        // Find line end\n        while end \u003c chars.len() \u0026\u0026 chars[end] != '\\n' {\n            end += 1;\n        }\n\n        Some((start, end))\n    }\n\n    /// Get the range of content within matching brackets/parentheses\n    fn get_bracket_range(\u0026self, text: \u0026str, offset: usize) -\u003e Option\u003c(usize, usize)\u003e {\n        let chars: Vec\u003cchar\u003e = text.chars().collect();\n        if offset \u003e= chars.len() {\n            return None;\n        }\n\n        // Search backwards for opening bracket\n        let mut pos = offset;\n        let mut depth = 0;\n        let bracket_pairs = vec![('(', ')'), ('[', ']'), ('{', '}')];\n\n        while pos \u003e 0 {\n            pos -= 1;\n            let ch = chars[pos];\n\n            for (open, close) in \u0026bracket_pairs {\n                if ch == *close {\n                    depth += 1;\n                } else if ch == *open {\n                    if depth == 0 {\n                        // Found matching opening bracket\n                        // Now find the closing bracket\n                        if let Some(end) = self.find_closing_bracket(text, pos, *open, *close) {\n                            return Some((pos, end + 1));\n                        }\n                    } else {\n                        depth -= 1;\n                    }\n                }\n            }\n        }\n\n        None\n    }\n\n    /// Find the closing bracket matching the opening bracket at start_pos\n    fn find_closing_bracket(\n        \u0026self,\n        text: \u0026str,\n        start_pos: usize,\n        open: char,\n        close: char,\n    ) -\u003e Option\u003cusize\u003e {\n        let chars: Vec\u003cchar\u003e = text.chars().collect();\n        let mut depth = 0;\n        let mut pos = start_pos;\n\n        while pos \u003c chars.len() {\n            let ch = chars[pos];\n            if ch == open {\n                depth += 1;\n            } else if ch == close {\n                depth -= 1;\n                if depth == 0 {\n                    return Some(pos);\n                }\n            }\n            pos += 1;\n        }\n\n        None\n    }\n\n    /// Check if a character is part of an identifier\n    fn is_identifier_char(\u0026self, ch: char) -\u003e bool {\n        ch.is_alphanumeric() || ch == '_'\n    }\n\n    /// Convert a Position to a byte offset in the document\n    fn position_to_offset(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cusize\u003e {\n        let mut offset = 0;\n        let mut current_line = 0;\n\n        for line in document.text.lines() {\n            if current_line == position.line {\n                return Some(offset + position.character as usize);\n            }\n            offset += line.len() + 1; // +1 for newline\n            current_line += 1;\n        }\n\n        None\n    }\n\n    /// Convert byte offset range to LSP Range\n    fn offset_range_to_lsp_range(\n        \u0026self,\n        document: \u0026Document,\n        start_offset: usize,\n        end_offset: usize,\n    ) -\u003e Option\u003cRange\u003e {\n        let start_pos = self.offset_to_position(document, start_offset)?;\n        let end_pos = self.offset_to_position(document, end_offset)?;\n\n        Some(Range {\n            start: start_pos,\n            end: end_pos,\n        })\n    }\n\n    /// Convert byte offset to Position\n    fn offset_to_position(\u0026self, document: \u0026Document, offset: usize) -\u003e Option\u003cPosition\u003e {\n        let mut current_offset = 0;\n        let mut line = 0;\n\n        for line_text in document.text.lines() {\n            let line_end = current_offset + line_text.len();\n            if offset \u003c= line_end {\n                return Some(Position {\n                    line: line as u32,\n                    character: (offset - current_offset) as u32,\n                });\n            }\n            current_offset = line_end + 1; // +1 for newline\n            line += 1;\n        }\n\n        None\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_word_selection() {\n        let provider = SelectionRangeProvider::new();\n\n        let doc = Document::new_test(\"local my_variable = 42\".to_string(), 1);\n\n        // Cursor on 'my_variable' at position (0, 8)\n        let position = Position {\n            line: 0,\n            character: 8,\n        };\n        let result = provider.get_selection_range_at_position(\u0026doc, position);\n\n        assert!(result.is_some());\n        let selection = result.unwrap();\n\n        // Should select the word \"my_variable\"\n        // The exact range will depend on implementation, just verify we got a selection\n        assert_eq!(selection.range.start.line, 0);\n        assert_eq!(selection.range.end.line, 0);\n\n        // Should have a parent (line selection)\n        assert!(selection.parent.is_some());\n    }\n\n    #[test]\n    fn test_expression_selection() {\n        let provider = SelectionRangeProvider::new();\n\n        let doc = Document::new_test(\"local x = foo(bar(1, 2), 3)\".to_string(), 1);\n\n        // Cursor somewhere in the expression\n        let position = Position {\n            line: 0,\n            character: 15,\n        };\n        let result = provider.get_selection_range_at_position(\u0026doc, position);\n\n        assert!(result.is_some());\n        let selection = result.unwrap();\n\n        // Should have hierarchical selections\n        assert!(selection.parent.is_some());\n    }\n\n    #[test]\n    fn test_bracket_selection() {\n        let provider = SelectionRangeProvider::new();\n\n        let doc = Document::new_test(\"local t = { x = 1, y = 2 }\".to_string(), 1);\n\n        // Cursor inside the table literal\n        let position = Position {\n            line: 0,\n            character: 15,\n        };\n        let result = provider.get_selection_range_at_position(\u0026doc, position);\n\n        // May or may not find selection depending on exact position\n        if let Some(selection) = result {\n            assert_eq!(selection.range.start.line, 0);\n        }\n    }\n\n    #[test]\n    fn test_nested_selection() {\n        let provider = SelectionRangeProvider::new();\n\n        let doc = Document::new_test(\"function foo() local x = 1 end\".to_string(), 1);\n\n        // Cursor on 'x'\n        let position = Position {\n            line: 0,\n            character: 21,\n        };\n        let result = provider.get_selection_range_at_position(\u0026doc, position);\n\n        assert!(result.is_some());\n        let selection = result.unwrap();\n\n        // Should have parent selections\n        assert!(selection.parent.is_some());\n\n        // Verify we can traverse parent chain\n        let mut current = Some(selection);\n        let mut depth = 0;\n        while let Some(sel) = current {\n            depth += 1;\n            current = sel.parent.map(|boxed| *boxed);\n        }\n\n        // Should have multiple levels of selection\n        assert!(depth \u003e 1);\n    }\n\n    #[test]\n    fn test_string_selection() {\n        let provider = SelectionRangeProvider::new();\n\n        let doc = Document::new_test(\"local s = \\\"hello world\\\"\".to_string(), 1);\n\n        // Cursor inside the string\n        let position = Position {\n            line: 0,\n            character: 15,\n        };\n        let result = provider.get_selection_range_at_position(\u0026doc, position);\n\n        assert!(result.is_some());\n        // Just verify we can select within strings\n        let selection = result.unwrap();\n        assert_eq!(selection.range.start.line, 0);\n        assert_eq!(selection.range.end.line, 0);\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":10}},{"line":10,"address":[],"length":0,"stats":{"Line":10}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":10}},{"line":37,"address":[],"length":0,"stats":{"Line":50}},{"line":38,"address":[],"length":0,"stats":{"Line":20}},{"line":41,"address":[],"length":0,"stats":{"Line":50}},{"line":43,"address":[],"length":0,"stats":{"Line":40}},{"line":48,"address":[],"length":0,"stats":{"Line":40}},{"line":50,"address":[],"length":0,"stats":{"Line":40}},{"line":51,"address":[],"length":0,"stats":{"Line":8}},{"line":55,"address":[],"length":0,"stats":{"Line":26}},{"line":57,"address":[],"length":0,"stats":{"Line":4}},{"line":62,"address":[],"length":0,"stats":{"Line":2}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":67,"address":[],"length":0,"stats":{"Line":6}},{"line":71,"address":[],"length":0,"stats":{"Line":10}},{"line":72,"address":[],"length":0,"stats":{"Line":20}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":50}},{"line":77,"address":[],"length":0,"stats":{"Line":20}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":20}},{"line":83,"address":[],"length":0,"stats":{"Line":20}},{"line":86,"address":[],"length":0,"stats":{"Line":110}},{"line":87,"address":[],"length":0,"stats":{"Line":14}},{"line":91,"address":[],"length":0,"stats":{"Line":206}},{"line":92,"address":[],"length":0,"stats":{"Line":26}},{"line":95,"address":[],"length":0,"stats":{"Line":10}},{"line":96,"address":[],"length":0,"stats":{"Line":8}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":8}},{"line":104,"address":[],"length":0,"stats":{"Line":16}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":16}},{"line":109,"address":[],"length":0,"stats":{"Line":16}},{"line":111,"address":[],"length":0,"stats":{"Line":40}},{"line":114,"address":[],"length":0,"stats":{"Line":362}},{"line":115,"address":[],"length":0,"stats":{"Line":118}},{"line":119,"address":[],"length":0,"stats":{"Line":360}},{"line":120,"address":[],"length":0,"stats":{"Line":86}},{"line":123,"address":[],"length":0,"stats":{"Line":8}},{"line":127,"address":[],"length":0,"stats":{"Line":8}},{"line":128,"address":[],"length":0,"stats":{"Line":40}},{"line":129,"address":[],"length":0,"stats":{"Line":16}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":16}},{"line":135,"address":[],"length":0,"stats":{"Line":16}},{"line":136,"address":[],"length":0,"stats":{"Line":40}},{"line":138,"address":[],"length":0,"stats":{"Line":98}},{"line":139,"address":[],"length":0,"stats":{"Line":92}},{"line":140,"address":[],"length":0,"stats":{"Line":184}},{"line":142,"address":[],"length":0,"stats":{"Line":906}},{"line":143,"address":[],"length":0,"stats":{"Line":274}},{"line":144,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":272}},{"line":146,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":12}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":6}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":170,"address":[],"length":0,"stats":{"Line":10}},{"line":171,"address":[],"length":0,"stats":{"Line":4}},{"line":172,"address":[],"length":0,"stats":{"Line":4}},{"line":174,"address":[],"length":0,"stats":{"Line":56}},{"line":175,"address":[],"length":0,"stats":{"Line":56}},{"line":176,"address":[],"length":0,"stats":{"Line":32}},{"line":177,"address":[],"length":0,"stats":{"Line":4}},{"line":178,"address":[],"length":0,"stats":{"Line":28}},{"line":179,"address":[],"length":0,"stats":{"Line":4}},{"line":180,"address":[],"length":0,"stats":{"Line":4}},{"line":181,"address":[],"length":0,"stats":{"Line":2}},{"line":184,"address":[],"length":0,"stats":{"Line":26}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":60}},{"line":192,"address":[],"length":0,"stats":{"Line":142}},{"line":196,"address":[],"length":0,"stats":{"Line":10}},{"line":197,"address":[],"length":0,"stats":{"Line":20}},{"line":198,"address":[],"length":0,"stats":{"Line":20}},{"line":200,"address":[],"length":0,"stats":{"Line":30}},{"line":201,"address":[],"length":0,"stats":{"Line":10}},{"line":202,"address":[],"length":0,"stats":{"Line":10}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":18}},{"line":218,"address":[],"length":0,"stats":{"Line":90}},{"line":219,"address":[],"length":0,"stats":{"Line":90}},{"line":221,"address":[],"length":0,"stats":{"Line":18}},{"line":222,"address":[],"length":0,"stats":{"Line":18}},{"line":223,"address":[],"length":0,"stats":{"Line":18}},{"line":228,"address":[],"length":0,"stats":{"Line":36}},{"line":229,"address":[],"length":0,"stats":{"Line":72}},{"line":230,"address":[],"length":0,"stats":{"Line":72}},{"line":232,"address":[],"length":0,"stats":{"Line":108}},{"line":233,"address":[],"length":0,"stats":{"Line":108}},{"line":234,"address":[],"length":0,"stats":{"Line":36}},{"line":235,"address":[],"length":0,"stats":{"Line":36}},{"line":236,"address":[],"length":0,"stats":{"Line":72}},{"line":237,"address":[],"length":0,"stats":{"Line":36}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}}],"covered":92,"coverable":106},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","features","structure","symbols.rs"],"content":"use crate::core::document::Document;\nuse crate::traits::SymbolsProviderTrait;\nuse lsp_types::*;\n\nuse std::sync::Arc;\nuse typedlua_parser::ast::statement::{ClassMember, OperatorKind, Statement};\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_parser::{Lexer, Parser, Span};\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\n\n/// Provides document symbols (outline view)\n#[derive(Clone)]\npub struct SymbolsProvider;\n\nimpl SymbolsProvider {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Provide all symbols in the document (internal method)\n    pub fn provide_impl(\u0026self, document: \u0026Document) -\u003e Vec\u003cDocumentSymbol\u003e {\n        // Parse the document\n        let handler = Arc::new(CollectingDiagnosticHandler::new());\n        let (interner, common_ids) = StringInterner::new_with_common_identifiers();\n        let mut lexer = Lexer::new(\u0026document.text, handler.clone(), \u0026interner);\n        let tokens = match lexer.tokenize() {\n            Ok(t) =\u003e t,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        let mut parser = Parser::new(tokens, handler, \u0026interner, \u0026common_ids);\n        let ast = match parser.parse() {\n            Ok(a) =\u003e a,\n            Err(_) =\u003e return Vec::new(),\n        };\n\n        // Extract symbols from AST\n        let mut symbols = Vec::new();\n        for stmt in \u0026ast.statements {\n            if let Some(symbol) = self.extract_symbol_from_statement(stmt, \u0026interner) {\n                symbols.push(symbol);\n            }\n        }\n\n        symbols\n    }\n\n    /// Extract a document symbol from a statement\n    #[allow(deprecated)]\n    fn extract_symbol_from_statement(\n        \u0026self,\n        stmt: \u0026Statement,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cDocumentSymbol\u003e {\n        use typedlua_parser::ast::pattern::Pattern;\n\n        match stmt {\n            Statement::Variable(var_decl) =\u003e {\n                if let Pattern::Identifier(ident) = \u0026var_decl.pattern {\n                    let kind = match var_decl.kind {\n                        typedlua_parser::ast::statement::VariableKind::Const =\u003e {\n                            SymbolKind::CONSTANT\n                        }\n                        typedlua_parser::ast::statement::VariableKind::Local =\u003e {\n                            SymbolKind::VARIABLE\n                        }\n                    };\n\n                    Some(DocumentSymbol {\n                        name: interner.resolve(ident.node).to_string(),\n                        detail: None,\n                        kind,\n                        tags: None,\n                        deprecated: None,\n                        range: span_to_range(\u0026var_decl.span),\n                        selection_range: span_to_range(\u0026ident.span),\n                        children: None,\n                    })\n                } else {\n                    None\n                }\n            }\n            Statement::Function(func_decl) =\u003e {\n                let mut children = Vec::new();\n\n                // Add function body statements as children\n                for stmt in \u0026func_decl.body.statements {\n                    if let Some(symbol) = self.extract_symbol_from_statement(stmt, interner) {\n                        children.push(symbol);\n                    }\n                }\n\n                Some(DocumentSymbol {\n                    name: interner.resolve(func_decl.name.node).to_string(),\n                    detail: None,\n                    kind: SymbolKind::FUNCTION,\n                    tags: None,\n                    deprecated: None,\n                    range: span_to_range(\u0026func_decl.span),\n                    selection_range: span_to_range(\u0026func_decl.name.span),\n                    children: if children.is_empty() {\n                        None\n                    } else {\n                        Some(children)\n                    },\n                })\n            }\n            Statement::Class(class_decl) =\u003e {\n                let mut children = Vec::new();\n\n                // Add class members as children\n                for member in \u0026class_decl.members {\n                    if let Some(symbol) = self.extract_symbol_from_class_member(member, interner) {\n                        children.push(symbol);\n                    }\n                }\n\n                Some(DocumentSymbol {\n                    name: interner.resolve(class_decl.name.node).to_string(),\n                    detail: None,\n                    kind: SymbolKind::CLASS,\n                    tags: None,\n                    deprecated: None,\n                    range: span_to_range(\u0026class_decl.span),\n                    selection_range: span_to_range(\u0026class_decl.name.span),\n                    children: if children.is_empty() {\n                        None\n                    } else {\n                        Some(children)\n                    },\n                })\n            }\n            Statement::Interface(interface_decl) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(interface_decl.name.node).to_string(),\n                detail: None,\n                kind: SymbolKind::INTERFACE,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026interface_decl.span),\n                selection_range: span_to_range(\u0026interface_decl.name.span),\n                children: None,\n            }),\n            Statement::TypeAlias(type_decl) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(type_decl.name.node).to_string(),\n                detail: None,\n                kind: SymbolKind::TYPE_PARAMETER,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026type_decl.span),\n                selection_range: span_to_range(\u0026type_decl.name.span),\n                children: None,\n            }),\n            Statement::Enum(enum_decl) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(enum_decl.name.node).to_string(),\n                detail: None,\n                kind: SymbolKind::ENUM,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026enum_decl.span),\n                selection_range: span_to_range(\u0026enum_decl.name.span),\n                children: None,\n            }),\n            _ =\u003e None,\n        }\n    }\n\n    /// Extract a document symbol from a class member\n    fn extract_symbol_from_class_member(\n        \u0026self,\n        member: \u0026ClassMember,\n        interner: \u0026StringInterner,\n    ) -\u003e Option\u003cDocumentSymbol\u003e {\n        match member {\n            ClassMember::Property(prop) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(prop.name.node).to_string(),\n                detail: None,\n                kind: SymbolKind::PROPERTY,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026prop.span),\n                selection_range: span_to_range(\u0026prop.name.span),\n                children: None,\n            }),\n            ClassMember::Constructor(ctor) =\u003e Some(DocumentSymbol {\n                name: \"constructor\".to_string(),\n                detail: None,\n                kind: SymbolKind::CONSTRUCTOR,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026ctor.span),\n                selection_range: span_to_range(\u0026ctor.span),\n                children: None,\n            }),\n            ClassMember::Method(method) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(method.name.node).to_string(),\n                detail: None,\n                kind: SymbolKind::METHOD,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026method.span),\n                selection_range: span_to_range(\u0026method.name.span),\n                children: None,\n            }),\n            ClassMember::Getter(getter) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(getter.name.node).to_string(),\n                detail: Some(\"get\".to_string()),\n                kind: SymbolKind::PROPERTY,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026getter.span),\n                selection_range: span_to_range(\u0026getter.name.span),\n                children: None,\n            }),\n            ClassMember::Setter(setter) =\u003e Some(DocumentSymbol {\n                name: interner.resolve(setter.name.node).to_string(),\n                detail: Some(\"set\".to_string()),\n                kind: SymbolKind::PROPERTY,\n                tags: None,\n                deprecated: None,\n                range: span_to_range(\u0026setter.span),\n                selection_range: span_to_range(\u0026setter.name.span),\n                children: None,\n            }),\n            ClassMember::Operator(op) =\u003e {\n                let op_symbol = match op.operator {\n                    OperatorKind::Add =\u003e \"+\",\n                    OperatorKind::Subtract =\u003e \"-\",\n                    OperatorKind::Multiply =\u003e \"*\",\n                    OperatorKind::Divide =\u003e \"/\",\n                    OperatorKind::Modulo =\u003e \"%\",\n                    OperatorKind::Power =\u003e \"^\",\n                    OperatorKind::Equal =\u003e \"==\",\n                    OperatorKind::NotEqual =\u003e \"~=\",\n                    OperatorKind::LessThan =\u003e \"\u003c\",\n                    OperatorKind::LessThanOrEqual =\u003e \"\u003c=\",\n                    OperatorKind::GreaterThan =\u003e \"\u003e\",\n                    OperatorKind::GreaterThanOrEqual =\u003e \"\u003e=\",\n                    OperatorKind::Concatenate =\u003e \"..\",\n                    OperatorKind::Length =\u003e \"#\",\n                    OperatorKind::Index =\u003e \"[]\",\n                    OperatorKind::NewIndex =\u003e \"[]=\",\n                    OperatorKind::Call =\u003e \"()\",\n                    OperatorKind::UnaryMinus =\u003e \"unm\",\n                    OperatorKind::FloorDivide =\u003e \"//\",\n                    OperatorKind::BitwiseAnd =\u003e \"\u0026\",\n                    OperatorKind::BitwiseOr =\u003e \"|\",\n                    OperatorKind::BitwiseXor =\u003e \"~\",\n                    OperatorKind::ShiftLeft =\u003e \"\u003c\u003c\",\n                    OperatorKind::ShiftRight =\u003e \"\u003e\u003e\",\n                };\n                Some(DocumentSymbol {\n                    name: format!(\"operator {}\", op_symbol),\n                    detail: None,\n                    kind: SymbolKind::OPERATOR,\n                    tags: None,\n                    deprecated: None,\n                    range: span_to_range(\u0026op.span),\n                    selection_range: span_to_range(\u0026op.span),\n                    children: None,\n                })\n            }\n        }\n    }\n}\n\n/// Convert a Span to an LSP Range\nfn span_to_range(span: \u0026Span) -\u003e Range {\n    Range {\n        start: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: (span.column.saturating_sub(1)) as u32,\n        },\n        end: Position {\n            line: (span.line.saturating_sub(1)) as u32,\n            character: ((span.column + span.len()).saturating_sub(1)) as u32,\n        },\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_symbol_kinds() {\n        let provider = SymbolsProvider::new();\n\n        fn extract_symbols(response: DocumentSymbolResponse) -\u003e Vec\u003cDocumentSymbol\u003e {\n            match response {\n                DocumentSymbolResponse::Nested(vec) =\u003e vec,\n                DocumentSymbolResponse::Flat(_) =\u003e Vec::new(),\n            }\n        }\n\n        // Test function symbol\n        let doc = Document::new_test(\"function foo() end\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"foo\");\n        assert_eq!(symbols[0].kind, SymbolKind::FUNCTION);\n\n        // Test variable symbol (local)\n        let doc = Document::new_test(\"local x = 10\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"x\");\n        assert_eq!(symbols[0].kind, SymbolKind::VARIABLE);\n\n        // Test constant symbol\n        let doc = Document::new_test(\"const PI = 3.14\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"PI\");\n        assert_eq!(symbols[0].kind, SymbolKind::CONSTANT);\n\n        // Test class symbol\n        let doc = Document::new_test(\"class Point end\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"Point\");\n        assert_eq!(symbols[0].kind, SymbolKind::CLASS);\n\n        // Test interface symbol\n        let doc = Document::new_test(\"interface Drawable end\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        // Parser might not recognize 'interface' keyword yet\n        if symbols.len() \u003e 0 {\n            assert_eq!(symbols[0].name, \"Drawable\");\n            assert_eq!(symbols[0].kind, SymbolKind::INTERFACE);\n        }\n\n        // Test enum symbol\n        let doc = Document::new_test(\"enum Color { Red, Green, Blue }\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"Color\");\n        assert_eq!(symbols[0].kind, SymbolKind::ENUM);\n\n        // Test type alias symbol\n        let doc = Document::new_test(\"type Point = { x: number, y: number }\".to_string(), 1);\n        let symbols = extract_symbols(provider.provide(\u0026doc));\n        assert_eq!(symbols.len(), 1);\n        assert_eq!(symbols[0].name, \"Point\");\n        assert_eq!(symbols[0].kind, SymbolKind::TYPE_PARAMETER);\n    }\n}\n\nimpl SymbolsProviderTrait for SymbolsProvider {\n    fn provide(\u0026self, document: \u0026Document) -\u003e DocumentSymbolResponse {\n        DocumentSymbolResponse::Nested(self.provide_impl(document))\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":2}},{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":14}},{"line":23,"address":[],"length":0,"stats":{"Line":42}},{"line":24,"address":[],"length":0,"stats":{"Line":42}},{"line":25,"address":[],"length":0,"stats":{"Line":70}},{"line":26,"address":[],"length":0,"stats":{"Line":28}},{"line":27,"address":[],"length":0,"stats":{"Line":28}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":84}},{"line":32,"address":[],"length":0,"stats":{"Line":28}},{"line":33,"address":[],"length":0,"stats":{"Line":28}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":28}},{"line":39,"address":[],"length":0,"stats":{"Line":38}},{"line":40,"address":[],"length":0,"stats":{"Line":60}},{"line":41,"address":[],"length":0,"stats":{"Line":24}},{"line":45,"address":[],"length":0,"stats":{"Line":14}},{"line":50,"address":[],"length":0,"stats":{"Line":12}},{"line":57,"address":[],"length":0,"stats":{"Line":12}},{"line":58,"address":[],"length":0,"stats":{"Line":4}},{"line":59,"address":[],"length":0,"stats":{"Line":8}},{"line":60,"address":[],"length":0,"stats":{"Line":8}},{"line":62,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":4}},{"line":70,"address":[],"length":0,"stats":{"Line":16}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":72,"address":[],"length":0,"stats":{"Line":8}},{"line":73,"address":[],"length":0,"stats":{"Line":8}},{"line":74,"address":[],"length":0,"stats":{"Line":8}},{"line":75,"address":[],"length":0,"stats":{"Line":12}},{"line":76,"address":[],"length":0,"stats":{"Line":8}},{"line":77,"address":[],"length":0,"stats":{"Line":4}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":2}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":87,"address":[],"length":0,"stats":{"Line":2}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":6}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":4}},{"line":100,"address":[],"length":0,"stats":{"Line":4}},{"line":101,"address":[],"length":0,"stats":{"Line":4}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":109,"address":[],"length":0,"stats":{"Line":4}},{"line":112,"address":[],"length":0,"stats":{"Line":2}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":6}},{"line":120,"address":[],"length":0,"stats":{"Line":2}},{"line":122,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":125,"address":[],"length":0,"stats":{"Line":4}},{"line":126,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":4}},{"line":144,"address":[],"length":0,"stats":{"Line":8}},{"line":145,"address":[],"length":0,"stats":{"Line":4}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":4}},{"line":148,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":6}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":151,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":4}},{"line":154,"address":[],"length":0,"stats":{"Line":8}},{"line":155,"address":[],"length":0,"stats":{"Line":4}},{"line":156,"address":[],"length":0,"stats":{"Line":2}},{"line":157,"address":[],"length":0,"stats":{"Line":4}},{"line":158,"address":[],"length":0,"stats":{"Line":4}},{"line":159,"address":[],"length":0,"stats":{"Line":6}},{"line":160,"address":[],"length":0,"stats":{"Line":4}},{"line":161,"address":[],"length":0,"stats":{"Line":2}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":24}},{"line":269,"address":[],"length":0,"stats":{"Line":48}},{"line":273,"address":[],"length":0,"stats":{"Line":24}},{"line":349,"address":[],"length":0,"stats":{"Line":14}},{"line":350,"address":[],"length":0,"stats":{"Line":28}}],"covered":77,"coverable":178},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","impls","compiler_bridge.rs"],"content":"//! Bridge implementations connecting typedlua-typechecker types to LSP traits\n\n#![allow(dead_code)]\n\nuse crate::traits::{\n    diagnostics::RelatedInformation,\n    type_analysis::{Span, SymbolInfo, SymbolKind, SymbolStore, TypeCheckResult, TypeChecker},\n    Diagnostic, DiagnosticCollector, DiagnosticLevel, ModuleIdentifier, ModuleRegistry,\n    ModuleResolver,\n};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse typedlua_parser::lexer::Lexer;\nuse typedlua_parser::parser::Parser;\nuse typedlua_parser::string_interner::StringInterner;\nuse typedlua_typechecker::cli::diagnostics::CollectingDiagnosticHandler;\nuse typedlua_typechecker::module_resolver::{\n    ModuleId as CoreModuleId, ModuleRegistry as CoreModuleRegistryType,\n    ModuleResolver as CoreModuleResolverType,\n};\nuse typedlua_typechecker::{Symbol, SymbolTable, TypeChecker as CoreTypeCheckerType};\n\n// ============================================================================\n// Module Resolution Bridges\n// ============================================================================\n\n/// Bridge implementation wrapping typedlua_typechecker::module_resolver::ModuleId\n#[derive(Clone, Debug, Hash, PartialEq, Eq)]\npub struct CoreModuleIdentifier {\n    inner: CoreModuleId,\n}\n\nimpl CoreModuleIdentifier {\n    pub fn new(inner: CoreModuleId) -\u003e Self {\n        Self { inner }\n    }\n\n    pub fn inner(\u0026self) -\u003e \u0026CoreModuleId {\n        \u0026self.inner\n    }\n\n    pub fn into_inner(self) -\u003e CoreModuleId {\n        self.inner\n    }\n}\n\nimpl ModuleIdentifier for CoreModuleIdentifier {\n    fn from_path(path: PathBuf) -\u003e Self {\n        Self {\n            inner: CoreModuleId::new(path),\n        }\n    }\n\n    fn path(\u0026self) -\u003e \u0026Path {\n        self.inner.path()\n    }\n\n    fn as_str(\u0026self) -\u003e \u0026str {\n        self.inner.as_str()\n    }\n}\n\n/// Bridge implementation wrapping typedlua_core::ModuleResolver\n#[derive(Debug)]\npub struct CoreModuleResolver {\n    inner: Arc\u003cCoreModuleResolverType\u003e,\n}\n\nimpl CoreModuleResolver {\n    pub fn new(inner: Arc\u003cCoreModuleResolverType\u003e) -\u003e Self {\n        Self { inner }\n    }\n}\n\nimpl ModuleResolver for CoreModuleResolver {\n    fn resolve(\u0026self, source: \u0026str, from_file: \u0026Path) -\u003e Result\u003cString, String\u003e {\n        self.inner\n            .resolve(source, from_file)\n            .map(|module_id| module_id.as_str().to_string())\n            .map_err(|e: typedlua_typechecker::module_resolver::ModuleError| e.to_string())\n    }\n}\n\n/// Bridge implementation wrapping typedlua_core::ModuleRegistry\n#[derive(Debug)]\npub struct CoreModuleRegistry {\n    inner: Arc\u003cCoreModuleRegistryType\u003e,\n}\n\nimpl CoreModuleRegistry {\n    pub fn new(inner: Arc\u003cCoreModuleRegistryType\u003e) -\u003e Self {\n        Self { inner }\n    }\n\n    pub fn inner(\u0026self) -\u003e \u0026Arc\u003cCoreModuleRegistryType\u003e {\n        \u0026self.inner\n    }\n}\n\nimpl ModuleRegistry for CoreModuleRegistry {\n    fn has_module(\u0026self, module_id: \u0026str) -\u003e bool {\n        // Convert string to ModuleId and check if module exists\n        let path = PathBuf::from(module_id);\n        let id = CoreModuleId::new(path);\n        self.inner.get_module(\u0026id).is_ok()\n    }\n\n    fn all_modules(\u0026self) -\u003e Vec\u003cString\u003e {\n        // The core ModuleRegistry doesn't expose all modules\n        // This is a limitation of the current abstraction\n        vec![]\n    }\n}\n\n// ============================================================================\n// Symbol Store Bridge\n// ============================================================================\n\n/// Bridge implementation wrapping typedlua_core::SymbolTable\n///\n/// Symbols are converted eagerly at construction time to avoid\n/// storing StringInterner which is not Sync.\npub struct CoreSymbolStore {\n    symbols: Vec\u003cSymbolInfo\u003e,\n}\n\nimpl CoreSymbolStore {\n    pub fn new(symbol_table: \u0026SymbolTable, interner: \u0026StringInterner) -\u003e Self {\n        let symbols = symbol_table\n            .all_visible_symbols()\n            .values()\n            .map(|symbol| Self::convert_symbol(symbol, interner))\n            .collect();\n\n        Self { symbols }\n    }\n\n    fn convert_symbol(symbol: \u0026Symbol, _interner: \u0026StringInterner) -\u003e SymbolInfo {\n        // symbol.name is already a String, no need to resolve\n        SymbolInfo {\n            name: symbol.name.clone(),\n            kind: convert_symbol_kind(\u0026symbol.kind),\n            type_annotation: Some(format!(\"{:?}\", symbol.typ)),\n            span: convert_span(\u0026symbol.span),\n            is_exported: symbol.is_exported,\n            references: symbol.references.iter().map(convert_span).collect(),\n        }\n    }\n}\n\nimpl SymbolStore for CoreSymbolStore {\n    fn get_symbol_at_position(\u0026self, line: usize, column: usize) -\u003e Option\u003cSymbolInfo\u003e {\n        // Find symbol whose span contains the position\n        self.symbols\n            .iter()\n            .find(|symbol| {\n                let span = \u0026symbol.span;\n                span.line == line \u0026\u0026 span.column \u003c= column \u0026\u0026 column \u003c span.column + span.len()\n            })\n            .cloned()\n    }\n\n    fn all_symbols(\u0026self) -\u003e Vec\u003cSymbolInfo\u003e {\n        self.symbols.clone()\n    }\n}\n\n// ============================================================================\n// Type Checker Bridge\n// ============================================================================\n\n/// Bridge implementation wrapping typedlua_core::TypeChecker\npub struct CoreTypeChecker {\n    _marker: std::marker::PhantomData\u003c()\u003e,\n}\n\nimpl CoreTypeChecker {\n    pub fn new() -\u003e Self {\n        Self {\n            _marker: std::marker::PhantomData,\n        }\n    }\n}\n\nimpl Default for CoreTypeChecker {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl TypeChecker for CoreTypeChecker {\n    fn check_document(\u0026self, text: \u0026str) -\u003e TypeCheckResult {\n        // Create string interner and common identifiers\n        let (interner, common) = StringInterner::new_with_common_identifiers();\n\n        // Create diagnostic handler\n        let diagnostic_handler = Arc::new(CollectingDiagnosticHandler::new());\n\n        // Lex the source\n        let mut lexer = Lexer::new(\n            text,\n            diagnostic_handler.clone() as Arc\u003cdyn typedlua_parser::DiagnosticHandler\u003e,\n            \u0026interner,\n        );\n        let tokens = match lexer.tokenize() {\n            Ok(tokens) =\u003e tokens,\n            Err(_) =\u003e {\n                // Lex failed, return diagnostics\n                use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n                let diagnostics = diagnostic_handler\n                    .get_diagnostics()\n                    .iter()\n                    .map(convert_diagnostic)\n                    .collect();\n\n                return TypeCheckResult {\n                    diagnostics,\n                    symbol_info: None,\n                };\n            }\n        };\n\n        // Parse the tokens\n        let mut parser = Parser::new(\n            tokens,\n            diagnostic_handler.clone() as Arc\u003cdyn typedlua_parser::DiagnosticHandler\u003e,\n            \u0026interner,\n            \u0026common,\n        );\n\n        let mut ast = match parser.parse() {\n            Ok(ast) =\u003e ast,\n            Err(_) =\u003e {\n                // Parse failed, return diagnostics\n                use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n                let diagnostics = diagnostic_handler\n                    .get_diagnostics()\n                    .iter()\n                    .map(convert_diagnostic)\n                    .collect();\n\n                return TypeCheckResult {\n                    diagnostics,\n                    symbol_info: None,\n                };\n            }\n        };\n\n        // Type check the AST\n        let mut type_checker = CoreTypeCheckerType::new(\n            diagnostic_handler.clone()\n                as Arc\u003cdyn typedlua_typechecker::cli::diagnostics::DiagnosticHandler\u003e,\n            \u0026interner,\n            \u0026common,\n        );\n        match type_checker.check_program(\u0026mut ast) {\n            Ok(_) =\u003e {\n                use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n                let diagnostics = diagnostic_handler\n                    .get_diagnostics()\n                    .iter()\n                    .map(convert_diagnostic)\n                    .collect();\n\n                let symbol_store =\n                    Box::new(CoreSymbolStore::new(type_checker.symbol_table(), \u0026interner));\n\n                TypeCheckResult {\n                    diagnostics,\n                    symbol_info: Some(symbol_store),\n                }\n            }\n            Err(_) =\u003e {\n                use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n                let diagnostics = diagnostic_handler\n                    .get_diagnostics()\n                    .iter()\n                    .map(convert_diagnostic)\n                    .collect();\n\n                TypeCheckResult {\n                    diagnostics,\n                    symbol_info: None,\n                }\n            }\n        }\n    }\n}\n\n// ============================================================================\n// Diagnostic Collector Bridge\n// ============================================================================\n\n/// Bridge implementation for diagnostic collection\npub struct CoreDiagnosticCollector {\n    _marker: std::marker::PhantomData\u003c()\u003e,\n}\n\nimpl CoreDiagnosticCollector {\n    pub fn new() -\u003e Self {\n        Self {\n            _marker: std::marker::PhantomData,\n        }\n    }\n}\n\nimpl Default for CoreDiagnosticCollector {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl DiagnosticCollector for CoreDiagnosticCollector {\n    fn collect_diagnostics(\u0026self, text: \u0026str) -\u003e Vec\u003cDiagnostic\u003e {\n        let (interner, common) = StringInterner::new_with_common_identifiers();\n        let diagnostic_handler = Arc::new(CollectingDiagnosticHandler::new());\n\n        let mut lexer = Lexer::new(\n            text,\n            diagnostic_handler.clone() as Arc\u003cdyn typedlua_parser::DiagnosticHandler\u003e,\n            \u0026interner,\n        );\n        let tokens = match lexer.tokenize() {\n            Ok(tokens) =\u003e tokens,\n            Err(_) =\u003e {\n                // Return lex diagnostics\n                use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n                return diagnostic_handler\n                    .get_diagnostics()\n                    .iter()\n                    .map(convert_diagnostic)\n                    .collect();\n            }\n        };\n\n        let mut parser = Parser::new(\n            tokens,\n            diagnostic_handler.clone() as Arc\u003cdyn typedlua_parser::DiagnosticHandler\u003e,\n            \u0026interner,\n            \u0026common,\n        );\n        let _ast = parser.parse();\n\n        use typedlua_typechecker::cli::diagnostics::DiagnosticHandler;\n        diagnostic_handler\n            .get_diagnostics()\n            .iter()\n            .map(convert_diagnostic)\n            .collect()\n    }\n}\n\n// ============================================================================\n// Conversion Helpers\n// ============================================================================\n\nfn convert_span(span: \u0026typedlua_parser::Span) -\u003e Span {\n    Span {\n        start: span.start as usize,\n        end: span.end as usize,\n        line: span.line as usize,\n        column: span.column as usize,\n    }\n}\n\nfn convert_symbol_kind(kind: \u0026typedlua_typechecker::SymbolKind) -\u003e SymbolKind {\n    use typedlua_typechecker::SymbolKind as CoreKind;\n    match kind {\n        CoreKind::Variable =\u003e SymbolKind::Variable,\n        CoreKind::Const =\u003e SymbolKind::Const,\n        CoreKind::Function =\u003e SymbolKind::Function,\n        CoreKind::Class =\u003e SymbolKind::Class,\n        CoreKind::Interface =\u003e SymbolKind::Interface,\n        CoreKind::TypeAlias =\u003e SymbolKind::Type,\n        CoreKind::Enum =\u003e SymbolKind::Enum,\n        CoreKind::Parameter =\u003e SymbolKind::Parameter,\n        CoreKind::Namespace =\u003e SymbolKind::Namespace,\n    }\n}\n\nfn convert_diagnostic(diag: \u0026typedlua_typechecker::cli::diagnostics::Diagnostic) -\u003e Diagnostic {\n    use typedlua_typechecker::cli::diagnostics::DiagnosticLevel as CoreLevel;\n\n    let level = match diag.level {\n        CoreLevel::Error =\u003e DiagnosticLevel::Error,\n        CoreLevel::Warning =\u003e DiagnosticLevel::Warning,\n        CoreLevel::Info =\u003e DiagnosticLevel::Info,\n    };\n\n    let span = convert_span(\u0026diag.span);\n\n    let mut diagnostic = Diagnostic::new(span, level, diag.message.clone());\n\n    if let Some(code) = \u0026diag.code {\n        diagnostic = diagnostic.with_code(code.as_str());\n    }\n\n    for related in \u0026diag.related_information {\n        diagnostic = diagnostic.with_related(RelatedInformation {\n            span: convert_span(\u0026related.span),\n            message: related.message.clone(),\n        });\n    }\n\n    diagnostic\n}\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":135},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","impls","mod.rs"],"content":"//! Bridge implementations for typedlua-typechecker types\n//!\n//! These implementations adapt concrete types from typedlua-typechecker\n//! to implement the trait abstractions defined in the traits module.\n\n#[allow(unused_imports)]\npub mod compiler_bridge;\n\n#[allow(unused_imports)]\npub use compiler_bridge::{\n    CoreDiagnosticCollector, CoreModuleIdentifier, CoreModuleRegistry, CoreModuleResolver,\n    CoreSymbolStore, CoreTypeChecker,\n};\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","lib.rs"],"content":"// Library interface for LSP server\n// This allows the LSP components to be tested\n\n#![allow(clippy::all)]\n#![allow(deprecated)]\n\n// Protocol layer\npub mod protocol;\n\n// Core document management\npub mod core;\n\n// Analysis features\npub mod analysis;\n\n// Feature providers organized by category\npub mod features;\n\n// Trait abstractions for type system components\npub mod traits;\n\n// Bridge implementations for typedlua-typechecker types\npub mod impls;\n\n// Dependency injection\npub mod di;\n\n// Message handler (LSP protocol routing)\npub mod message_handler;\n\n// Re-export commonly used types\npub use crate::protocol::LspConnection;\npub use core::{DiagnosticsProvider, Document, DocumentManager};\npub use message_handler::BasicMessageHandler;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","main.rs"],"content":"#![allow(clippy::all)]\n#![allow(deprecated)]\n\nmod core;\nmod di;\nmod features;\nmod impls;\nmod message_handler;\nmod protocol;\nmod traits;\n\nuse crate::protocol::LspConnection;\nuse anyhow::Result;\nuse core::DocumentManager;\nuse lsp_server::{Connection, Message, Notification, Response};\nuse lsp_types::*;\nuse message_handler::MessageHandler;\nuse std::error::Error;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tracing_subscriber::EnvFilter;\nuse typedlua_typechecker::cli::config::CompilerOptions;\nuse typedlua_typechecker::cli::fs::RealFileSystem;\nuse typedlua_typechecker::module_resolver::{ModuleConfig, ModuleRegistry, ModuleResolver};\n\n// Implement LspConnection for the real lsp_server::Connection\nstruct ConnectionWrapper\u003c'a\u003e(\u0026'a Connection);\n\nimpl LspConnection for ConnectionWrapper\u003c'_\u003e {\n    fn send_response(\u0026self, response: Response) -\u003e Result\u003c()\u003e {\n        self.0.sender.send(Message::Response(response))?;\n        Ok(())\n    }\n\n    fn send_notification(\u0026self, notification: Notification) -\u003e Result\u003c()\u003e {\n        self.0.sender.send(Message::Notification(notification))?;\n        Ok(())\n    }\n}\n\nfn main() -\u003e Result\u003c(), Box\u003cdyn Error + Sync + Send\u003e\u003e {\n    // Initialize tracing for LSP server\n    tracing_subscriber::fmt()\n        .with_env_filter(EnvFilter::from_default_env().add_directive(tracing::Level::INFO.into()))\n        .with_writer(std::io::stderr) // LSP uses stdout for protocol, log to stderr\n        .init();\n\n    // Create the LSP connection\n    let (connection, io_threads) = Connection::stdio();\n\n    // Server capabilities\n    let server_capabilities = serde_json::to_value(ServerCapabilities {\n        text_document_sync: Some(TextDocumentSyncCapability::Kind(\n            TextDocumentSyncKind::INCREMENTAL,\n        )),\n        completion_provider: Some(CompletionOptions {\n            trigger_characters: Some(vec![\n                \".\".to_string(),\n                \":\".to_string(),\n                \"@\".to_string(),\n                \"\u003c\".to_string(),\n                \"{\".to_string(),\n                \"(\".to_string(),\n            ]),\n            resolve_provider: Some(true),\n            ..Default::default()\n        }),\n        hover_provider: Some(HoverProviderCapability::Simple(true)),\n        signature_help_provider: Some(SignatureHelpOptions {\n            trigger_characters: Some(vec![\"(\".to_string(), \",\".to_string()]),\n            retrigger_characters: None,\n            work_done_progress_options: WorkDoneProgressOptions::default(),\n        }),\n        definition_provider: Some(OneOf::Left(true)),\n        references_provider: Some(OneOf::Left(true)),\n        document_highlight_provider: Some(OneOf::Left(true)),\n        document_symbol_provider: Some(OneOf::Left(true)),\n        workspace_symbol_provider: Some(OneOf::Left(true)),\n        code_action_provider: Some(CodeActionProviderCapability::Options(CodeActionOptions {\n            code_action_kinds: Some(vec![\n                CodeActionKind::QUICKFIX,\n                CodeActionKind::REFACTOR,\n                CodeActionKind::SOURCE_ORGANIZE_IMPORTS,\n            ]),\n            resolve_provider: Some(true),\n            work_done_progress_options: WorkDoneProgressOptions::default(),\n        })),\n        rename_provider: Some(OneOf::Right(RenameOptions {\n            prepare_provider: Some(true),\n            work_done_progress_options: WorkDoneProgressOptions::default(),\n        })),\n        document_formatting_provider: Some(OneOf::Left(true)),\n        document_range_formatting_provider: Some(OneOf::Left(true)),\n        selection_range_provider: Some(SelectionRangeProviderCapability::Simple(true)),\n        semantic_tokens_provider: Some(SemanticTokensServerCapabilities::SemanticTokensOptions(\n            SemanticTokensOptions {\n                legend: SemanticTokensLegend {\n                    token_types: vec![\n                        SemanticTokenType::CLASS,\n                        SemanticTokenType::INTERFACE,\n                        SemanticTokenType::ENUM,\n                        SemanticTokenType::TYPE,\n                        SemanticTokenType::PARAMETER,\n                        SemanticTokenType::VARIABLE,\n                        SemanticTokenType::PROPERTY,\n                        SemanticTokenType::FUNCTION,\n                        SemanticTokenType::METHOD,\n                        SemanticTokenType::KEYWORD,\n                        SemanticTokenType::COMMENT,\n                        SemanticTokenType::STRING,\n                        SemanticTokenType::NUMBER,\n                    ],\n                    token_modifiers: vec![\n                        SemanticTokenModifier::DECLARATION,\n                        SemanticTokenModifier::READONLY,\n                        SemanticTokenModifier::STATIC,\n                        SemanticTokenModifier::ABSTRACT,\n                        SemanticTokenModifier::DEPRECATED,\n                        SemanticTokenModifier::MODIFICATION,\n                    ],\n                },\n                range: Some(true),\n                full: Some(SemanticTokensFullOptions::Delta { delta: Some(true) }),\n                ..Default::default()\n            },\n        )),\n        inlay_hint_provider: Some(OneOf::Right(InlayHintServerCapabilities::Options(\n            InlayHintOptions {\n                resolve_provider: Some(true),\n                work_done_progress_options: WorkDoneProgressOptions::default(),\n            },\n        ))),\n        document_on_type_formatting_provider: Some(DocumentOnTypeFormattingOptions {\n            first_trigger_character: \"d\".to_string(), // Trigger when typing 'end'\n            more_trigger_character: Some(vec![]),\n        }),\n        folding_range_provider: Some(FoldingRangeProviderCapability::Simple(true)),\n        ..Default::default()\n    })\n    .unwrap();\n\n    // Initialize the connection\n    let initialization_params = connection.initialize(server_capabilities)?;\n    let _params: InitializeParams = serde_json::from_value(initialization_params)?;\n\n    // Run the main loop\n    main_loop(connection, _params)?;\n\n    // Wait for IO threads to finish\n    io_threads.join()?;\n\n    Ok(())\n}\n\nfn main_loop(connection: Connection, params: InitializeParams) -\u003e Result\u003c()\u003e {\n    // Get workspace root from initialization params\n    #[allow(deprecated)] // root_uri is deprecated but still widely used\n    let workspace_root = params\n        .root_uri\n        .and_then(|uri| uri.as_str().strip_prefix(\"file://\").map(PathBuf::from))\n        .unwrap_or_else(|| std::env::current_dir().unwrap_or_else(|_| PathBuf::from(\".\")));\n\n    tracing::info!(\"LSP workspace root: {:?}\", workspace_root);\n\n    // Initialize module system infrastructure\n    let fs = Arc::new(RealFileSystem);\n    let compiler_options = CompilerOptions::default();\n    let module_config = ModuleConfig::from_compiler_options(\u0026compiler_options, \u0026workspace_root);\n\n    // Create module system components\n    let module_registry = Arc::new(ModuleRegistry::new());\n    let module_resolver = Arc::new(ModuleResolver::new(\n        fs,\n        module_config,\n        workspace_root.clone(),\n    ));\n\n    // Create document manager with module system support\n    let mut document_manager =\n        DocumentManager::new(workspace_root, module_registry, module_resolver);\n    let mut message_handler = MessageHandler::new();\n    let connection_wrapper = ConnectionWrapper(\u0026connection);\n\n    for msg in \u0026connection.receiver {\n        match msg {\n            Message::Request(req) =\u003e {\n                if connection.handle_shutdown(\u0026req)? {\n                    return Ok(());\n                }\n\n                message_handler.handle_request(\u0026connection_wrapper, req, \u0026document_manager)?;\n            }\n            Message::Notification(not) =\u003e {\n                message_handler.handle_notification(\n                    \u0026connection_wrapper,\n                    not,\n                    \u0026mut document_manager,\n                )?;\n            }\n            Message::Response(_resp) =\u003e {\n                // Client responses to our requests - we don't currently send any\n            }\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":119},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","message_handler.rs"],"content":"use crate::core::diagnostics::DiagnosticsProvider;\nuse crate::core::DocumentManager;\nuse crate::di::{DiContainer, ServiceLifetime};\nuse crate::features::*;\nuse crate::protocol::LspConnection;\nuse crate::traits::{\n    DefinitionProviderTrait, DiagnosticsProviderTrait, HoverProviderTrait, ReferencesProviderTrait,\n    SymbolsProviderTrait,\n};\nuse anyhow::Result;\nuse lsp_server::{Notification, Response};\nuse tracing;\n\nuse lsp_server::{Request, RequestId};\nuse lsp_types::notification::{\n    DidChangeTextDocument, DidCloseTextDocument, DidOpenTextDocument, DidSaveTextDocument,\n    PublishDiagnostics,\n};\n\nuse lsp_types::request::{\n    CodeActionRequest, CodeActionResolveRequest, Completion, DocumentSymbolRequest,\n    FoldingRangeRequest, Formatting, GotoDefinition, HoverRequest, InlayHintRequest,\n    InlayHintResolveRequest, OnTypeFormatting, PrepareRenameRequest, RangeFormatting, References,\n    Rename, SelectionRangeRequest, SemanticTokensFullDeltaRequest, SemanticTokensFullRequest,\n    SemanticTokensRangeRequest, SignatureHelpRequest, WorkspaceSymbolRequest,\n};\nuse lsp_types::*;\nuse serde::{de::DeserializeOwned, Serialize};\n\n/// Basic message handler for document lifecycle and diagnostics (no type-aware features)\n///\n/// This handler provides core LSP functionality without requiring typedlua-core:\n/// - Document lifecycle (open, change, save, close)\n/// - Publishing diagnostics\n///\n/// Use this when you need LSP document management without full type checking capabilities.\n/// For complete IDE features (completion, hover, goto-definition, etc.), use `MessageHandler`.\n#[allow(dead_code)]\npub struct BasicMessageHandler;\n\n#[allow(dead_code)]\nimpl BasicMessageHandler {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    /// Handle LSP notifications (document lifecycle events)\n    pub fn handle_notification\u003cC: LspConnection\u003e(\n        \u0026self,\n        connection: \u0026C,\n        not: Notification,\n        document_manager: \u0026mut DocumentManager,\n    ) -\u003e Result\u003c()\u003e {\n        match Self::cast_notification::\u003cDidOpenTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                document_manager.open(params);\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidChangeTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                document_manager.change(params);\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidSaveTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                document_manager.save(params);\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidCloseTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                let uri = params.text_document.uri.clone();\n                document_manager.close(params);\n                // Clear diagnostics on close\n                Self::send_notification::\u003cPublishDiagnostics\u003e(\n                    connection,\n                    PublishDiagnosticsParams {\n                        uri,\n                        diagnostics: vec![],\n                        version: None,\n                    },\n                )?;\n                return Ok(());\n            }\n            Err(_not) =\u003e {\n                // Unknown notification, ignore\n            }\n        };\n\n        Ok(())\n    }\n\n    /// Publish diagnostics for a document\n    ///\n    /// This allows external diagnostic providers (like linters) to publish their diagnostics\n    /// through the LSP connection without needing type checking functionality.\n    pub fn publish_diagnostics\u003cC: LspConnection\u003e(\n        \u0026self,\n        connection: \u0026C,\n        uri: \u0026Uri,\n        diagnostics: Vec\u003clsp_types::Diagnostic\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        Self::send_notification::\u003cPublishDiagnostics\u003e(\n            connection,\n            PublishDiagnosticsParams {\n                uri: uri.clone(),\n                diagnostics,\n                version: None,\n            },\n        )?;\n        Ok(())\n    }\n\n    fn cast_notification\u003cN\u003e(not: Notification) -\u003e std::result::Result\u003cN::Params, Notification\u003e\n    where\n        N: lsp_types::notification::Notification,\n        N::Params: DeserializeOwned,\n    {\n        match not.extract(N::METHOD) {\n            Ok(params) =\u003e Ok(params),\n            Err(lsp_server::ExtractError::MethodMismatch(not)) =\u003e Err(not),\n            Err(lsp_server::ExtractError::JsonError { method, error }) =\u003e {\n                tracing::error!(\"Failed to deserialize notification {}: {}\", method, error);\n                Err(Notification::new(\n                    method.to_string(),\n                    serde_json::Value::Null,\n                ))\n            }\n        }\n    }\n\n    fn send_notification\u003cN\u003e(connection: \u0026impl LspConnection, params: N::Params) -\u003e Result\u003c()\u003e\n    where\n        N: lsp_types::notification::Notification,\n        N::Params: Serialize,\n    {\n        let not = Notification::new(N::METHOD.to_string(), params);\n        connection.send_notification(not)?;\n        Ok(())\n    }\n}\n\nimpl Default for BasicMessageHandler {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Full-featured message handler with type-aware LSP capabilities (requires compiler feature)\n///\n/// This handler provides complete IDE functionality including:\n/// - All features from `BasicMessageHandler`\n/// - Type-aware completion\n/// - Hover information\n/// - Go to definition\n/// - Find references\n/// - Rename\n/// - Document symbols\n/// - And more...\n///\n/// Requires the `compiler` feature flag and pulls in typedlua-core as a dependency.\n\npub struct MessageHandler {\n    container: DiContainer,\n}\n\nimpl MessageHandler {\n    pub fn new() -\u003e Self {\n        let mut container = DiContainer::new();\n        Self::register_services(\u0026mut container);\n        Self { container }\n    }\n\n    #[allow(dead_code)]\n    pub fn with_container(container: DiContainer) -\u003e Self {\n        Self { container }\n    }\n\n    fn register_services(container: \u0026mut DiContainer) {\n        container.register(|_| DiagnosticsProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| CompletionProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| HoverProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| DefinitionProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| ReferencesProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| RenameProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| SymbolsProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| FormattingProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| CodeActionsProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| SignatureHelpProvider::new(), ServiceLifetime::Transient);\n        container.register(|_| InlayHintsProvider::new(), ServiceLifetime::Transient);\n        container.register(\n            |_| SelectionRangeProvider::new(),\n            ServiceLifetime::Transient,\n        );\n        container.register(\n            |_| SemanticTokensProvider::new(),\n            ServiceLifetime::Transient,\n        );\n        container.register(|_| FoldingRangeProvider::new(), ServiceLifetime::Transient);\n    }\n\n    #[allow(clippy::too_many_arguments)]\n    pub fn handle_request\u003cC: LspConnection\u003e(\n        \u0026mut self,\n        connection: \u0026C,\n        req: Request,\n        document_manager: \u0026DocumentManager,\n    ) -\u003e Result\u003c()\u003e {\n        match Self::cast_request::\u003cCompletion\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position.text_document.uri;\n                let position = params.text_document_position.position;\n\n                let completion_provider = self.container.resolve::\u003cCompletionProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| completion_provider.provide(doc, position))\n                    .map(CompletionResponse::Array);\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cHoverRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position_params.text_document.uri;\n                let position = params.text_document_position_params.position;\n\n                let hover_provider = self.container.resolve::\u003cHoverProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .and_then(|doc| hover_provider.provide(doc, position));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cGotoDefinition\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position_params.text_document.uri;\n                let position = params.text_document_position_params.position;\n\n                let definition_provider = self.container.resolve::\u003cDefinitionProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .and_then(|doc| definition_provider.provide(uri, doc, position));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cReferences\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position.text_document.uri;\n                let position = params.text_document_position.position;\n                let include_declaration = params.context.include_declaration;\n\n                let references_provider = self.container.resolve::\u003cReferencesProvider\u003e().unwrap();\n                let result = document_manager.get(uri).map(|doc| {\n                    references_provider.provide(uri, doc, position, include_declaration)\n                });\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cPrepareRenameRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let position = params.position;\n\n                let rename_provider = self.container.resolve::\u003cRenameProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .and_then(|doc| rename_provider.prepare(doc, position));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cRename\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position.text_document.uri;\n                let position = params.text_document_position.position;\n                let new_name = \u0026params.new_name;\n\n                let rename_provider = self.container.resolve::\u003cRenameProvider\u003e().unwrap();\n                let result = document_manager.get(uri).and_then(|doc| {\n                    rename_provider.rename(uri, doc, position, new_name, document_manager)\n                });\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cDocumentSymbolRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n\n                let symbols_provider = self.container.resolve::\u003cSymbolsProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| symbols_provider.provide(doc));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cWorkspaceSymbolRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let symbols = document_manager\n                    .symbol_index()\n                    .search_workspace_symbols(\u0026params.query);\n                let response = Response::new_ok(id, Some(symbols));\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cFormatting\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let options = params.options;\n\n                let formatting_provider = self.container.resolve::\u003cFormattingProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| formatting_provider.format_document(doc, options));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cRangeFormatting\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let range = params.range;\n                let options = params.options;\n\n                let formatting_provider = self.container.resolve::\u003cFormattingProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| formatting_provider.format_range(doc, range, options));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cCodeActionRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let range = params.range;\n                let context = params.context;\n\n                let code_actions_provider =\n                    self.container.resolve::\u003cCodeActionsProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| code_actions_provider.provide(uri, doc, range, context));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cSignatureHelpRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position_params.text_document.uri;\n                let position = params.text_document_position_params.position;\n\n                let signature_help_provider =\n                    self.container.resolve::\u003cSignatureHelpProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .and_then(|doc| signature_help_provider.provide(doc, position));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cInlayHintRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let range = params.range;\n\n                let inlay_hints_provider = self.container.resolve::\u003cInlayHintsProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| inlay_hints_provider.provide(doc, range));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cSelectionRangeRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let positions = params.positions;\n\n                let selection_range_provider =\n                    self.container.resolve::\u003cSelectionRangeProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| selection_range_provider.provide(doc, positions));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cFoldingRangeRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n\n                let folding_range_provider =\n                    self.container.resolve::\u003cFoldingRangeProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| folding_range_provider.provide(doc));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cSemanticTokensFullRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n\n                let semantic_tokens_provider =\n                    self.container.resolve::\u003cSemanticTokensProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| semantic_tokens_provider.provide_full(doc))\n                    .map(SemanticTokensResult::Tokens);\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cSemanticTokensRangeRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let range = params.range;\n\n                let semantic_tokens_provider =\n                    self.container.resolve::\u003cSemanticTokensProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| semantic_tokens_provider.provide_range(doc, range))\n                    .map(SemanticTokensRangeResult::Tokens);\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cSemanticTokensFullDeltaRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document.uri;\n                let previous_result_id = params.previous_result_id;\n\n                let semantic_tokens_provider =\n                    self.container.resolve::\u003cSemanticTokensProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| semantic_tokens_provider.provide_full_delta(doc, previous_result_id))\n                    .map(SemanticTokensFullDeltaResult::TokensDelta);\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cCodeActionResolveRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let code_actions_provider =\n                    self.container.resolve::\u003cCodeActionsProvider\u003e().unwrap();\n                let result = code_actions_provider.resolve(params);\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cInlayHintResolveRequest\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let inlay_hints_provider = self.container.resolve::\u003cInlayHintsProvider\u003e().unwrap();\n                let result = inlay_hints_provider.resolve(params);\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(req) =\u003e req,\n        };\n\n        match Self::cast_request::\u003cOnTypeFormatting\u003e(req.clone()) {\n            Ok((id, params)) =\u003e {\n                let uri = \u0026params.text_document_position.text_document.uri;\n                let position = params.text_document_position.position;\n                let ch = \u0026params.ch;\n                let options = params.options;\n\n                let formatting_provider = self.container.resolve::\u003cFormattingProvider\u003e().unwrap();\n                let result = document_manager\n                    .get(uri)\n                    .map(|doc| formatting_provider.format_on_type(doc, position, ch, options));\n\n                let response = Response::new_ok(id, result);\n                connection.send_response(response)?;\n                return Ok(());\n            }\n            Err(_req) =\u003e {\n                // Unknown request, ignore\n            }\n        };\n\n        Ok(())\n    }\n\n    pub fn handle_notification\u003cC: LspConnection\u003e(\n        \u0026mut self,\n        connection: \u0026C,\n        not: Notification,\n        document_manager: \u0026mut DocumentManager,\n    ) -\u003e Result\u003c()\u003e {\n        match Self::cast_notification::\u003cDidOpenTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                let uri = params.text_document.uri.clone();\n                document_manager.open(params);\n                self.publish_diagnostics(connection, \u0026uri, document_manager)?;\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidChangeTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                let uri = params.text_document.uri.clone();\n                document_manager.change(params);\n                self.publish_diagnostics(connection, \u0026uri, document_manager)?;\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidSaveTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                let uri = params.text_document.uri.clone();\n                document_manager.save(params);\n                self.publish_diagnostics(connection, \u0026uri, document_manager)?;\n                return Ok(());\n            }\n            Err(not) =\u003e not,\n        };\n\n        match Self::cast_notification::\u003cDidCloseTextDocument\u003e(not.clone()) {\n            Ok(params) =\u003e {\n                let uri = params.text_document.uri.clone();\n                document_manager.close(params);\n                // Clear diagnostics on close\n                Self::send_notification::\u003cPublishDiagnostics\u003e(\n                    connection,\n                    PublishDiagnosticsParams {\n                        uri,\n                        diagnostics: vec![],\n                        version: None,\n                    },\n                )?;\n                return Ok(());\n            }\n            Err(_not) =\u003e {\n                // Unknown notification, ignore\n            }\n        };\n\n        Ok(())\n    }\n\n    fn publish_diagnostics\u003cC: LspConnection\u003e(\n        \u0026mut self,\n        connection: \u0026C,\n        uri: \u0026Uri,\n        document_manager: \u0026DocumentManager,\n    ) -\u003e Result\u003c()\u003e {\n        if let Some(document) = document_manager.get(uri) {\n            let diagnostics_provider = self.container.resolve::\u003cDiagnosticsProvider\u003e().unwrap();\n            let diagnostics = diagnostics_provider.provide(document);\n            Self::send_notification::\u003cPublishDiagnostics\u003e(\n                connection,\n                PublishDiagnosticsParams {\n                    uri: uri.clone(),\n                    diagnostics,\n                    version: None,\n                },\n            )?;\n        }\n        Ok(())\n    }\n\n    fn cast_request\u003cR\u003e(req: Request) -\u003e std::result::Result\u003c(RequestId, R::Params), Request\u003e\n    where\n        R: lsp_types::request::Request,\n        R::Params: DeserializeOwned,\n    {\n        match req.extract(R::METHOD) {\n            Ok(params) =\u003e Ok(params),\n            Err(lsp_server::ExtractError::MethodMismatch(req)) =\u003e Err(req),\n            Err(lsp_server::ExtractError::JsonError { method, error }) =\u003e {\n                tracing::error!(\"Failed to deserialize request {}: {}\", method, error);\n                Err(Request::new(\n                    RequestId::from(0),\n                    method.to_string(),\n                    serde_json::Value::Null,\n                ))\n            }\n        }\n    }\n\n    fn cast_notification\u003cN\u003e(not: Notification) -\u003e std::result::Result\u003cN::Params, Notification\u003e\n    where\n        N: lsp_types::notification::Notification,\n        N::Params: DeserializeOwned,\n    {\n        match not.extract(N::METHOD) {\n            Ok(params) =\u003e Ok(params),\n            Err(lsp_server::ExtractError::MethodMismatch(not)) =\u003e Err(not),\n            Err(lsp_server::ExtractError::JsonError { method, error }) =\u003e {\n                tracing::error!(\"Failed to deserialize notification {}: {}\", method, error);\n                Err(Notification::new(\n                    method.to_string(),\n                    serde_json::Value::Null,\n                ))\n            }\n        }\n    }\n\n    fn send_notification\u003cN\u003e(connection: \u0026impl LspConnection, params: N::Params) -\u003e Result\u003c()\u003e\n    where\n        N: lsp_types::notification::Notification,\n        N::Params: Serialize,\n    {\n        let not = Notification::new(N::METHOD.to_string(), params);\n        connection.send_notification(not)?;\n        Ok(())\n    }\n}\n\nimpl Default for MessageHandler {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":399},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","protocol","connection.rs"],"content":"//! LSP protocol connection abstractions\n\nuse anyhow::Result;\nuse lsp_server::{Notification, Response};\n\n/// Trait for sending LSP messages - allows mocking for tests\npub trait LspConnection {\n    fn send_response(\u0026self, response: Response) -\u003e Result\u003c()\u003e;\n    fn send_notification(\u0026self, notification: Notification) -\u003e Result\u003c()\u003e;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","protocol","mod.rs"],"content":"//! LSP protocol infrastructure\n\npub mod connection;\n\npub use connection::LspConnection;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","traits","diagnostics.rs"],"content":"//! Diagnostic traits for decoupling from typedlua-core diagnostics\n\n#![allow(dead_code)]\n\nuse super::type_analysis::Span;\n\n/// Trait for collecting diagnostics during parsing/type checking\npub trait DiagnosticCollector: Send + Sync {\n    /// Collect all diagnostics from parsing and checking a document\n    ///\n    /// # Arguments\n    /// * `text` - The source code to analyze\n    ///\n    /// # Returns\n    /// Vector of diagnostics (errors, warnings, info)\n    fn collect_diagnostics(\u0026self, text: \u0026str) -\u003e Vec\u003cDiagnostic\u003e;\n}\n\n/// LSP-compatible diagnostic\n///\n/// Represents an error, warning, or informational message without\n/// depending on typedlua-core diagnostic types.\n#[derive(Debug, Clone)]\npub struct Diagnostic {\n    /// Source location of the diagnostic\n    pub span: Span,\n\n    /// Severity level\n    pub level: DiagnosticLevel,\n\n    /// Human-readable message\n    pub message: String,\n\n    /// Optional diagnostic code\n    pub code: Option\u003cString\u003e,\n\n    /// Optional related information\n    pub related: Vec\u003cRelatedInformation\u003e,\n}\n\nimpl Diagnostic {\n    /// Create a new diagnostic\n    pub fn new(span: Span, level: DiagnosticLevel, message: String) -\u003e Self {\n        Self {\n            span,\n            level,\n            message,\n            code: None,\n            related: Vec::new(),\n        }\n    }\n\n    /// Create an error diagnostic\n    pub fn error(span: Span, message: String) -\u003e Self {\n        Self::new(span, DiagnosticLevel::Error, message)\n    }\n\n    /// Create a warning diagnostic\n    pub fn warning(span: Span, message: String) -\u003e Self {\n        Self::new(span, DiagnosticLevel::Warning, message)\n    }\n\n    /// Create an info diagnostic\n    pub fn info(span: Span, message: String) -\u003e Self {\n        Self::new(span, DiagnosticLevel::Info, message)\n    }\n\n    /// Add a diagnostic code\n    pub fn with_code(mut self, code: impl Into\u003cString\u003e) -\u003e Self {\n        self.code = Some(code.into());\n        self\n    }\n\n    /// Add related information\n    pub fn with_related(mut self, related: RelatedInformation) -\u003e Self {\n        self.related.push(related);\n        self\n    }\n}\n\n/// Diagnostic severity level\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum DiagnosticLevel {\n    /// Error that prevents compilation\n    Error,\n\n    /// Warning that should be addressed\n    Warning,\n\n    /// Informational message\n    Info,\n\n    /// Hint for improvement\n    Hint,\n}\n\n/// Related information for a diagnostic\n#[derive(Debug, Clone)]\npub struct RelatedInformation {\n    /// Location of the related information\n    pub span: Span,\n\n    /// Message explaining the relationship\n    pub message: String,\n}\n","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","traits","mod.rs"],"content":"//! Trait abstractions for decoupling LSP from type checker implementation\n//!\n//! This module provides trait-based abstractions that allow the LSP\n//! to work with different implementations (typechecker-based, mock, etc.)\n//! without hard dependencies on specific type checker implementations.\n//!\n//! ## Traits\n//!\n//! These traits are used for dependency injection in the LSP server.\n//! They allow for:\n//! - Easier testing with mock implementations\n//! - Potential future substitution of different type checker backends\n//! - Better separation of concerns between LSP protocol and type checking\n//!\n//! These traits are intentionally defined but not yet wired up to the main\n//! LSP handlers. They are here to enable future refactoring without API changes.\n//! The `#[allow(dead_code)]` attributes are necessary because these traits\n//! are defined but their implementations are instantiated directly in handlers\n//! rather than injected via the trait type.\n\nuse crate::core::document::Document;\nuse lsp_types::*;\n\npub mod diagnostics;\npub mod module_resolution;\npub mod type_analysis;\n\n#[allow(unused_imports)]\npub use diagnostics::{Diagnostic, DiagnosticCollector, DiagnosticLevel};\n#[allow(unused_imports)]\npub use module_resolution::{ModuleIdentifier, ModuleRegistry, ModuleResolver};\n#[allow(unused_imports)]\npub use type_analysis::{SymbolInfo, SymbolKind, SymbolStore, TypeCheckResult, TypeChecker};\n\n/// Trait for providing code completion items.\n///\n/// Used by the LSP completion feature to suggest code completions\n/// at a given cursor position.\n#[allow(dead_code)]\npub trait CompletionProviderTrait {\n    fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Vec\u003cCompletionItem\u003e;\n    fn resolve(\u0026self, item: CompletionItem) -\u003e CompletionItem;\n}\n\n/// Trait for providing hover information.\n///\n/// Used by the LSP hover feature to show type information\n/// and documentation when hovering over symbols.\n#[allow(dead_code)]\npub trait HoverProviderTrait {\n    fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cHover\u003e;\n}\n\n/// Trait for providing goto definition functionality.\n///\n/// Used by the LSP definition feature to navigate from a symbol\n/// reference to its declaration.\n#[allow(dead_code)]\npub trait DefinitionProviderTrait {\n    fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n    ) -\u003e Option\u003cGotoDefinitionResponse\u003e;\n}\n\n/// Trait for providing find references functionality.\n///\n/// Used by the LSP references feature to find all references\n/// to a symbol at a given position.\n#[allow(dead_code)]\npub trait ReferencesProviderTrait {\n    fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        include_declaration: bool,\n    ) -\u003e Vec\u003cLocation\u003e;\n}\n\n/// Trait for providing rename refactoring functionality.\n///\n/// Used by the LSP rename feature to safely rename symbols\n/// across the entire project.\n#[allow(dead_code)]\npub trait RenameProviderTrait {\n    fn prepare(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cRange\u003e;\n    fn rename(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        position: Position,\n        new_name: \u0026str,\n    ) -\u003e Option\u003cWorkspaceEdit\u003e;\n}\n\n/// Trait for providing document symbols outline.\n///\n/// Used by the LSP document symbols feature to show the\n/// structure of a file (classes, functions, variables, etc.).\n#[allow(dead_code)]\npub trait SymbolsProviderTrait {\n    fn provide(\u0026self, document: \u0026Document) -\u003e DocumentSymbolResponse;\n}\n\n/// Trait for providing document formatting.\n///\n/// Used by the LSP formatting features:\n/// - Document formatting (whole file)\n/// - Range formatting (selection)\n/// - On-type formatting (after typing specific characters)\n#[allow(dead_code)]\npub trait FormattingProviderTrait {\n    fn format_document(\u0026self, document: \u0026Document, options: FormattingOptions) -\u003e Option\u003cString\u003e;\n    fn format_range(\n        \u0026self,\n        document: \u0026Document,\n        range: Range,\n        options: FormattingOptions,\n    ) -\u003e Option\u003cString\u003e;\n    fn format_on_type(\n        \u0026self,\n        document: \u0026Document,\n        position: Position,\n        ch: \u0026str,\n        options: FormattingOptions,\n    ) -\u003e Option\u003cString\u003e;\n}\n\n/// Trait for providing code actions and quick fixes.\n///\n/// Used by the LSP code actions feature to suggest and apply\n/// refactorings, fixes, and refactorings at a given position.\n#[allow(dead_code)]\npub trait CodeActionsProviderTrait {\n    fn provide(\n        \u0026self,\n        uri: \u0026Uri,\n        document: \u0026Document,\n        range: Range,\n        context: CodeActionContext,\n    ) -\u003e Option\u003cCodeActionResponse\u003e;\n    fn resolve(\u0026self, item: CodeAction) -\u003e Option\u003cCodeAction\u003e;\n}\n\n/// Trait for providing signature help.\n///\n/// Used by the LSP signature help feature to show function\n/// parameter information when typing opening parenthesis.\n#[allow(dead_code)]\npub trait SignatureHelpProviderTrait {\n    fn provide(\u0026self, document: \u0026Document, position: Position) -\u003e Option\u003cSignatureHelp\u003e;\n}\n\n/// Trait for providing inlay hints.\n///\n/// Used by the LSP inlay hints feature to show inline hints\n/// for types, parameter names, etc.\n#[allow(dead_code)]\npub trait InlayHintsProviderTrait {\n    fn provide(\u0026self, document: \u0026Document, range: Range) -\u003e Option\u003cVec\u003cInlayHint\u003e\u003e;\n    fn resolve(\u0026self, item: InlayHint) -\u003e Option\u003cInlayHint\u003e;\n}\n\n/// Trait for providing selection ranges.\n///\n/// Used by the LSP selection ranges feature to support\n/// smart selection expansion.\n#[allow(dead_code)]\npub trait SelectionRangeProviderTrait {\n    fn provide(\u0026self, document: \u0026Document, positions: Vec\u003cPosition\u003e) -\u003e Vec\u003cSelectionRange\u003e;\n}\n\n/// Trait for providing folding ranges.\n///\n/// Used by the LSP folding ranges feature to show\n/// collapsible regions in the editor.\n#[allow(dead_code)]\npub trait FoldingRangeProviderTrait {\n    fn provide(\u0026self, document: \u0026Document) -\u003e Vec\u003cFoldingRange\u003e;\n}\n\n/// Trait for providing semantic tokens.\n///\n/// Used by the LSP semantic tokens feature for syntax\n/// highlighting of identifiers, types, etc.\n#[allow(dead_code)]\npub trait SemanticTokensProviderTrait {\n    fn provide_full(\u0026self, document: \u0026Document) -\u003e Option\u003cVec\u003cSemanticToken\u003e\u003e;\n    fn provide_range(\u0026self, document: \u0026Document, range: Range) -\u003e Option\u003cVec\u003cSemanticToken\u003e\u003e;\n    fn provide_full_delta(\n        \u0026self,\n        document: \u0026Document,\n        previous_result_id: Option\u003cString\u003e,\n    ) -\u003e Option\u003cSemanticTokensDelta\u003e;\n}\n\n/// Trait for providing diagnostics.\n///\n/// Used by the LSP diagnostics feature to report type errors,\n/// warnings, and other issues to the editor.\n#[allow(dead_code)]\npub trait DiagnosticsProviderTrait {\n    fn provide(\u0026self, document: \u0026Document) -\u003e Vec\u003clsp_types::Diagnostic\u003e;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","traits","module_resolution.rs"],"content":"//! Module resolution traits for decoupling from typedlua-core module system\n\n#![allow(dead_code)]\n\nuse std::fmt;\nuse std::hash::Hash;\nuse std::path::{Path, PathBuf};\n\n/// Trait for resolving module imports to file paths\npub trait ModuleResolver: Send + Sync + fmt::Debug {\n    /// Resolve an import specifier to an absolute module path\n    ///\n    /// # Arguments\n    /// * `source` - The import specifier (e.g., \"./foo\", \"@/bar\")\n    /// * `from_file` - The file containing the import\n    ///\n    /// # Returns\n    /// The resolved absolute path as a string, or error message\n    fn resolve(\u0026self, source: \u0026str, from_file: \u0026Path) -\u003e Result\u003cString, String\u003e;\n}\n\n/// Trait for module identification\n///\n/// Provides a language-agnostic way to identify modules without\n/// depending on concrete ModuleId implementation from typedlua-core.\npub trait ModuleIdentifier: Clone + fmt::Debug + Hash + Eq + Send + Sync {\n    /// Create a module identifier from a file path\n    fn from_path(path: PathBuf) -\u003e Self;\n\n    /// Get the file path for this module\n    fn path(\u0026self) -\u003e \u0026Path;\n\n    /// Get a string representation of this module ID\n    fn as_str(\u0026self) -\u003e \u0026str;\n}\n\n/// Trait for module registry operations\n///\n/// The module registry tracks cross-file symbols and dependencies.\n/// Currently minimal as most functionality is reserved for future\n/// cross-file type checking features.\npub trait ModuleRegistry: Send + Sync + fmt::Debug {\n    /// Check if a module is registered\n    fn has_module(\u0026self, module_id: \u0026str) -\u003e bool;\n\n    /// Get all registered module IDs\n    fn all_modules(\u0026self) -\u003e Vec\u003cString\u003e;\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","forge18","Repos","typedlua-lsp","src","traits","type_analysis.rs"],"content":"//! Type analysis traits for decoupling from typedlua-core type checker\n\n#![allow(dead_code)]\n\nuse super::diagnostics::Diagnostic;\n\n/// Trait for type checking documents\npub trait TypeChecker: Send + Sync {\n    /// Type check a document and return diagnostics and symbol information\n    ///\n    /// # Arguments\n    /// * `text` - The source code to type check\n    ///\n    /// # Returns\n    /// Type checking result with diagnostics and optional symbol store\n    fn check_document(\u0026self, text: \u0026str) -\u003e TypeCheckResult;\n}\n\n/// Result of type checking a document\npub struct TypeCheckResult {\n    /// Diagnostics (errors, warnings) from type checking\n    pub diagnostics: Vec\u003cDiagnostic\u003e,\n\n    /// Symbol information extracted during type checking\n    pub symbol_info: Option\u003cBox\u003cdyn SymbolStore\u003e\u003e,\n}\n\n/// Trait for symbol table storage\n///\n/// Provides access to symbol information without depending on\n/// concrete SymbolTable implementation from typedlua-core.\npub trait SymbolStore: Send + Sync {\n    /// Get symbol at a specific position\n    ///\n    /// # Arguments\n    /// * `line` - Zero-indexed line number\n    /// * `column` - Zero-indexed column number\n    ///\n    /// # Returns\n    /// Symbol information if a symbol exists at that position\n    fn get_symbol_at_position(\u0026self, line: usize, column: usize) -\u003e Option\u003cSymbolInfo\u003e;\n\n    /// Get all symbols in the document\n    fn all_symbols(\u0026self) -\u003e Vec\u003cSymbolInfo\u003e;\n\n    /// Get all symbols visible in a given scope\n    fn visible_symbols(\u0026self) -\u003e Vec\u003cSymbolInfo\u003e {\n        self.all_symbols()\n    }\n}\n\n/// Language-agnostic symbol information\n///\n/// Represents a symbol (variable, function, class, etc.) without\n/// depending on typedlua-core types.\n#[derive(Debug, Clone)]\npub struct SymbolInfo {\n    /// Symbol name\n    pub name: String,\n\n    /// Symbol kind (variable, function, etc.)\n    pub kind: SymbolKind,\n\n    /// Type annotation if available\n    pub type_annotation: Option\u003cString\u003e,\n\n    /// Source location span\n    pub span: Span,\n\n    /// Whether this symbol is exported from the module\n    pub is_exported: bool,\n\n    /// References to this symbol\n    pub references: Vec\u003cSpan\u003e,\n}\n\n/// Symbol kinds\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum SymbolKind {\n    Variable,\n    Const,\n    Function,\n    Class,\n    Interface,\n    Type,\n    Enum,\n    Property,\n    Method,\n    Parameter,\n    Namespace,\n}\n\n/// Source code location span\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub struct Span {\n    /// Starting byte offset\n    pub start: usize,\n\n    /// Ending byte offset\n    pub end: usize,\n\n    /// Starting line (zero-indexed)\n    pub line: usize,\n\n    /// Starting column (zero-indexed)\n    pub column: usize,\n}\n\nimpl Span {\n    /// Create a new span\n    pub fn new(start: usize, end: usize, line: usize, column: usize) -\u003e Self {\n        Self {\n            start,\n            end,\n            line,\n            column,\n        }\n    }\n\n    /// Get the length of this span\n    pub fn len(\u0026self) -\u003e usize {\n        self.end.saturating_sub(self.start)\n    }\n\n    /// Check if this span is empty\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.len() == 0\n    }\n}\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":7}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, ''),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '';
    }
  });
})();
</script>
</body>
</html>